<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs title="Freshdesk"
	description="Your Social Help Desk."
	height="20"
	author="Navaneeth"
	author_email="navaneeth@freshdesk.com"
	author_location="Chennai, IN">
    <Require feature="opensocial-0.9" />
    <!-- Declare feature dependencies. -->

    <!-- This one is not specific to Gmail contextual gadgets. -->
    <Require feature="dynamic-height"/>

    <!-- The next feature, Caja, is optional, and is supported for
     use only within test domains. Uncomment the tag only for
     non-production gadgets. -->
    <!-- <Require feature="caja"/> -->

    <!-- The next feature, google.contentmatch, is required for all
     Gmail contextual gadgets.
     <Param> - specify one or more comma-separated extractor IDs in
     a param named "extractors". This line is overridden by the extractor ID
     in the manifest, but is still expected to be present. -->
    <Require feature="google.contentmatch">
      <Param name="extractors">
        google.com:HelloWorld
      </Param>
    </Require>
    <Require feature="setprefs"/> 
  </ModulePrefs>

  <UserPref name="maxmin" default_value="true" datatype="bool" display_name="By default the gadget is in minimized state" />

  <!-- Define the content type and display location. The settings
   "html" and "card" are required for all Gmail contextual gadgets. -->
  <Content type="html" view="card">
    <![CDATA[
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/common.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/pages.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/module.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/sprites.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/app/app-common.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/app/app-bootstrap.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/plugins.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/app/ie.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/page/tkt_details/tkt_details.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/page/tkt_details/tkt_details_sprites.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/page/gadget.css?20130323">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/plugins/redactor.css?20130322">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/plugins/zpluginhack.css?20130322">
	
	<script type='text/javascript' src='https://asset.freshdesk.com/javascripts/frameworks/jquery.js?20130322'></script>
    <script src="https://asset.freshdesk.com/javascripts/redactor/redactor.js?20130322" type="text/javascript"></script>
    <script src="https://asset.freshdesk.com/javascripts/redactor/freshdesk_redactor.js?20130322" type="text/javascript"></script>
	<link type="text/css" rel="stylesheet" media="screen, projection" href="asset.freshdesk.com/stylesheets/plugins/redactor.css?20130322">
	<link type="text/css" rel="stylesheet" media="screen, projection" href="https://asset.freshdesk.com/stylesheets/plugins/zpluginhack.css?20130322">
	<script src="https://asset.freshdesk.com/javascripts/prototype.js" type="text/javascript"></script>
	<script src="https://asset.freshdesk.com/javascripts/lib/nestedtree.js" type="text/javascript"></script>
    <script src="https://asset.freshdesk.com/javascripts/frameworks/plugins/jquery.nested_select_tag.js" type="text/javascript"></script>

    <style type="text/css">
		html {
			overflow-y: hidden;
		}
		body {
			min-width: 300px;
		}
	</style>

	<div id="maxmin" class="minimize hide" title="Minimize the Gadget">&nbsp;</div>
	<div id="maxmin_tip" class="hide">Click here to maximize the gadget</div>
	<div id="fullbody" class="hide">
		<ul class="tabs" id="gcgTabs">
			<li id="contact" class="active" onclick="showContact()"><a href="#">Contact</a></li>
			<li id="recent_tickets"><a href="#" onclick="showRecentTickets()">Recent Tickets</a></li>
			<li id="ticket"><a href="#" onclick="showTicket()">Ticket</a></li>
		</ul>
		<div id="content_div"></div>
		<div id="output"></div>
	</div>
	<div id="auth" class="hide">
		<div class="center">You have not yet linked this Gmail account with an agent in Freshdesk.</div><br/>
		<a class="special uiButton" href="javascript:void(0);">Connect your Freshdesk</a>
	</div>
	<div id="error"></div>

	<script type="text/javascript">
		alert(" Dev Version - v0.00555 ");

		if (typeof console === "undefined" || typeof console.log === "undefined") {
			console = { };
			console.log = function() { };
		}

		function updateCookie(cookieId, value, expireDays){
			var expireString="";
			if(expireDate!==undefined){
				var expireDate=new Date();
				expireDate.setTime((24*60*60*1000*parseFloat(expireDays)) + expireDate.getTime());
				expireString="; expires="+expireDate.toGMTString();
			}
			return(document.cookie=escape(cookieId)+"="+escape(value||"") + expireString + "; path=/");
		}

		function getCookie(cookieId){
			var cookie=document.cookie.match(new RegExp("(^|;)\\s*"+escape(cookieId)+"=([^;\\s]*)"));
			return(cookie?unescape(cookie[2]):null);
		};

		function deleteCookie(cookieId){
			var cookie = Cookie.retrieve(cookieId)||true;
			updateCookie(cookieId, "", -1);
			return cookie;
		};


		// <!-- Fetch the array of content matches. -->
		matches = google.contentmatch.getContentMatches();
		var from_email=""; to_email=""; subject=""; body=""; us_phone=""; ticket_id=""; t=""; var cnt=Math.floor((Math.random()*1000)*(Math.random()*100));
		var domain = "";
		var url_root="61.12.112.70"; 
		var http_s="https";
		var init_done = false;
		var current_tab = 'contact';

		var prefs = new _IG_Prefs();

		// <!-- Iterate through the array and display output for each match. -->
		for (var match in matches) {
			for (var key in matches[match]) {
				if (key == "subject") {
					subject = matches[match][key];
					ticket_id_matches = subject.match("\\[#(\\d*)\]");
					if(ticket_id_matches != null)
						ticket_id = ticket_id_matches[1];
				} else if(key == "recipient_email") {
					to_email = matches[match][key];
				} else if(key == "sender_email") {
					from_email = matches[match][key];
				} else if(key == "email_body") {
					body = matches[match][key];
				} else if(key == "phone_number") {
					us_phone = matches[match][key];
				}
			}
		}

		function minimize() {
			jQuery('body').addClass('minimized');
			jQuery('#maxmin').removeClass('minimize').addClass('maximize').removeClass('hide');
			jQuery('#maxmin_tip').removeClass('hide');
			prefs.set("maxmin",false);

			jQuery('#maxmin').attr('title','Maximize the Gadget');

			console.log('Setting to false');
			updateCookie('minimized', 'yes', 365);
			
			gadgets.window.adjustHeight(20);
		}

		function maximize() {
			jQuery('body').removeClass('minimized');
			jQuery('#maxmin').addClass('minimize').removeClass('maximize').removeClass('hide');
			jQuery('#maxmin_tip').addClass('hide');
			prefs.set("maxmin",true);
			updateCookie('minimized', 'no', 365);
			jQuery('#maxmin').attr('title','Minimize the Gadget');

			autoHeight();
		}

		function gadgetInit() {
			var minmax = prefs.getBool("maxmin");
			console.log('Gadget Initialize');
			console.log(minmax);
			console.log('Above is minmax value in userpref');
			if ( (getCookie('minimized') === 'no') || (getCookie('minimized') === null) &&  minmax == true) {
				//Maximized State
				init();
			} else {
				maximize();
			}
		}

		function isMinimized() {
			return jQuery('body').hasClass('minimized')
		}

		function showTicket() {
			activateTab("ticket");
			var params = {};
			if (ticket_id == null || ticket_id == '') {
				showNewTicketForm();
			} else {
				var url = http_s+"://"+url_root+"/helpdesk/tickets/"+ticket_id+"/view_ticket.widget?k="+t;
				openSocialRequest(url, handleResponse, params);
			}
		};

		function showNewTicketForm() {
			activateTab("ticket");
			var params = {};
			var url = http_s+"://"+url_root+"/helpdesk/tickets/new.widget?k="+t;
			openSocialRequest(url, handleResponse, params);
		};

		function showContact() {
			activateTab("contact");
			var params = {};
			var url = http_s+"://"+url_root+"/contacts/contact_email.widget?email="+from_email+"&k="+t;
			openSocialRequest(url, handleResponse, params);
		};

		function showNewContactForm() {
			activateTab("contact");
			var params = {};
			var url = http_s+"://"+url_root+"/contacts/new.widget?k="+t;
			openSocialRequest(url, handleResponse, params);
		};

		function showRecentTickets() {
			activateTab("recent_tickets");
			var params = {};
			var url = http_s+"://"+url_root+"/helpdesk/tickets/user_tickets.widget?email="+from_email+"&k="+t
			openSocialRequest(url, handleResponse, params);
		};

		function handleResponse(obj) {
			//obj.text contains the text of the page that was requested
			res_text = obj.text
			if(res_text == null || res_text == '') res_text = "Completed the request."
			document.getElementById('content_div').innerHTML = res_text;
			// Stop the progress bar
			populateFields();
			hideLoading();
			postProcess();
			autoHeight();
			jQuery("li.nested_field script").each(function() { 
				jQuery(this).appendTo(document.body);
			});
		};

		function populateFields() {
			new_user_form = jQuery("#new_user");
			if(new_user_form != null) {
				email_field = jQuery("#email_primary")
				if(email_field != null) email_field.val(from_email);
				phone_field = jQuery("#phone_work")
				if(phone_field != null) phone_field.val(us_phone);
			}
			new_ticket_form = jQuery("#NewTicket");
			if(new_ticket_form  != null) {
				tic_email_field = jQuery("#helpdesk_ticket_email")
				if(tic_email_field != null) tic_email_field.val(from_email);
				subject_field = jQuery("#helpdesk_ticket_subject")
				if(subject_field != null) subject_field.val(subject);
				body_field = jQuery("#helpdesk_ticket_ticket_body_attributes_description_html")
				//if(body_field != null) body_field.val(body);

				body_field.redactor({ 
					focus: true,
					convertDivs: false,  
					autoresize:false, 
					tabindex: 2,
					buttons:['bold','italic','underline','|',
									 'unorderedlist', 'orderedlist',  '|',
									 'fontcolor', 'backcolor', '|' ,'link']
				});
			}
		}

		function init() {

			minimize();
			// Retrieve the domain of the current user. gadgets.util.getUrlParameters()['parent'] returns a value
			// of of the form: http(s)://mail.google.com/mail/domain.com/html for Gmail (other containers are similar).
			
			domain = gadgets.util.getUrlParameters()['parent'].match(/.+\/a\/(.+)\/html/)[1];
			// Hit the server, passing in a signed request (and OpenSocial ID), to see if we know who the user is.
			var params = {};
			params[gadgets.io.RequestParameters.AUTHORIZATION] = gadgets.io.AuthorizationType.SIGNED;
			
			var url = http_s+"://"+url_root+"/opensocial/google?domain="+domain;
			
			init_done = true;	//Flag set for Minimize/Maximize

			openSocialRequest(url, initResponse, params);
		};

		function handleInitSuccessResponse(content) {
			t = content.t;
			url_root = content.url_root;
			ssl_enabled = content.ssl_enabled;
			if (!ssl_enabled) http_s = "http";
			if (current_tab == 'recent_tickets') {
				showRecentTickets();
			} else if (current_tab == 'ticket') {
				showTicket();
			} else {
				showContact();
			}
			jQuery('#auth').addClass('hide');;
		};

		function initResponse(response) {
			content = eval('(' + response.data + ')')
			hideLoading();
			if (content.user_exists == "true") {
				handleInitSuccessResponse(content);
			} else if (content.user_exists == undefined) {
				if (content.reason) {
					showError(content.reason);
				} else {
					showError("Unknown Error. Please try again.");
				}
			} else if (content.user_exists == "false") { // User doesn't exist, need to do OpenID to match user ID to OpenID.
				showAuth(content.t);
				t = content.t;
			}
		}

		function activateTab(tabid) {
			current_tab = tabid;
			maximize();
			if (!init_done) {
				init();
			}
			jQuery("#contact").removeClass("active")
			jQuery("#recent_tickets").removeClass("active")
			jQuery("#ticket").removeClass("active")
			jQuery("#"+tabid).addClass("active")
		}

		function openPopup(url) {
			var popup = window.open(url, 'OpenID','height=400,width=600');
			if(popup == null) {
				alert("Popups might be blocked in your browser. Please enable it and click again.");
			} else {
				// Check every 100 ms if the popup is closed.
				finishedInterval = setInterval(function() {
					// If the popup is closed, we've either finished OpenID, or the user closed it. Verify with the server in case the
					// user closed the popup.
					if (popup != null && popup.closed) {
						var params = {};
						jQuery('#auth').addClass('hide');;
						params[gadgets.io.RequestParameters.AUTHORIZATION] = gadgets.io.AuthorizationType.SIGNED;
						var url = http_s+"://"+url_root+"/opensocial/google?domain="+domain;
						openSocialRequest(url, openIdUserCreateResponse, params);
						clearInterval(finishedInterval);
					}
				}, 100);
			}
		}

		function openIdUserCreateResponse(response) {
			content = eval('(' + response.data + ')')
			if (content.user_exists == "true") {
				handleInitSuccessResponse(content);
			} else { // User doesn't exist, need to do OpenID to match user ID to OpenID.
				showUnsuccessfulAuth();
			}
		}

		function openSocialRequest(url, handleResponse, params) {
			// Start the progress bar
			showLoading();
			// alert("openSocialRequest url "+url);
			gadgets.io.makeRequest(url+"&"+cnt, handleResponse, params);
			cnt = cnt + 1
		}

		// This method will be used by the widgets (New ticket, New contact forms) added.
		function makeRequest(url, handleResponse, params, form_data) {
			// Start the progress bar
			showLoading();
			// alert("openSocialRequest url "+http_s+"://"+url_root+url);
			if (form_data != null) {
				params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
				params[gadgets.io.RequestParameters.POST_DATA] = gadgets.io.encodeValues(form_data);
			}
			gadgets.io.makeRequest(http_s+"://"+url_root+url+"?k="+t, handleResponse, params);
		}

		function showAuth(t) {

			var url = http_s+"://"+url_root+"/openid/google?domain=" + domain+"&t="+t;

			var button = jQuery('#auth a');
			button.click(function() {openPopup(url)});

			hideLoading();
			jQuery('#fullbody').addClass('hide');
			jQuery('#auth').removeClass('hide');

			gadgets.window.adjustHeight(120);
		}

		function showUnsuccessfulAuth() {
			jQuery('#gcgLoading').remove();
			jQuery('#auth').removeClass('hide');
		}

		function showError(err_msg) {
			jQuery('#gcgLoading').remove();
//			jQuery('#error').removeClass('hide');
			document.getElementById('error').innerHTML = err_msg
		}

		function showLoading() {
			jQuery('#gcgLoading').remove();
			console.log('Loading Code');
			jQuery("#fullbody").addClass('hide');;
			var loading_div = jQuery('<div></div>')
					.attr('id',"gcgLoading")
					.attr('style','text-align:center; padding: 20px;')
					.html( '<img src="https://asset.freshdesk.com/images/animated/ajax-loader.gif" />' );
			
			jQuery('body').prepend(loading_div);
			autoHeight();
		}

		function hideLoading() {
			jQuery("#fullbody").removeClass('hide');
			jQuery('#gcgLoading').remove();
		}

		function autoHeight() {
			if (jQuery('#fullbody').hasClass('hide')) {
				gadgets.window.adjustHeight(jQuery('#auth').height() + 40);
			} else {
				gadgets.window.adjustHeight(jQuery('#fullbody').height());
			}
		}

		function imgerror(source){
			source.src = http_s+"://"+url_root+"/images/misc/profile_blank_thumb.gif";
			source.onerror = "";
			return true;
		}

		function postProcess() {
			jQuery('.request-conversation').removeClass('hide');
			// For tickets view, showing 

			jQuery('#ui-widget-container a:not(.redactor_box a)').each( function (i, item) {
				if (!$(this).hasClass('post_processed')) {
					var current_url = $(this).attr('href');
					if (current_url) {
						current_url = current_url.replace(/(&k=)\w*/g,"");
						current_url = current_url.replace("user_tickets.widget","");
						if(current_url.indexOf('/') == 0)
						{
							$(this).attr('href',http_s+"://"+url_root+current_url);
						}
					}

					console.log(current_url);
					$(this).attr('target','__new');
					$(this).addClass('post_processed')
				}
			} );
		}

		gadgets.util.registerOnLoadHandler(gadgetInit);

		function toggleState() {
			if (isMinimized() ) {
				maximize();

				if (!init_done) {
					init();
				} 
			} else {
				minimize();
			}
		}

		jQuery(document).ready(function() {

			jQuery('body').attr('id','gcgadget');
			jQuery('html').attr('style','overflow:hidden');
			
			jQuery("#maxmin").live('click',toggleState);
			jQuery("#maxmin_tip").live('click',toggleState);		
		});

      </script>
   ]]>
  </Content>
</Module>

