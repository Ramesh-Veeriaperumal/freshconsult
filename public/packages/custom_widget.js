var Freshdesk={};jsLoadPath=document.getElementsByTagName("script");timeStamp=jsLoadPath[jsLoadPath.length-1].src.split("?")[1];Freshdesk.Widget=Class.create();Freshdesk.Widget.prototype={initialize:function(a){this.options=a||{};this.app_name=this.options.app_name||this.app_name||"Integrated Application";if(!this.options.widget_name){this.options.widget_name=this.app_name.toLowerCase().replace(" ","_")+"_widget"}if(!this.options.username){this.options.username=Cookie.retrieve(this.options.widget_name+"_username")}if(!this.options.password){this.options.password=Cookie.retrieve(this.options.widget_name+"_password")||"x"}this.callbacks_awaiting_access_token=[];this.content_element=$$("#"+this.options.widget_name+" .content")[0];this.error_element=$$("#"+this.options.widget_name+" .error")[0];this.title_element=$$("#"+this.options.widget_name+" #title")[0];if(this.options.title){this.title_element.innerHTML=this.options.title}this.display();this.call_init_requests()},getUsername:function(){return this.options.username},login:function(a){this.options.username=a.username.value;this.options.password=a.password.value;if(this.options.username.blank()&&this.options.password.blank()){this.alert_failure("Please provide Username and password.")}else{if(a.remember_me.value=="true"){Cookie.update(this.options.widget_name+"_username",this.options.username);Cookie.update(this.options.widget_name+"_password",this.options.password)}this.display();this.call_init_requests()}},logout:function(){Cookie.remove(this.options.widget_name+"_username");this.options.username=null;Cookie.remove(this.options.widget_name+"_password");this.options.password=null;this.display()},display_login:function(){if(this.options.login_html!=null){this.content_element.innerHTML=(typeof this.options.login_html=="function")?this.options.login_html():this.options.login_html}},display:function(b){b=b||this.content_element;var a=this;if(this.options.login_html!=null&&!(this.options.username&&this.options.password)){a.display_login()}else{if(this.options.application_html){b.innerHTML=(typeof this.options.application_html=="function")?this.options.application_html():this.options.application_html}}},call_init_requests:function(){if(this.options.init_requests){var a=this;this.options.init_requests.each(function(b){if(b){a.request(b)}})}},request:function(a){var e=a;if(typeof a=="string"){a=this.options.requests[e]}a.domain=this.options.domain;a.ssl_enabled=this.options.ssl_enabled;a.accept_type=a.accept_type||a.content_type;a.method=a.method||"get";reqHeader=a.reqHeader||{};if(this.options.use_server_password){a.username=this.options.username;a.use_server_password=this.options.use_server_password;a.app_name=this.options.app_name.toLowerCase().replace(" ","_")}else{if(this.options.auth_type=="OAuth"){if(this.options.url_token_key){if(a.resource==null){a.resource=a.rest_url}merge_sym=(a.resource.indexOf("?")==-1)?"?":"&";a.rest_url=a.resource+merge_sym+this.options.url_token_key+"="+this.options.oauth_token}else{reqHeader.Authorization="OAuth "+this.options.oauth_token}}else{if(this.options.auth_type=="NoAuth"){}else{if(this.options.auth_type=="UAuth"){if(a.resource==null){a.resource=a.rest_url}merge_sym=(a.resource.indexOf("?")==-1)?"?":"&";a.rest_url=a.resource+merge_sym+this.options.url_token_key+"="+this.options.username}else{reqHeader.Authorization="Basic "+Base64.encode(this.options.username+":"+this.options.password)}}}}url=a.source_url?a.source_url:"/http_request_proxy/fetch";var d=jQuery.extend(false,{},a.custom_callbacks);a.custom_callbacks=null;var c=jQuery.extend(false,{},reqHeader);var b=null;new Ajax.Request(url,b=jQuery.extend(false,{asynchronous:true,parameters:a,requestHeaders:reqHeader,onSuccess:function(f){this.resource_success(f,e,a)}.bind(this),onFailure:function(f){this.resource_failure(f,a,c)}.bind(this)},d))},resource_success:function(a,c,b){if(b!=null&&b.on_success!=null){b.on_success(a)}else{if(this.options.parsers!=null&&this.options.parsers[c]!=null){resJ=this.options.parsers[c](a)}if(this.options.templates!=null&&this.options.templates[c]!=null){this.options.application_html=_.template(this.options.templates[c],resJ);this.options.display()}}},resource_failure:function(a,e,b){resJ=a.responseJSON;var d=false;if(a.status==401){this.options.username=null;this.options.password=null;Cookie.remove(this.options.widget_name+"_username");Cookie.remove(this.options.widget_name+"_password");if(typeof e.on_failure!="undefined"&&e.on_failure!=null){e.on_failure(a)}else{if(this.options.auth_type=="OAuth"){cw=this;d=true;this.refresh_access_token(function(){if(this.options.oauth_token){this.request(e)}else{this.alert_failure("Problem in connecting to "+this.app_name+". Please try again later.");e.after_failure(a)}}.bind(this),b)}else{this.alert_failure("Given user credentials for "+this.app_name+" are incorrect. Please verify your integration settings and try again.")}}}else{if(a.status==403){err_msg=(resJ)?((resJ[0].message)?resJ[0].message:a.statusText):"Request forbidden.";this.alert_failure(this.app_name+" declined the request. \n\n "+this.app_name+" returns the following error : "+err_msg)}else{if(a.status==502){this.alert_failure(this.app_name+" is not responding.  Please verify the given domain or try again later.")}else{if(a.status==504){this.alert_failure("Request timed out. Please try again later.")}else{if(a.status==500){if(this.app_name=="Harvest"){var c=XmlUtil.extractEntities(a.responseXML,"error");if(c.length>0){err_msg=XmlUtil.getNodeValueStr(c[0],"message");alert(this.app_name+" reports the below error: \n\n"+err_msg+"\n\nTry again after correcting the error or fix the error manually.  If you can not do so, contact support.");return}}this.alert_failure("Unknown server error. Please contact support@freshdesk.com.")}else{if(typeof e.on_failure!="undefined"&&e.on_failure!=null){e.on_failure(a)}else{if(a.status==404){if(this.app_name=="Google Calendar"){}else{this.alert_failure("Could not fetch data from "+(this.options.domain||this.domain)+"\n\nPlease verify your integration settings and try again.")}}else{errorStr=a.responseText;this.alert_failure(this.app_name+" reports the below error: \n\n"+errorStr+".\n\nTry fixing the error or Contact Support.")}}}}}}}if(!d){loading_elem=jQuery('div[class^="loading-"]').attr("class");if(loading_elem){loading_class_elems=loading_elem.split();for(i=0;i<loading_class_elems.length;i++){if(loading_class_elems[i].startsWith("loading-")){jQuery('div[class^="loading-"]').removeClass(loading_class_elems[i])}}}if(e.after_failure){e.after_failure(a)}}},alert_failure:function(a){if(this.error_element==null||this.error_element==""){alert(a)}else{jQuery(this.error_element).removeClass("hide").parent().removeClass("loading-fb");this.error_element.innerHTML=a}jQuery("#"+this.options.widget_name).removeClass("loading-fb")},refresh_access_token:function(b,a){cw=this;if(typeof a!="undefined"&&a.Authorization){a=a.Authorization.split(" ");if(a[1]!=this.options.oauth_token&&!this.awaiting_access_token){if(b){b()}return}}this.options.oauth_token=null;this.callbacks_awaiting_access_token.push(b);if(this.awaiting_access_token){return}this.awaiting_access_token=true;new Ajax.Request("/integrations/refresh_access_token/"+this.options.app_name.toLowerCase().replace(" ","_"),{asynchronous:true,method:"get",onSuccess:function(c){resJ=c.responseJSON;this.options.oauth_token=resJ.access_token;this.awaiting_access_token=false;this.callbacks_awaiting_access_token.each(function(d){if(d){d()}});this.callbacks_awaiting_access_token=[]}.bind(this),onFailure:function(c){this.options.oauth_token=null;this.awaiting_access_token=false;this.callbacks_awaiting_access_token.each(function(d){if(d){d()}});this.callbacks_awaiting_access_token=[]}.bind(this)})},create_integrated_resource:function(a){if(this.remote_integratable_id&&this.local_integratable_id){reqData={application_id:this.options.application_id,"integrated_resource[remote_integratable_id]":this.remote_integratable_id,"integrated_resource[local_integratable_id]":this.local_integratable_id,"integrated_resource[local_integratable_type]":this.options.integratable_type};new Ajax.Request("/integrations/integrated_resources/create",{asynchronous:true,method:"post",parameters:reqData,onSuccess:function(b){this.remote_integratable_id=null;this.local_integratable_id=null;if(a){a(b)}},onFailure:function(b){if(a){a(b)}}})}},update_integrated_resource:function(c,b,d,a){if(c!=null&&c!=""){reqData={"integrated_resource[id]":c};if(b){reqData["integrated_resource[local_integratable_id]"]=b}if(d){reqData["integrated_resource[remote_integratable_id]"]=d}new Ajax.Request("/integrations/integrated_resources/update",{asynchronous:true,method:"put",parameters:reqData,onSuccess:function(e){if(a){a(e)}},onFailure:function(e){if(a){a(e)}}})}},delete_integrated_resource:function(b,a){if(b!=null&&b!=""){reqData={"integrated_resource[id]":b};new Ajax.Request("/integrations/integrated_resources/delete",{asynchronous:true,method:"delete",parameters:reqData,onSuccess:function(c){if(a){a(c)}},onFailure:function(c){if(a){a(c)}}})}},prettyDate:function(b){var c=new Date(b),d=(((new Date()).getTime()-c.getTime())/1000),a=Math.floor(d/86400);if(isNaN(a)||a<0||a>0){return c.getDate()+" "+c.toDateString().split(" ")[1]}return a==0&&(d<60&&"just now"||d<120&&"a minute ago"||d<3600&&Math.floor(d/60)+" minutes ago"||d<7200&&"1 hour ago"||d<86400&&Math.floor(d/3600)+" hours ago")||a==1&&"Yesterday"||a<7&&a+" days ago"||a<31&&Math.ceil(a/7)+" weeks ago"}};Freshdesk.EmailMarketingWidget=Class.create(Freshdesk.Widget,{initialize:function($super,b,a){if(b.reqEmail==""){this.alert_failure("Email not available for this requester. Please make sure a valid Email is set for this requester.")}else{cw=this;this.app=b.app_name.toLowerCase();b.parsers={getUserInfo:this.handleUser.bind(this),getCampaigns:this.handleCampaigns.bind(this),getAllLists:this.handleLists.bind(this),getSubscribedLists:this.handleSubscribedLists.bind(this)};b=this.updateRequests(b);b.integratable_impl=a;$super(b);this.renderPrimary();this.mc_subscribe_lists=[];this.mc_unsubscribe_lists=[];cw.title=[]}},renderPrimary:function(){jQuery("#"+this.app+"_widget").addClass("loading-center");if(this.app=="icontact"||this.app=="constantcontact"){this.getUserInfo()}else{if(this.app=="mailchimp"||this.app=="campaignmonitor"){this.getCampaignsForEmail()}}this.bindClicks()},bindClicks:function(){var a=this;jQuery("#"+this.options.widget_name).on("click",".lists-submit",(function(b){b.preventDefault();a.manageLists()}));jQuery("#"+this.options.widget_name).on("click",".contact-submit",(function(b){b.preventDefault();a.addUser()}));jQuery("#"+this.options.widget_name).on("click",".newlists-submit",(function(b){b.preventDefault();a.newSubscribe()}));jQuery("#"+this.app+"_widget").on("click",".list-tab",(function(b){b.preventDefault();a.mailingLists()}));jQuery("#"+this.app+"_widget").on("click",".campaign-tab",(function(b){b.preventDefault();a.campaignActivity()}))},updateRequests:function(a){for(key in a.requests){a.requests[key].on_failure=this.handleFailure.bind(this)}return a},getUserInfo:function(){this.request("getUserInfo")},getCampaigns:function(a){this.options.requests.getCampaigns.rest_url=this.options.requests.getCampaigns.rest_url.interpolate({contactId:a});this.request("getCampaigns")},getCampaignsForEmail:function(){campaignEmail_req=this.options.integratable_impl.getCampaignsForEmail();if(campaignEmail_req){this.request(campaignEmail_req)}},getAllLists:function(){this.request("getAllLists")},getSubscribedLists:function(){if(this.options.requestForListSub==true){sublists_req=this.options.integratable_impl.getSubscribedLists();if(sublists_req){sublists_req.on_success=this.handleSubscribedLists.bind(this);sublists_req.on_failure=this.handleFailure.bind(this);this.request(sublists_req)}}else{this.options.requestForListSub=false;this.lists=this.options.integratable_impl.getSubscribedLists();this.handleSubscribedLists()}},addUser:function(){jQuery("#"+this.options.widget_name+" .lists-load").siblings().hide();jQuery("#"+this.options.widget_name+" .lists-load").prepend("<hr/>").slideDown("slow");if(this.app=="icontact"){this.options.integratable_impl.addContact()}else{this.getAllLists();this.exportFlag=true}},exportUser:function(){var b=this;var a={};this.renderTemplate(_.template(this.Export,{name:this.options.reqName,email:this.options.reqEmail,appname:this.options.app_name}));jQuery("#"+this.options.widget_name).removeClass("loading-center");this.renderUser(a)},newSubscribe:function(){var b=[];this.mc_subscribe_lists=[];this.mc_unsubscribe_lists=[];if(jQuery("#"+this.options.widget_name+" .lists input:checked").length==0){this.processFailure("Please select a mailing list to proceed")}else{jQuery(this.error_element).addClass("hide");var a=this;jQuery("#"+this.options.widget_name+" .lists input:checked").each(function(){if(a.mc_subscribe_lists.indexOf($(this).id)<0){b.push($(this).id)}});this.exportFlag=false;jQuery("#"+this.options.widget_name+" .lists-load").hide();jQuery("#"+this.options.widget_name).addClass("loading-center");if(this.app=="campaignmonitor"||this.app=="mailchimp"){this.addContact(b)}else{this.options.integratable_impl.addContact(b)}}},addContact:function(a){requestBody={EmailAddress:this.options.reqEmail};dfd_arr=[];for(i=0;i<a.length;i++){dfd_arr.push(this.contactRequest(a[i]))}jQuery.when.apply(null,dfd_arr).then(this.handleAddContact.bind(this))},contactRequest:function(b){var a=jQuery.Deferred();this.contactReqFailure=[];subReq=this.options.integratable_impl.contactRequest(b);if(subReq){subReq.on_success=function(c){if(c.responseJSON.error){this.contactReqFailure.push(c.responseJSON.error)}a.resolve()}.bind(this);subReq.on_failure=function(c){if(c.responseJSON.error){this.contactReqFailure.push(c.responseJSON.error)}else{this.contactReqFailure.push(c.responseText)}a.resolve()}.bind(this);this.request(subReq)}return a.promise()},handleAddContact:function(){if(this.contactReqFailure.length>0){this.processFailure("Unable to add the contact to "+this.options.app_name);this.exportUser()}else{this.getCampaignsForEmail()}},handleUser:function(a){contact=this.options.integratable_impl.handleUser(a);this.renderUser(contact);this.getCampaigns(contact.id)},handleCampaigns:function(a){var b=this.options.integratable_impl.handleCampaigns(a);var d=b.campaigns;var c=b.activities;this.renderCampaigns(c,d)},handleEmptyCampaigns:function(){this.campaignTmpl=_.template(this.EmptyData,{type:"campaign history",contact:this.options.reqName});this.renderModal();if(this.updateSubscriptionNotifier==true){this.listsTmpl=null;this.mailingLists()}},handleEmptyLists:function(){this.listsTmpl=_.template(this.EmptyData,{type:"mailing lists",contact:"the linked "+this.options.app_name+" account"});jQuery("#"+this.options.widget_name+" .emailLists").html(this.listsTmpl)},handleSubscribedLists:function(a){var c=this;this.mc_subscribe_lists=[];this.mc_unsubscribe_lists=[];if(this.options.requestForListSub==false){lists=this.lists}else{lists=this.options.integratable_impl.handleSubscribedLists(a)}for(var b=0;b<lists.length;b++){jQuery("#"+lists[b]).attr("checked",true);this.mc_subscribe_lists.push(lists[b])}jQuery("#"+this.options.widget_name+" .lists input:unchecked").each(function(){c.mc_unsubscribe_lists.push($(this).id)});this.listsTmpl=jQuery("#"+this.options.widget_name+" .lists-load")[0];jQuery("#"+this.options.widget_name+" .lists-load").removeClass("hide");jQuery("#"+this.options.widget_name+" .emailLists").removeClass("loading-center")},handleLists:function(b){var c="";var d=this;var a=this.options.integratable_impl.handleLists(b);if(a.length>0){for(i=0;i<a.length;i++){c+=_.template(this.UserLists,{listId:a[i].listId,listTitle:a[i].name})}if(this.exportFlag){this.renderTemplate(_.template(this.NewLists,{lists:c}),jQuery("#"+this.options.widget_name+" .lists-load")[0]);jQuery("#"+this.options.widget_name+" .lists-load").removeClass("loading-center").prepend("<hr/>")}else{this.renderTemplate(_.template(this.MailingLists,{lists:c}),jQuery("#"+this.options.widget_name+" .emailLists")[0]);this.getSubscribedLists()}}else{this.handleEmptyLists()}},bindShowActivity:function(b){var a=this;jQuery("#show-activity-"+this.app).die();jQuery("#show-activity-"+this.app).live("click",function(c){c.preventDefault();cid=jQuery(this).attr("class").split(" ")[1];if(jQuery("#user-campaign-"+cid).is(":visible")==false){jQuery("#user-campaign-"+cid).slideDown();if(a.app=="mailchimp"){a.options.integratable_impl.getCampaignActivity((jQuery(this).attr("class")).split(" ")[1])}else{if(_.keys(b[cid]).length==0){b[cid]=[{type:"",time:"No campaign activity found for this campaign"}]}a.getCampaignActivity((jQuery(this).attr("class")).split(" ")[1],b)}jQuery("#user-campaign-"+cid).removeClass("hide");jQuery("."+cid).children().css("background-color","#DDD")}else{jQuery("#user-campaign-"+cid).slideUp();jQuery("."+cid).children().css("background-color","")}})},formatDate:function(a){send_time=a.replace(/[T|Z]/g," ").split(/\s/);activity_time=(send_time[0].replace(/\-/g,"/")+" "+send_time[1]);return new Date(activity_time).strftime("%a, %d %b %Y, %r")},getCampaignActivity:function(a,d){var c="",b="";if(this.campaigns[a].send_time){c=_.template(this.CampaignActivity,{action:"Sent",action_time:this.formatDate(this.campaigns[a].send_time),action_url:""})}for(key in d){if(key==a){for(i=0;i<d[key].length;i++){if(this.app!="constantcontact"){if(d[key][i].time&&d[key][i].time!=""){if(d[key][i].type!=""){b=this.formatDate(d[key][i].time)}else{b=d[key][i].time}}}else{b=d[key][i].time}c+=_.template(this.CampaignActivity,{action:d[key][i].type,action_time:b,action_url:d[key][i].link||""})}}}j="#user-campaign-"+a;this.renderTemplate(c,jQuery(j+" .campaign-details")[0]);jQuery(j+" .campaign-details").removeClass("hide");jQuery(j).removeClass("loading-fb")},manageLists:function(){var b=new Array();var c=new Array();var a=this;jQuery("#"+this.options.widget_name+" .lists input:checked").each(function(){if(a.mc_subscribe_lists.indexOf($(this).id)<0){b.push($(this).id)}});jQuery("#"+this.options.widget_name+" .lists input:unchecked").each(function(){if(a.mc_unsubscribe_lists.indexOf($(this).id)<0){c.push($(this).id)}});this.mc_subscribe_lists=[];this.mc_unsubscribe_lists=[];jQuery("#"+this.options.widget_name+" .lists input:checked").each(function(){a.mc_subscribe_lists.push($(this).id)});jQuery("#"+this.options.widget_name+" .lists input:unchecked").each(function(){a.mc_unsubscribe_lists.push($(this).id)});if(b.length==0&&c.length==0){if(jQuery("#"+this.options.widget_name+" .lists input:checked").length>0){this.processFailure("The selected mailing lists are already subscribed. Please select a new mailing list to proceed")}else{this.processFailure("Please select a mailing list to proceed")}}else{if(this.app=="campaignmonitor"||this.app=="mailchimp"){this.updateSubscription(b,c)}else{this.options.integratable_impl.updateSubscription(b,c)}}},updateSubscription:function(a,c){var b=[];this.ErrorMessages=[];for(i=0;i<a.length;i++){b.push(this.subscribeLists(a[i]))}for(i=0;i<c.length;i++){b.push(this.unsubscribeLists(c[i]))}jQuery.when.apply(null,b).then(this.handleUpdateSubscription.bind(this));jQuery("#"+this.options.widget_name+" .lists-load").hide();jQuery("#"+this.options.widget_name+" .emailLists").addClass("loading-center")},handleUpdateSubscription:function(){this.listsTmpl=null;if(this.ErrorMessages.length>0){this.processFailure(this.ErrorMessages[(this.ErrorMessages.length-1)])}this.options.integratable_impl.handleUpdateSubscription()},subscribeLists:function(b){var a=jQuery.Deferred();addSubRequest=this.options.integratable_impl.subscribeLists(b);if(addSubRequest){addSubRequest.on_success=function(c){if(c.responseJSON){if(c.responseJSON.error||c.responseJSON.Message){this.ErrorMessages.push(c.responseJSON.error||c.responseJSON.Message)}}a.resolve()}.bind(this);addSubRequest.on_failure=function(c){if(c.responseJSON){this.ErrorMessages.push(c.responseJSON.error||c.responseJSON.Message)}a.resolve()}.bind(this);this.request(addSubRequest)}return a.promise()},unsubscribeLists:function(b){var a=jQuery.Deferred();addUnSubRequest=this.options.integratable_impl.unsubscribeLists(b);if(addUnSubRequest){addUnSubRequest.on_success=function(c){if(c.responseJSON){if(c.responseJSON.error||c.responseJSON.Message){this.ErrorMessages.push(c.responseJSON.error||c.responseJSON.Message)}}a.resolve()}.bind(this);addUnSubRequest.on_failure=function(c){if(c.responseJSON){this.ErrorMessages.push(c.responseJSON.error||c.responseJSON.Message)}a.resolve()}.bind(this);this.request(addUnSubRequest)}return a.promise()},campaignActivity:function(){var a="#"+this.options.widget_name;jQuery(a+" .emailCampaigns").removeClass("hide");jQuery(a+" .emailLists").addClass("hide");jQuery(a+" .emailCampaigns").html(this.campaignTmpl);jQuery(a+" .list-tab").removeClass("active");jQuery(a+" .campaign-tab").addClass("active")},mailingLists:function(){var a="#"+this.options.widget_name;jQuery(a+" .emailCampaigns").addClass("hide");jQuery(a+" .emailLists").removeClass("hide");jQuery(a+" .list-tab").addClass("active");jQuery(a+" .campaign-tab").removeClass("active");if(this.listsTmpl){jQuery(a+" .emailLists").html(this.listsTmpl);jQuery(a+" .lists-load").show();jQuery(a+" .emailLists").removeClass("loading-center")}else{this.getAllLists()}},renderModal:function(){var a=this;jQuery("#"+this.app+"_widget").removeClass("loading-center");this.renderTemplate(_.template(this.Parent,{campaigns:this.campaignTmpl}))},renderUser:function(a){a=a||{};a.name=this.options.reqName;title=_.template(this.Title,{contact:a,app:this.app});if(jQuery("#"+this.options.widget_name).dialog("isOpen")==true){jQuery("#"+this.options.widget_name).dialog("option","title",title)}cw.title[this.app]=title},renderCampaigns:function(b,a){this.campaigns=a;this.campaignTmpl=_.template(this.Campaigns,{campaigns:a,app:this.app});this.renderModal();this.bindShowActivity(b);if(this.updateSubscriptionNotifier==true){this.listsTmpl=null;this.mailingLists()}},addUserFailure:function(){error=this.options.integratable_impl.addUserFailure(response);if(error==true){errorMessage="Unable to add the contact to "+this.options.app_name;this.processFailure(errorMessage)}else{jQuery("#"+this.options.widget_name).removeClass("loading-center")}},handleFailure:function(a){errorMessage=this.options.integratable_impl.processFailure(a);this.processFailure(errorMessage||"Unknown server error")},processFailure:function(b){var a=this;this.alert_failure(this.options.app_name+" reports the following error : "+b);jQuery(a.error_element).slideDown("slow");jQuery("#"+this.app+"_widget").removeClass("loading-center");setTimeout(function(){jQuery(a.error_element).slideUp("slow")},8000)},renderTemplate:function(b,a){this.options.application_html=b;this.display(a)},Title:'<div class="email_marketing"><div class="contact_title"><div class="<%=app%>-modal-logo"> <h3 class="fname"><%=contact.name%></h3></div><div class="cust-added"><%= (contact.since && contact.since != "") ? ("Customer since " + (new Date(contact.since.replace(/-/g,"/")).strftime("%a, %d %b %Y"))) : "" %></div></div></div>',Parent:'<div class="parent-container"><div class="email_title"></div><div class="parent-tmpl"><div class="modal-tabs"><ul class="tabs parent-tabs"><li class="active campaign-tab"><a href="#">Campaigns</a></li><li class="list-tab"><a href="#">MailingLists</a></li></ul></div><div class="emailCampaigns"><%=campaigns%></div><div class="hide loading-center emailLists"></div></div></div>',Export:'<hr/><div class="export-user"><span><%=name%>&lt;<%=email%>&gt; cannot be found in <%=appname%></span><div class="contact-submit"><input type="submit" class="uiButton contact-add" value="Subscribe" /></div></div><div class="lists-load loading-center hide"></div>',NewLists:'<div class="mailing-msg"><b>Choose from the below mailing lists to add the contact and click Save</b></div><div class="listsExportAll"><input type="submit" class="uiButton newlists-submit"  value="Save"></div><div class="all-lists"><div class="lists threecol-form"><%=lists%></div></div>',Campaigns:'<div class="campaigns"><div class="campaigns-list"><% var keys = [];if(app == "icontact"){keys = _.keys(campaigns).reverse();for(i=0; i<keys.length; i++){ %><div id="show-activity-<%=app%>" class="activity-toggle <%=keys[i]%>"> <div class="campaign-activity campaign-image"><%=campaigns[keys[i]].title%></div></div><div id="user-campaign-<%=keys[i]%>" class="hide loading-fb"><div class="activities"><div class="campaign-details hide"></div></div></div><%}}else{for(key in campaigns){%><div id="show-activity-<%=app%>" class="activity-toggle <%=key%>"> <div class="campaign-activity campaign-image"><%=campaigns[key].title%></div></div><div id="user-campaign-<%=key%>" class="hide loading-fb"><div class="activities"><div class="campaign-details hide"></div></div></div><%}}%></div></div>',CampaignActivity:'<div class="activity"><div class="action_type"> <span class="action"> <%=action%> </span></div><span class="action-time"><%=action_time%></span><span class="action-url"><a href="<%=action_url%>" target="_blank"><%=action_url%></a></span> </div>',MailingLists:'<div class="mailing-lists"><div class="lists-load hide"><div class="mailing-msg"><b>Subscribe/Unsubscribe mailing lists below and click Save </b></div><div class="listsExportAll"><input type="submit" class="uiButton lists-submit"  value="Save"></div><div class="all-lists"><div class="lists threecol-form"><%=lists%></div></div></div></div>',UserLists:'<div class="item"><label><input type="checkbox" id="<%=listId%>"/><div><%=listTitle%></div></label></div>',EmptyData:'<div class="empty-response"><span>No <%=type%> found for <%=contact%></span></div>'});Freshdesk.CRMWidget=Class.create(Freshdesk.Widget,{initialize:function($super,d,b){if(d.domain){if(d.reqEmail==""){$super(d);this.alert_failure("Email not available for this requester. A valid Email is required to fetch the contact from "+this.options.app_name)}else{d.integratable_impl=b;var c=b.get_contact_request();if(c){if(c.length==undefined){c=[c]}for(var a=0;a<c.length;a++){c[a].on_success=this.handleContactSuccess.bind(this);if(d.auth_type!="OAuth"&&b.processFailure){c[a].on_failure=this.handleFailure.bind(this)}}this.contacts=[];d.init_requests=c}$super(d)}}else{$super(d);this.alert_failure("Domain name not configured. Try reinstalling "+this.options.app_name)}},handleFailure:function(a){this.options.integratable_impl.processFailure(a,this)},handleContactSuccess:function(a){resJson=a.responseJSON;if(resJson==null){resJson=JSON.parse(a.responseText)}if(this.contacts=this.contacts.concat(this.options.integratable_impl.parse_contact(resJson,a))){if(this.contacts.length>0){if(this.contacts.length==1){this.renderContactWidget(this.contacts[0]);jQuery("#search-back").hide()}else{this.renderSearchResults()}}else{this.renderContactNa()}}jQuery("#"+this.options.widget_name).removeClass("loading-fb")},renderSearchResults:function(){var c="";for(var b=0;b<this.contacts.length;b++){c+='<a class="multiple-contacts" href="#" data-contact="'+b+'">'+this.contacts[b].name+"</a><br/>"}var a={resLength:this.contacts.length,requester:this.options.reqEmail,resultsData:c};this.renderSearchResultsWidget(a);var d=this;jQuery("#"+this.options.widget_name).on("click",".multiple-contacts",(function(e){e.preventDefault();d.renderContactWidget(d.contacts[jQuery(this).data("contact")])}))},renderContactWidget:function(c){var a=this;c.app_name=this.options.app_name;c.widget_name=this.options.widget_name;c.type=c.type?c.type:"";c.department=c.department?c.department:null;c.url=c.url?c.url:"#";c.address_type_span=c.address_type_span||" ";this.options.application_html=function(){return _.template(a.VIEW_CONTACT,c)};this.display();var b=this;jQuery("#"+this.options.widget_name).on("click","#search-back",(function(d){d.preventDefault();b.renderSearchResults()}))},renderSearchResultsWidget:function(b){var a=this;b.widget_name=this.options.widget_name;this.options.application_html=function(){return _.template(a.CONTACT_SEARCH_RESULTS,b)};this.display()},renderContactNa:function(){var a=this;a.options.url=a.options.url||"#";this.options.application_html=function(){return _.template(a.CONTACT_NA,a.options)};this.display()},VIEW_CONTACT:'<span class="contact-type <%=(type ? "" : "hide")%>"><%=(type || "")%></span><div class="title <%=widget_name%>_bg"><div class="name"><div id="contact-name" class="contact-name"><a title="<%=name%>" target="_blank" href="<%=url%>"><%=name%></a></div><div id="contact-desig"><%=(designation ? designation : ( company ? "Works" : "" ))%><span class="<%=(company ? "dummy" : "hide")%>"> at <a target="_blank" href="<%=(company_url || "#")%>"><%=(company || "")%></a></span></div></div></div><div class="field"><div id="crm-contact"><label>Address</label><span id="contact-address"><%=address%><%=address_type_span%></span></div></div><div class="field"><div  id="crm-phone"><label>Phone</label><span id="contact-phone"><%=phone%></span></div></div><div class="field"><div id="crm-mobile"><label>Mobile</label><span id="contact-mobile"><%=mobile%></span></div></div><div class="field <%=((department)? "" : "hide") %>"><div  id="crm-dept"><label>Dept.</label><span id="contact-dept"><%=(department || "")%></span></div></div><div class="field bottom_div"></div><div class="external_link"><a id="search-back" href="#"> &laquo; Back </a><a target="_blank" id="crm-view" href="<%=url%>">View <span id="crm-contact-type"></span> on <%=app_name%></a></div>',CONTACT_SEARCH_RESULTS:'<div class="title <%=widget_name%>_bg"><div id="number-returned" class="name"> <%=resLength%> results returned for <%=requester%> </div><div id="search-results"><%=resultsData%></div></div>',CONTACT_NA:'<div class="title contact-na <%=widget_name%>_bg"><div class="name"  id="contact-na">Cannot find <%=reqName%> in <%=app_name%></div></div>'});var UIUtil={constructDropDown:function(e,l,g,o,f,m,q,b,a){foundEntity="";dropDownBox=$(g);if(!a){dropDownBox.innerHTML=""}if(l=="xml"){parser=XmlUtil}else{if(l=="hash"){parser=HashUtil}else{parser=JsonUtil}}var n=parser.extractEntities(e,o);for(var c=0;c<n.length;c++){if(q!=null&&q!=""){matched=true;for(var p in q){filterValue=q[p];if(!this.isMatched(n[c],p,filterValue)){matched=false;break}}if(!matched){continue}}var h=new Element("option");entityIdValue=parser.getNodeValueStr(n[c],f);entityEmailValue=parser.getNodeValueStr(n[c],"email");if(b!=null&&b!=""){if(entityEmailValue==b){foundEntity=n[c];h.selected=true}else{if(entityIdValue==b){foundEntity=n[c];h.selected=true}}}dispName="";for(var k=0;k<m.length;k++){if(m[k]==" "||m[k]=="("||m[k]==")"||m[k]=="-"){dispName+=m[k]}else{dispName+=parser.getNodeValueStr(n[c],m[k])}}if(dispName.length<2){dispName=entityEmailValue}if(entityIdValue&&dispName){h.value=entityIdValue;h.innerHTML=dispName;dropDownBox.appendChild(h)}if(foundEntity==""){foundEntity=n[c];h.selected=true}}return foundEntity},isMatched:function(a,c,d){keys=c.split(",");if(keys.length>1){first_level_nodes=parser.extractEntities(a,keys[0]);for(var b=0;b<first_level_nodes.length;b++){actualVal=parser.getNodeValueStr(first_level_nodes[b],keys[1]);if(actualVal==d){return true}}return false}else{actualVal=parser.getNodeValueStr(a,c);return actualVal==d}},addDropdownEntry:function(e,d,c,b){projectDropDownBox=$(e);var a=new Element("option");a.value=d;a.innerHTML=c;if(b){projectDropDownBox.insertBefore(a,projectDropDownBox.childNodes[0])}else{projectDropDownBox.appendChild(a)}},chooseDropdownEntry:function(d,c){projectDropDownBoxOptions=$(d).options;var a=projectDropDownBoxOptions.length;for(var b=0;b<a;b++){if(projectDropDownBoxOptions[b].value==c){projectDropDownBoxOptions[b].selected=true;break}}},sortDropdown:function(a){jQuery("#"+a).html(jQuery("#"+a+" option").sort(function(d,c){d=d.text.toLowerCase();c=c.text.toLowerCase();return d==c?0:d<c?-1:1}))},hideLoading:function(c,e,b){jQuery("#"+c+b+"-"+e).removeClass("hide");jQuery("#"+c+"-"+e+"-spinner").addClass("hide");var d=jQuery("#"+c+b+"-"+e).parentsUntil("form").siblings().andSelf();if(d.find(".loading-fb.hide").length==d.find(".loading-fb").length){var a=d.filter(".uiButton");a.prop("disabled",!a.prop("disabled"))}},showLoading:function(b,c,a){jQuery("#"+b+a+"-"+c).addClass("hide");jQuery("#"+b+"-"+c+"-spinner").removeClass("hide")}};var CustomWidget={include_js:function(a){widget_script=document.createElement("script");widget_script.type="text/javascript";widget_script.src=a+"?"+timeStamp;document.getElementsByTagName("head")[0].appendChild(widget_script)}};CustomWidget.include_js("/javascripts/base64.js");CustomWidget.include_js("/javascripts/frameworks/underscore-min.js");CustomWidget.include_js("/javascripts/strftime-min.js");var XmlUtil={extractEntities:function(a,b){return a.getElementsByTagName(b)||new Array()},getNodeValue:function(a,c){if(a==""){return}if(c instanceof Array){var b=a.getElementsByTagName(c[0]);if(b==null||b.length==0){return null}a=b[0];c=c[1]}var b=a.getElementsByTagName(c);if(b==null||b.length==0){return null}childNode=b[0].childNodes[0];if(childNode==null){return""}return childNode.nodeValue},getNodeValueStr:function(a,b){return this.getNodeValue(a,b)||""},getNodeAttrValue:function(a,d,c){var b=a.getElementsByTagName(d);if(b==null||b.length==0){return null}return b[0].getAttribute(c)||null},loadXMLString:function(a){if(window.DOMParser){parser=new DOMParser();xmlDoc=parser.parseFromString(a,"text/xml")}else{xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async=false;xmlDoc.loadXML(txt)}return xmlDoc}};var JsonUtil={extractEntities:function(b,c){if(b instanceof Array){return b}else{if(b instanceof Object){var a=b[c]||Array();return a}}},getNodeValue:function(a,c){if(a==""){return}var b=a[c];if(b==null||b.length==0){return null}return b},getNodeValueStr:function(a,b){return this.getNodeValue(a,b)||""},getMultiNodeValue:function(g,c){var b;var a;var e=g;var f=c.split(".");if(f.length>1){for(var d=0;d<(f.length-1);d++){b=JsonUtil.extractEntities(e,f[d]);e=b}a=JsonUtil.getNodeValueStr(e,f[f.length-1])}return a}};var HashUtil={extractEntities:function(b,a){return b[a]||new Array()},getNodeValue:function(a,c){if(a==""){return}var b=a[c];if(b==null||b.length==0){return null}return b},getNodeValueStr:function(a,b){return this.getNodeValue(a,b)||""}};var Cookie=Class.create({});Cookie.update=function(c,d,e){var b="";if(a!==undefined){var a=new Date();a.setTime((24*60*60*1000*parseFloat(e))+a.getTime());b="; expires="+a.toGMTString()}return(document.cookie=escape(c)+"="+escape(d||"")+b+"; path=/")};Cookie.retrieve=function(a){var b=document.cookie.match(new RegExp("(^|;)\\s*"+escape(a)+"=([^;\\s]*)"));return(b?unescape(b[2]):null)};Cookie.remove=function(a){var b=Cookie.retrieve(a)||true;Cookie.update(a,"",-1);return b};