if(typeof(bsn)=="undefined"){_b=bsn={}}if(typeof(_b.Autosuggest)=="undefined"){_b.Autosuggest={}}else{alert("Autosuggest is already set!")}_b.AutoSuggest=function(e,d){if(!document.getElementById){return 0}this.fld=_b.DOM.gE(e);if(!this.fld){return 0}this.sInp="";this.nInpC=0;this.aSug=[];this.iHigh=0;this.oP=d?d:{};var a,b={minchars:1,meth:"get",varname:"input",className:"autosuggest",timeout:2500,delay:500,offsety:-5,shownoresults:true,noresults:"No results!",maxheight:250,cache:true,maxentries:25,id_as_value:false};for(a in b){if(typeof(this.oP[a])!=typeof(b[a])){this.oP[a]=b[a]}}var c=this;this.fld.onkeypress=function(f){return c.onKeyPress(f)};this.fld.onkeyup=function(f){return c.onKeyUp(f)};this.fld.onblur=function(f){return c.clearSuggestions()};this.fld.setAttribute("autocomplete","off")};_b.AutoSuggest.prototype.onKeyPress=function(f){var e=(window.event)?window.event.keyCode:f.keyCode;var d=13;var c=9;var g=27;var b=1;switch(e){case d:this.setHighlightedValue();b=0;var a=f||window.event;if(a.preventDefault){a.preventDefault()}else{a.returnValue=false}break;case g:this.clearSuggestions();break}return b};_b.AutoSuggest.prototype.onKeyUp=function(e){var c=(window.event)?window.event.keyCode:e.keyCode;var b=38;var d=40;var a=1;switch(c){case b:this.changeHighlight(c);a=0;break;case d:this.changeHighlight(c);a=0;break;default:this.getSuggestions(this.fld.value)}return a};_b.AutoSuggest.prototype.getSuggestions=function(g){if(g==this.sInp){return 0}_b.DOM.remE(this.idAs);this.sInp=g;if(g.length<this.oP.minchars){this.aSug=[];this.nInpC=g.length;return 0}var d=this.nInpC;this.nInpC=g.length?g.length:0;var b=this.aSug.length;if(this.nInpC>d&&b&&b<this.oP.maxentries&&this.oP.cache){var a=[];for(var e=0;e<b;e++){if(this.aSug[e].value.substr(0,g.length).toLowerCase()==g.toLowerCase()){a.push(this.aSug[e])}}this.aSug=a;this.createList(this.aSug);return false}else{var f=this;var c=this.sInp;clearTimeout(this.ajID);this.ajID=setTimeout(function(){f.doAjaxRequest(c)},this.oP.delay)}return false};_b.AutoSuggest.prototype.doAjaxRequest=function(c){if(c!=this.fld.value){return false}var g=this;if(typeof(this.oP.script)=="function"){var d=this.oP.script(encodeURIComponent(this.sInp))}else{var d=this.oP.script+this.oP.varname+"="+encodeURIComponent(this.sInp)}if(!d){return false}var b=this.oP.meth;var c=this.sInp;var a=function(h){g.setSuggestions(h,c)};var e=function(h){alert("AJAX error: "+h)};var f=new _b.Ajax();f.makeRequest(d,b,a,e)};_b.AutoSuggest.prototype.setSuggestions=function(req,input){if(input!=this.fld.value){return false}this.aSug=[];if(this.oP.json){var jsondata=eval("("+req.responseText+")");for(var i=0;i<jsondata.results.length;i++){this.aSug.push({id:jsondata.results[i].id,value:jsondata.results[i].value,info:jsondata.results[i].info})}}else{var xml=req.responseXML;var results=xml.getElementsByTagName("results")[0].childNodes;for(var i=0;i<results.length;i++){if(results[i].hasChildNodes()){this.aSug.push({id:results[i].getAttribute("id"),value:results[i].childNodes[0].nodeValue,info:results[i].getAttribute("info")})}}}this.idAs="as_"+this.fld.id;this.createList(this.aSug)};_b.AutoSuggest.prototype.createList=function(b){var p=this;_b.DOM.remE(this.idAs);this.killTimeout();if(b.length==0&&!this.oP.shownoresults){return false}var m=_b.DOM.cE("div",{id:this.idAs,className:this.oP.className});var d=_b.DOM.cE("div",{className:"as_corner"});var g=_b.DOM.cE("div",{className:"as_bar"});var r=_b.DOM.cE("div",{className:"as_header"});r.appendChild(d);r.appendChild(g);m.appendChild(r);var l=_b.DOM.cE("ul",{id:"as_ul"});for(var s=0;s<b.length;s++){var x=b[s].value;var o=x.toLowerCase().indexOf(this.sInp.toLowerCase());var j=x.substring(0,o)+"<em>"+x.substring(o,o+this.sInp.length)+"</em>"+x.substring(o+this.sInp.length);var q=_b.DOM.cE("span",{},j,true);if(b[s].info!=""){var u=_b.DOM.cE("br",{});q.appendChild(u);var h=_b.DOM.cE("small",{},b[s].info);q.appendChild(h)}var v=_b.DOM.cE("a",{href:"#"});var e=_b.DOM.cE("span",{className:"tl"}," ");var c=_b.DOM.cE("span",{className:"tr"}," ");v.appendChild(e);v.appendChild(c);v.appendChild(q);v.name=s+1;v.onclick=function(){p.setHighlightedValue();return false};v.onmouseover=function(){p.setHighlight(this.name)};var k=_b.DOM.cE("li",{},v);l.appendChild(k)}if(b.length==0&&this.oP.shownoresults){var k=_b.DOM.cE("li",{className:"as_warning"},this.oP.noresults);l.appendChild(k)}m.appendChild(l);var t=_b.DOM.cE("div",{className:"as_corner"});var w=_b.DOM.cE("div",{className:"as_bar"});var n=_b.DOM.cE("div",{className:"as_footer"});n.appendChild(t);n.appendChild(w);m.appendChild(n);var f=_b.DOM.getPos(this.fld);m.style.left=f.x+"px";m.style.top=(f.y+this.fld.offsetHeight+this.oP.offsety)+"px";m.style.width=this.fld.offsetWidth+"px";m.onmouseover=function(){p.killTimeout()};m.onmouseout=function(){p.resetTimeout()};document.getElementsByTagName("body")[0].appendChild(m);if(this.oP.forceselect){this.setHighlight(1)}else{this.iHigh=0}var p=this;this.toID=setTimeout(function(){p.clearSuggestions()},this.oP.timeout)};_b.AutoSuggest.prototype.changeHighlight=function(a){var b=_b.DOM.gE("as_ul");if(!b){return false}var c;if(a==40){c=this.iHigh+1}else{if(a==38){c=this.iHigh-1}}if(c>b.childNodes.length){c=b.childNodes.length}if(c<1){c=1}this.setHighlight(c)};_b.AutoSuggest.prototype.setHighlight=function(b){var a=_b.DOM.gE("as_ul");if(!a){return false}if(this.iHigh>0){this.clearHighlight()}this.iHigh=Number(b);a.childNodes[this.iHigh-1].className="as_highlight";this.killTimeout()};_b.AutoSuggest.prototype.clearHighlight=function(){var a=_b.DOM.gE("as_ul");if(!a){return false}if(this.iHigh>0){a.childNodes[this.iHigh-1].className="";this.iHigh=0}};_b.AutoSuggest.prototype.setHighlightedValue=function(){if(this.iHigh){this.sInp=this.fld.value=(this.oP.id_as_value)?this.aSug[this.iHigh-1].id:this.aSug[this.iHigh-1].value;this.fld.focus();if(this.fld.selectionStart){this.fld.setSelectionRange(this.sInp.length,this.sInp.length)}this.clearSuggestions();if(typeof(this.oP.callback)=="function"){this.oP.callback(this.aSug[this.iHigh-1])}}else{this.oP.callback()}};_b.AutoSuggest.prototype.killTimeout=function(){clearTimeout(this.toID)};_b.AutoSuggest.prototype.resetTimeout=function(){clearTimeout(this.toID);var a=this;this.toID=setTimeout(function(){a.clearSuggestions()},3600000)};_b.AutoSuggest.prototype.clearSuggestions=function(){this.killTimeout();var a=_b.DOM.gE(this.idAs);var c=this;if(a){var b=new _b.Fader(a,1,0,250,function(){_b.DOM.remE(c.idAs)})}};if(typeof(_b.Ajax)=="undefined"){_b.Ajax={}}_b.Ajax=function(){this.req={};this.isIE=false};_b.Ajax.prototype.makeRequest=function(c,b,a,d){if(b!="POST"){b="GET"}this.onComplete=a;this.onError=d;var e=this;if(window.XMLHttpRequest){this.req=new XMLHttpRequest();this.req.onreadystatechange=function(){e.processReqChange()};this.req.open("GET",c,true);this.req.send(null)}else{if(window.ActiveXObject){this.req=new ActiveXObject("Microsoft.XMLHTTP");if(this.req){this.req.onreadystatechange=function(){e.processReqChange()};this.req.open(b,c,true);this.req.send()}}}};_b.Ajax.prototype.processReqChange=function(){if(this.req.readyState==4){if(this.req.status==200){this.onComplete(this.req)}else{this.onError(this.req.status)}}};if(typeof(_b.DOM)=="undefined"){_b.DOM={}}_b.DOM.cE=function(g,c,b,f){var h=document.createElement(g);if(!h){return 0}for(var d in c){h[d]=c[d]}var e=typeof(b);if(e=="string"&&!f){h.appendChild(document.createTextNode(b))}else{if(e=="string"&&f){h.innerHTML=b}else{if(e=="object"){h.appendChild(b)}}}return h};_b.DOM.gE=function(c){var a=typeof(c);if(a=="undefined"){return 0}else{if(a=="string"){var b=document.getElementById(c);if(!b){return 0}else{if(typeof(b.appendChild)!="undefined"){return b}else{return 0}}}else{if(typeof(c.appendChild)!="undefined"){return c}else{return 0}}}};_b.DOM.remE=function(a){var b=this.gE(a);if(!b){return 0}else{if(b.parentNode.removeChild(b)){return true}else{return 0}}};_b.DOM.getPos=function(c){var c=this.gE(c);var b=c;var d=0;if(b.offsetParent){while(b.offsetParent){d+=b.offsetLeft;b=b.offsetParent}}else{if(b.x){d+=b.x}}var b=c;var a=0;if(b.offsetParent){while(b.offsetParent){a+=b.offsetTop;b=b.offsetParent}}else{if(b.y){a+=b.y}}return{x:d,y:a}};if(typeof(_b.Fader)=="undefined"){_b.Fader={}}_b.Fader=function(b,f,e,a,d){if(!b){return 0}this.e=b;this.from=f;this.to=e;this.cb=d;this.nDur=a;this.nInt=50;this.nTime=0;var c=this;this.nID=setInterval(function(){c._fade()},this.nInt)};_b.Fader.prototype._fade=function(){this.nTime+=this.nInt;var a=Math.round(this._tween(this.nTime,this.from,this.to,this.nDur)*100);var c=a/100;if(this.e.filters){try{this.e.filters.item("DXImageTransform.Microsoft.Alpha").opacity=a}catch(b){this.e.style.filter="progid:DXImageTransform.Microsoft.Alpha(opacity="+a+")"}}else{this.e.style.opacity=c}if(this.nTime==this.nDur){clearInterval(this.nID);if(this.cb!=undefined){this.cb()}}};_b.Fader.prototype._tween=function(e,a,g,f){return a+((g-a)*(e/f))};(function(b){var a={init:function(c,d){return this.each(function(){var e=b.extend({},b.fn.nestedselect.defaults,d),m=e.nested_fields,l=e.initData,f=b("<select name='value' />"),g=b("<input type='hidden' value='"+e.category_name+"' name='name' />"),h=b("<select />"),k=b("<select />"),i=b("<input type='hidden' name='rule_type' value='nested_rule' />"),j=b("<input type='hidden' name='nested_rules' value='' />");(c.getCategoryList()||[]).each(function(n){b("<option />").html(n).val(n).appendTo(f)});f.val(l.value||"").bind("change",function(n){h.empty();(c.getSubcategoryList(f.val())||$H()).each(function(o){b("<option />").html(o.key).val(o.key).appendTo(h)});h.trigger("change")});h.bind("change",function(n){if(!h.data("initialLoad")){if(l.nested_rules&&l.nested_rules[0]){h.val(l.nested_rules[0].value)}h.data("initialLoad",true)}if(c.third_level){k.empty();(c.getItemsList(f.val(),h.val())).each(function(o){b("<option />").html(o.key).val(o.key).appendTo(k)});k.trigger("change")}else{a.setNestedRule(j,m.subcategory.name,h.val(),m.items.name,k.val())}});k.bind("change",function(n){if(!k.data("initialLoad")){if(l.nested_rules&&l.nested_rules[1]){k.val(l.nested_rules[1].value)}k.data("initialLoad",true)}a.setNestedRule(j,m.subcategory.name,h.val(),m.items.name,k.val())});f.trigger("change");if(e.type!="action"){b(this).append(f).append(g).append(h);if(c.third_level){b(this).append(k)}b(this).append(i).append(j)}else{g.prop("value","set_nested_fields");b(this).append(g).append("<input type='hidden' name='category_name' value='"+e.category_name+"' />").append(f).append(j).append(h);if(c.third_level){b(this).append(k)}}})},setNestedRule:function(d,g,e,f,c){item_check=(c)?(', { "name" : "'+f+'", "value" : "'+c+'" }'):"";d.val('[{ "name" : "'+g+'", "value" : "'+e+'" }'+item_check+"]")}};b.fn.nestedselect=function(c){if(a[c]){return a[c].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof c==="object"||!c){return a.init.apply(this,arguments)}else{b.error("Method "+c+" does not exist on jQuery.nestedselect")}}};b.fn.nestedselect.defaults={category_name:"",nested_fields:{subcategory:{name:"",label:""},items:{name:"",label:""}},initData:({value:"",nested_rules:[{value:""},{value:""}]})}})(jQuery);function postProcessCondition(a,b){if(a&&a.domtype==="autocompelete"){new bsn.AutoSuggest(b,{script:a.data_url+"?",varname:"v",json:true,maxresults:10,timeout:3600000,minchars:1,shownoresults:false,id_as_value:true,cache:false,delay:200});Form.Element.activate(b);jQuery("#"+b).trigger("blur")}}var preProcessCondition=function(a,b){a=$H(a);a.each(function(d){var c=$A();$A(d.value).each(function(f){var e={name:f,value:b[f]};c.push(e)});a.set(d.key,c)});return a};rules_filter=function(j,d,f,o){var n={init_feed:[],add_dom:".addchoice",rule_dom:".rule_list",rem_dom:".delete",operators:false,delete_last:false,selectListArr:[],empty_dom:".empty_choice",onRuleSelect:function(){},change_filter_data:function(p){return p}};if(o){jQuery.extend(n,o)}var b=$H(),k=n.operators,a=j||"default",g=null,i=f+" "+n.rule_dom,c=f+" "+n.add_dom;var e={itemNumber:0,get:function(){return ++e.itemNumber}};var h={add_to_hash:function(p){if(n.delete_last){p=p[0]["ticket"].concat(p[0]["forum"],p[0]["solution"])}p.each(function(q){b.set(q.name,q)})},getContainer:function(q){var p=jQuery("<div class='controls' />");var r=jQuery("<fieldset />").append('<input type="hidden" name="'+q+'" value="start" />').append("<span class='sort_handle'></span>").append('<img class="delete" src="/images/delete.png" />').append(p).append('<input type="hidden" name="'+q+'" value="end" />');jQuery.data(r,"inner",p);return r},dom_size:0,add_dom:function(){var q=h.getContainer(a);var r=[];if(n.delete_last){var p=jQuery("input[name=quest[category]]:checked").val();r=n.change_filter_data(d[0][n.selectListArr[p]])}else{r=d}jQuery.data(q,"inner").append(FactoryUI.dropdown(r,"name","ruCls_"+a)).append("<div />");list_C=jQuery(f).find(n.rule_dom);q.appendTo(list_C);this.dom_size++;this.populateEmpty()},feed_data:function(p){p.each(function(w){try{var r=h.getContainer(a);var t=jQuery("<div />");var s=w.name+e.get();if(w.operator){try{opType=b.get(w.name).operatortype;t.append(FactoryUI.dropdown(k.get(opType),"operator").val(w.operator))}catch(v){}}if(w.name=="set_nested_fields"){w.name=w.category_name}t.append(conditional_dom(b.get(w.name),s,a,w));var u=[];if(n.delete_last){var q=jQuery("input[name=quest[category]]:checked").val();u=n.change_filter_data(d[0][n.selectListArr[q]])}else{u=d}jQuery.data(r,"inner").append(FactoryUI.dropdown(u,"name","ruCls_"+a).val(w.name)).append(t);list_C=jQuery(f).find(n.rule_dom);r.appendTo(list_C);postProcessCondition(b.get(w.name),s)}catch(v){}});this.dom_size=p.size()+1},populateEmpty:function(){jQuery(f).find(n.empty_dom).toggle(this.dom_size<=1)},refresh_list:function(){jQuery(f).find(n.rule_dom).empty();g.val("");this.dom_size=1},get_filter_list:function(u,q){var p=jQuery(q).serializeArray(),v=$H(),s=[],t=$H(),x=u||"object";flag=false;p.each(function(y){if(y.name==a||flag){if(!v.get(a)){v.set(a,$A())}if(y.value=="start"){t=$H();flag=true}else{if(y.value=="end"){if(t.size()){v.get(a).push(t.toObject())}flag=false}else{if(y.value!=-1){t.set(y.name,y.value)}}}}});var r=[],w=[];r=v.get(a);if(r&&r.length!=0){w=(x!="json")?r.toObject():r.toJSON()}g.val(w);this.populateEmpty&&this.populateEmpty();return w},init:function(){h.add_to_hash(d);if(n.init_feed.size()){h.feed_data(n.init_feed)}else{h.add_dom()}this.populateEmpty()}};var m={add_filter:h.add_new_filter,get_filter_list:h.get_filter_list,get_size:(h.dom_size-1),refresh_list:h.refresh_list};function l(){g=jQuery('<input type="hidden" name="'+a+'_data" value="" />').prependTo(f);jQuery(f).find(n.rule_dom).sortable({items:"fieldset",containment:"parent",tolerance:"pointer",handle:"span.sort_handle"});jQuery(f).parents("form:first").submit(function(p){h.get_filter_list("json",this)});jQuery(".l_placeholder").live("click",function(p){active_email_body=jQuery(this).prev();jQuery("#place-dialog").slideDown()});jQuery(f+" .ruCls_"+a).live("change",function(){var q=jQuery(this).next().empty();if(this.value!==-1){var r=b.get(this.value);var p=r.name+e.get();if(r.operatortype){q.append(FactoryUI.dropdown(k.get(r.operatortype),"operator"))}q.append(conditional_dom(r,p,a));postProcessCondition(r,p)}});jQuery(f).find("select, :text").live("change",function(){var p=jQuery(f).parents("form:first");n.onRuleSelect.apply(this,[this,h.get_filter_list("json",p),p])});jQuery(c).bind("click",function(){h.add_dom()});jQuery(f+" .delete").live("click",function(){filter=jQuery(this).parent();if(n.delete_last||(filter.parent().children().size()!=1)){filter.remove();h.dom_size--}var p=jQuery(f).parents("form:first");n.onRuleSelect.apply(this,[this,h.get_filter_list("json",p),p])});h.init()}l();return m};