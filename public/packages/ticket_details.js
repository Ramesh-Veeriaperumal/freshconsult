(function(d){TICKET_DETAILS_DATA.updating_properties=false;var h;var t=0;var e=false,p=0,a=TICKET_DETAILS_DATA.draft["cleared_flag"];var b,r,i,v;save_draft=function(w){if(d.trim(w)!=""){d(".ticket_show #reply-draft").show().addClass("saving");d(".ticket_show #reply-draft").parent().addClass("draft_saved");d(".ticket_show #draft-save").text(TICKET_DETAILS_DATA.draft["saving_text"]);d(".ticket_show #clear-draft").hide();e=true;d.ajax({url:TICKET_DETAILS_DATA.draft["save_path"],type:"POST",data:{draft_data:w},success:function(x){d(".ticket_show #draft-save").text(TICKET_DETAILS_DATA.draft["saved_text"]);d(".ticket_show #clear-draft").show();d(".ticket_show #reply-draft").removeClass("saving");b=new Date();e=false}})}};autosaveDraft=function(){if(r==0&&TICKET_DETAILS_DATA.draft["hasChanged"]){var w=d("#cnt-reply-body").getCode();if(d.trim(w)!=""){save_draft(w)}}TICKET_DETAILS_DATA.draft["hasChanged"]=false};triggerDraftSaving=function(){r=0;v=setInterval(autosaveDraft,30000)};stopDraftSaving=function(){r=1;clearInterval(v)};clearSavedDraft=function(){d.ajax({url:TICKET_DETAILS_DATA.draft["clear_path"],type:"delete"});TICKET_DETAILS_DATA.draft["clearingDraft"]=true;d("#cnt-reply-body").setCode(TICKET_DETAILS_DATA.draft["default_reply"]);TICKET_DETAILS_DATA.draft["hasChanged"]=false;d(".ticket_show #reply-draft").hide();d(".ticket_show #reply-draft").parent().removeClass("draft_saved");a=true};d("body").on("mouseover.ticket_details",".ticket_show #draft-save",function(){if(e!=0){jQuery(".ticket_show #draft-save").attr("title",humaneDate(b,new Date()))}});d("body").on("mouseout.ticket_details",".ticket_show #draft-save",function(){d(".ticket_show #draft-save").attr("title","")});d("body").on("click.ticket_details",".ticket_show #clear-draft",function(){if(confirm(TICKET_DETAILS_DATA.draft["clear_text"])){clearSavedDraft()}});var l=false;var s=function(w){w=w||3000;if(typeof(h)!="undefined"){clearTimeout(h)}};silenceTktFieldsUpdate=function(){l=false};unsilenceTktFieldsUpdate=function(){l=true};showHideDueByDialog=function(x){if(x){var w=d("#duedate-dialog-container").detach();d("#ticket_status_box").append(w);d("#duedate-dialog-container").show();d("#due-date-dialog").fadeIn();d("#due-date-dialog").position({of:d("#due-by-element-parent"),my:"right top",at:"left top"});d("#due-date-dialog").css({top:d("#due-date-dialog").position().top+30})}else{d("#due-date-dialog").fadeOut(300,function(){d("#duedate-dialog-container").hide();var y=d("#duedate-dialog-container").detach();d("#Pagearea").append(y)})}d("#edit-due-by-time").removeClass("highlight-text")};showHideEmailContainer=function(){d(".ccEmailMoreContainer").toggle();if(d(".ccEmailMoreContainer").css("display")=="inline"){d(".ccEmailMoreLink").text("")}};showHideToEmailContainer=function(){d(".toEmailMoreContainer").toggle();if(d(".toEmailMoreContainer").css("display")=="inline"){d(".toEmailMoreLink").text("")}};changeStatusToResolved=function(){d("#helpdesk_ticket_status option").prop("selected",false);d("#helpdesk_ticket_status option[value=4]").prop("selected",true);l=true;d("#helpdesk_ticket_status").trigger("change")};changeStatusTo=function(w){d("#helpdesk_ticket_status option").prop("selected",false);d("#helpdesk_ticket_status option[value="+w+"]").prop("selected",true);l=true;d("#helpdesk_ticket_status").trigger("change")};refreshStatusBox=function(){d.ajax({url:TICKET_DETAILS_DATA.status_refresh_url,success:function(w){d("#due-by-element-parent").replaceWith(w);d("#due-by-element-parent").show("highlight",3000)}})};d("#helpdesk_ticket_group_id").bind("change",function(w){d("#TicketProperties .default_agent").addClass("loading-right");d.ajax({type:"POST",url:"/helpdesk/commons/group_agents/"+this.value,contentType:"application/text",success:function(x){d("#TicketProperties .default_agent select").html(x).trigger("change");d("#TicketProperties .default_agent").removeClass("loading-right")}})});function g(w){new Date(w)}var c=function(){var w;var x=d("#all_notes").length>0;if(x){w=TICKET_DETAILS_DATA.notes_pagination_url+"since_id="+TICKET_DETAILS_DATA.last_note_id}else{w=TICKET_DETAILS_DATA.activities_pagination_url+"since_id="+TICKET_DETAILS_DATA.last_activity}d.ajax({url:w,type:"GET",success:function(y){d("[rel=activity_container]").append(y)}})};var n=null;swapEmailNote=function(x,w){d("#TicketPseudoReply").hide();if((n!=null)&&(d(n).get(0).id!=x)){d("#"+n.get(0).id).hide()}n=d("#"+x).removeClass("hide").show();if(n.data("type")=="textarea"){setCaretToPos(d("#"+x+" textarea").get(0),0)}else{invokeRedactor(x+"-body",x);d("#"+x+"-body").getEditor().focus();if(d.browser.mozilla){d("#"+x+"-body").insertHtml("<div/>")}d("#"+x+"-body").getEditor().on("blur",function(){try{d("#"+x+"-body").data("focus_node",document.getSelection().getRangeAt(0).endContainer);d("#"+x+"-body").data("focus_node_offSet",document.getSelection().getRangeAt(0).endOffset)}catch(y){}})}n.trigger("visibility");if(x=="cnt-reply"){r=false;if(!e&&p!=1){TICKET_DETAILS_DATA.draft["hasChanged"]=false;triggerDraftSaving();if(!a){d("#draft-save").text(TICKET_DETAILS_DATA.draft["saved_text"]);d("#clear-draft").show();d("#reply-draft").show();d(".ticket_show #reply-draft").parent().addClass("draft_saved")}else{d("#reply-draft").hide();d(".ticket_show #reply-draft").parent().removeClass("draft_saved")}}p=1}else{stopDraftSaving()}};var m=null;showCannedResponse=function(w,x){d("#canned_response_container").css(d(w).offset());m=d(w).data("tinyMceId")||"";d("#canned_response_container").show().addClass("loading");d("#canned_response_list").load("/helpdesk/canned_responses/index/"+x,function(){d("#canned_response_container").removeClass("loading")}).show()};insertIntoConversation=function(x,w){note_area=d("#cnt-note");reply_area=d("#cnt-reply");fwd_area=d("#cnt-fwd");tweet_area=d("#cnt-tweet");if(w==undefined){if(reply_area.css("display")=="block"){w="cnt-reply-body"}else{if(note_area.css("display")=="block"){w="cnt-note-body"}}}if(tweet_area.css("display")=="block"){get_short_url(x,function(y){insertTextAtCursor(d("#send-tweet-cnt-tweet-body"),y||x);d("#send-tweet-cnt-tweet-body").trigger("focus").trigger("keydown")})}if(jQuery(w)){jQuery("#"+w).getEditor().focus();jQuery("#"+w).insertHtml(x)}return};getCannedResponse=function(y,x,w){d("#canned_response_container").addClass("loading");d(w).addClass("response-loading");d.ajax({type:"POST",url:"/helpdesk/canned_responses/show/"+y+"?ca_resp_id="+x,contentType:"application/text",async:false,success:function(z){insertIntoConversation(z);d(w).removeClass("response-loading");d(w).qtip("hide");d(".ui-icon-closethick").trigger("click")}});return true};var q=function(w){return"<i class='priority_block priority_color_"+w.id+"'></i>"+w.text};var o=function(w){if(w&&typeof(w)==="string"){return w.replace(/&/g,"&amp;")}return w};var k=function(w){return w.text.escapeHTML()};var u=function(w){return w.value};var j=function(){var z=d("#all_notes").length>0;var y,w;if(z){w=d("[rel=activity_container] .conversation").length;y=TICKET_DETAILS_DATA.total_notes}else{y=TICKET_DETAILS_DATA.total_activities;w=TICKET_DETAILS_DATA.loaded_activities}if(w<y){var x=y-w;d("#show_more [rel=count-total-remaining]").text(y-w);d("#show_more").removeClass("hide");return true}else{d("#show_more").addClass("hide");return false}};var f=function(){var w=d("#all_notes").length>0;d("#show_more").off("click.ticket_details");d("#show_more").on("click.ticket_details",function(y){y.preventDefault();d("#show_more").addClass("loading");var x;if(w){x=TICKET_DETAILS_DATA.notes_pagination_url+"before_id="+TICKET_DETAILS_DATA.first_note_id}else{x=TICKET_DETAILS_DATA.activities_pagination_url+"before_id="+TICKET_DETAILS_DATA.first_activity}d.get(x,function(z){TICKET_DETAILS_DATA.first_activity=null;TICKET_DETAILS_DATA.first_note_id=null;d("#show_more").removeClass("loading").addClass("hide");d("[rel=activity_container]").prepend(z)})})};d(document).ready(function(){d("#due-date-picker").datepicker({showOtherMonths:true,selectOtherMonths:true,changeMonth:true,changeYear:true,onSelect:function(C,B){selectedDate=new Date(B.selectedYear,B.selectedMonth,B.selectedDay);d("#due-date-value").html(selectedDate.toDateString());y()}});d("#due-date-options").change(function(){if(this.value=="specific"){x(true)}else{x(false)}});d("#due_by_hour, #due_by_minute, #due_by_am_pm").change(y);d("#set-date-time").click(function(){x(true);d("#due-date-options").val("specific")});function x(B){if(B){d("#due-date-button").hide();d("#due-date-calender").slideDown(300)}else{d("#due-date-button").show();d("#due-date-calender").slideUp(300)}}d("#Pagearea").on("click","#edit-dueby-time",function(){showHideDueByDialog(true)});d("#due-date-overlay").click(function(){showHideDueByDialog(false)});function y(){_date_time=d("#due-date-picker").datepicker("getDate");am_pm_val=d("#due_by_am_pm").val();hrs_val=parseInt(d("#due_by_hour").val());if(hrs_val==12&&am_pm_val=="AM"){hrs_val=0}else{if(am_pm_val=="PM"&&hrs_val!=12){hrs_val+=12}}_date_time.setHours(hrs_val);_date_time.setMinutes(d("#due_by_minute").val());if(TICKET_DETAILS_DATA.created_on>_date_time){d("#calender-buttons").hide();d("#calender-info").show()}else{d("#calender-buttons").show();d("#calender-info").hide()}return _date_time}d("#DueDateForm").submit(function(){d("#calender-buttons").addClass("saving-items");_date_time=new Date();if(d("#due-date-options").val()=="specific"){_date_time=y()}d("#due_by_date_time").val(_date_time);d.post(this.action,d(this).serialize(),function(B){d("#edit-dueby-time-parent").html(B);showHideDueByDialog(false);d("#calender-buttons").removeClass("saving-items")});return false});d("ul.tkt-tabs").each(function(){var B,C,D=d(this).find("a");B=d(D.filter('[href="'+location.hash+'"]')[0]||D[0]);B.parent().addClass("active");C=d(B.attr("href"));D.not(B).each(function(){d(d(this).attr("href")).hide()});d(this).on("click.ticket_details","a",function(F){F.preventDefault();B.parent().removeClass("active");C.hide();B=d(this);C=d(d(this).attr("href"));B.parent().addClass("active");var E=C.find("textarea");C.append(E.val());E.remove();C.show()});B.click()});d("body").on("click.ticket_details",".widget.load_on_click.inactive",function(C){var B=d(this).find("textarea");d(this).find(".content").append(B.val());B.remove();d(this).removeClass("inactive load_on_click")});d("body").on("click.ticket_details",".widget.load_remote.inactive",function(B){d(this).children(".content").trigger("afterShow");d(this).removeClass("inactive load_remote")});d("body").on("click.ticket_details",".widget:not(.load_remote, .load_on_click, .dialog-widget) > h3",function(B){d(this).parent().toggleClass("inactive")});d("select").data("placeholder","");d("#TicketProperties select.dropdown, #TicketProperties select.dropdown_blank, #TicketProperties select.nested_field, select.select2").livequery(function(){if(this.id=="helpdesk_ticket_priority"){d(this).select2({formatSelection:q,formatResult:q,escapeMarkup:o,specialFormatting:true,minimumResultsForSearch:10})}else{d(this).select2({minimumResultsForSearch:10})}});d("[rel=tagger]").livequery(function(){d(this).select2({tags:TICKET_DETAILS_DATA.tag_list,tokenSeparators:[","]})});d("body").on("change.ticket_details","#twitter_handle",function(){twitter_handle=d("#twitter_handle").val();req_twt_id=d("#requester_twitter_handle").val();istwitter=d("#cnt-tweet").data("isTwitter");if(!istwitter||req_twt_id==""||twitter_handle==""){return}d.ajax({type:"POST",url:"/social/twitters/user_following?twitter_handle="+twitter_handle+"&req_twt_id="+req_twt_id,contentType:"application/text",async:false,success:function(B){if(B.user_follows==true){d("#tweet_type_selector").show();d("#not_following_message").hide()}else{d("#tweet_type_selector").hide();d("#not_following_message").show()}}})});d("body").on("click.ticket_details","[rel=toggle_email_container]",function(D){D.preventDefault();var C=d("#"+d(this).data("container"));var B=d("#"+d(this).data("container")+" select");C.toggle();if(C.is(":visible")){C.find(".search_field_item input").focus();d("#"+d(this).data("toggle-button")).hide()}else{d("#"+d(this).data("toggle-button")).show()}if(typeof(d(this).data("clear"))!="undefined"&&d(this).data("clear")==true){C.find("li.choice").remove();d("#"+d(this).data("toggle-checkbox")).prop("checked",false);d("#"+d(this).data("toggle-button")).show()}else{d("#"+d(this).data("toggle-checkbox")).prop("checked",true)}});d("body").on("change.ticket_details",".ticket_show #activity_toggle input[type=checkbox]",function(D){D.preventDefault();var C=d(this).parent();var F=d(this);C.addClass("loading_activities");var E=d("#all_notes").length>0;var B=E?TICKET_DETAILS_DATA.activities_pagination_url:TICKET_DETAILS_DATA.notes_pagination_url;if(E){TICKET_DETAILS_DATA.first_activity=null;TICKET_DETAILS_DATA.loaded_activities=0}else{TICKET_DETAILS_DATA.first_note_id=null;TICKET_DETAILS_DATA.total_notes=0}d("#show_more").addClass("hide").data("next-page",null);d.ajax({url:B,success:function(G){d("[rel=activity_container]").replaceWith(G);d("#show_more").data("next-page",null);if(j()){f()}C.removeClass("loading_activities")},error:function(G){d("#show_more").removeClass("hide");F.prop("checked",!F.prop("checked"));C.removeClass("loading_activities");F.next().toggleClass("active")}})});d(".ticket_details").on("click.ticket_details","[rel=activity_container] .minimizable",function(B){if(d(B.target).is("a")){return}d(this).toggleClass("minimized")});d("body").on("click.ticket_details",".collision_refresh",function(B){window.location=TICKET_DETAILS_DATA.ticket_path});d("body").on("click.ticket_details",".conversation_thread .request_panel form .submit_btn",function(B){B.preventDefault();d(this).parents("form").trigger("submit")});d("body").on("click.ticket_details",".conversation_thread .request_panel form .cancel_btn",function(D){D.preventDefault();if(D.clientX==0&&D.clientY==0){return}var C=d(this);d("#"+C.data("cntId")).hide().trigger("visibility");if(C.data("showPseudoReply")){d("#TicketPseudoReply").show()}var B=d("#"+C.data("cntId")+" form");if(C.data("clearDraft")){clearSavedDraft();stopDraftSaving()}if(B.data("cntId")&&B.data("destroyEditor")){d("#"+B.data("cntId")+"-body").destroyEditor();B.resetForm();B.trigger("reset");B.find(".dropbox_div input[filelist]:not(.original_input)").remove()}if(B.attr("rel")=="forward_form"){B.find(".forward_email li.choice").remove()}});d("body").on("click.ticket_details","#time_integration .app-logo input:checkbox",function(B){d(this).parent().siblings(".integration_container").toggle(d(this).prop("checked"))});d("body").on("submit.ticket_details",".conversation_thread .request_panel form",function(C){var B=d(this);if(B.valid()){if(B.attr("rel")=="forward_form"){if(B.find('input[name="helpdesk_note[to_emails][]"]').length==0){alert("No email addresses found");return false}}B.find("input[type=submit]").prop("disabled",true);if(B.data("panel")){d("#"+B.data("panel")).block({message:" <h1>...</h1> ",css:{display:"none",backgroundColor:"#FFFFFF",border:"none",color:"#FFFFFF"},overlayCSS:{backgroundColor:"#FFFFFF",opacity:0.6}})}if(d("html").hasClass("ie6")||d("html").hasClass("ie7")||d("html").hasClass("ie8")||d("html").hasClass("ie9")||d("html").hasClass("ie10")){stopDraftSaving();d.ajax({url:TICKET_DETAILS_DATA.draft["clear_path"],type:"delete"});return true}C.preventDefault();B.ajaxSubmit({dataType:"script",beforeSubmit:function(F,H){var J=d("#all_notes").length>0;var I=d('<input type="hidden" rel="ajax_params" name="format" value="js" />');B.append(I);var E=d('<input type="hidden" rel="ajax_params" name="xhr" value="true" />');B.append(E);var G=d('<input type="hidden" rel="ajax_params" name="showing" value="'+(J?"notes":"activities")+'" />');B.append(G);var D=d('<input type="hidden" rel="ajax_params" name="since_id" value="'+(J?TICKET_DETAILS_DATA.last_note_id:TICKET_DETAILS_DATA.last_activity)+'" />');B.append(D)},success:function(D){if(B.data("panel")){d("#"+B.data("panel")).unblock();d("#"+B.data("panel")).hide();d("#"+B.data("panel")).trigger("visibility")}if(B.data("cntId")&&B.data("cntId")=="cnt-reply"){stopDraftSaving()}if(B.attr("rel")=="edit_note_form"){d("#note_details_"+B.data("cntId")).html(d(D).find("body-html").text());d("#note_details_"+B.data("cntId")).show()}if(B.data("cntId")&&B.data("destroyEditor")){d("#"+B.data("cntId")+"-body").destroyEditor();B.resetForm();B.trigger("reset")}if(B.attr("rel")=="forward_form"){B.find(".forward_email li.choice").remove()}if(B.attr("rel")=="note_form"){d("#toggle-note-visibility").removeClass("visible")}B.find(".item[rel=original_attachment]").show();B.find("input[rel=original_attachment]").prop("disabled",false);try{if(B.data("cntId")&&B.data("cntId")=="cnt-reply"){stopDraftSaving();clearSavedDraft()}}catch(E){}B.find("[rel=ajax_params]").remove();B.find("input[type=submit]").prop("disabled",false);if(B.data("showPseudoReply")){d("#TicketPseudoReply").show();refreshStatusBox()}},error:function(D){B.find("input[type=submit]").prop("disabled",false);if(B.data("panel")){d("#"+B.data("panel")).unblock()}if(B.data("cntId")&&B.data("cntId")=="cnt-reply"){triggerDraftSaving()}}})}else{B.find("input[type=submit]").prop("disabled",false)}});d("body").on("click.ticket_details","[rel=TicketReplyPlaceholder]",function(B){B.preventDefault();d(this).hide();d("#ReplyButton").click()});var w=d("#wrap .header").first().height()+110;var A=d(".fixedStrap").outerHeight();var z=d(window);z.on("scroll.ticket_details",function(){if(z.scrollTop()>w){if(!d(".fixedStrap").hasClass("at_the_top")){d(".fixedStrap, .fixedbg").addClass("at_the_top");d("#forFixed").show();d(".fixedStrap, .fixedbg").css({top:-A}).animate({top:0},300,"easeOutExpo");d("#firstchild").addClass("firstchild")}}else{d(".fixedStrap, .fixedbg").removeClass("at_the_top").css({top:""});d("#forFixed").hide();d("#firstchild").removeClass("firstchild")}});d("body").on("click.ticket_details","#toggle-note-visibility",function(B){var C=d(this).find("input[type=checkbox]");C.prop("checked",!C.prop("checked"));d(this).toggleClass("visible")});d("body").on("click.ticket_details",".ticket_show #close_ticket_btn",function(C){C.preventDefault();var B=d("<form>").attr("method","post").attr("action",d(this).attr("data-href")+"?disable_notification="+C.shiftKey).appendTo(document.body);B.submit();return false});d("#custom_ticket_form").on("change.ticket_details",function(B){if(!l){d("#helpdesk_ticket_submit").show();TICKET_DETAILS_DATA.updating_properties=true;d(B.target).data("updated",true)}l=false});d(".ticket_details").on("click.ticket_details","[rel=custom-reply-status]",function(B){B.preventDefault();B.stopPropagation();jQuery("#reply_ticket_status_"+jQuery(this).data("cntId")).val(jQuery(this).data("statusVal"));jQuery("body").click();changeStatusTo(jQuery(this).data("statusVal"));d(this).parents("form").trigger("submit")});d("#custom_ticket_form").on("submit.ticket_details",function(C){C.preventDefault();var B=d("#custom_ticket_form");if(B.valid()){var D=d("#custom_ticket_form .btn-primary");D.button("loading");D.attr("disabled","disabled");d.ajax({type:"POST",url:B.attr("action"),data:B.serialize(),dataType:"json",success:function(F){TICKET_DETAILS_DATA.updating_properties=false;D.val(D.data("saved-text")).addClass("done");setTimeout(function(){D.button("reset").removeClass("done")},2000);var E=false;if(d(".ticket_show #helpdesk_ticket_priority").data("updated")||d(".ticket_show #helpdesk_ticket_status").data("updated")){d(".ticket_show .source-badge-wrap .source").attr("class","").addClass("source ").addClass("priority_color_"+d(".ticket_show #helpdesk_ticket_priority").val()).addClass("status_"+d(".ticket_show #helpdesk_ticket_status").val());E=true}if(d(".ticket_show #helpdesk_ticket_source").data("updated")){d(".ticket_show .source-badge-wrap .source span").attr("class","").addClass("source_"+d(".ticket_show #helpdesk_ticket_source").val())}B.find("input, select, textarea").each(function(){d(this).data("updated",false)});if(E){refreshStatusBox()}},error:function(E,G,F){D.text(D.data("default-text")).prop("disabled",false)}})}});d("body").on("mouseenter.ticket_details",".ticket_show .control-left h2.subject:not(.show_full)",function(){if(d(this).height()>30){d(this).siblings(".ticket-actions").hide()}});d("body").on("mouseleave.ticket_details",".ticket_show .control-left h2.subject:not(.show_full)",function(){if(!d(this).siblings(".ticket-actions").is(":visible")){d(this).siblings(".ticket-actions").show()}});d(".ticket_show").on("click.ticket_details","[rel=note-button]",function(B){if(!d(this).parent().parent().hasClass("dropdown-menu")){B.preventDefault();B.stopPropagation()}swapEmailNote("cnt-"+d(this).data("note-type"),this)});if(j()){f()}d.getScript("/helpdesk/tickets/prevnext/"+TICKET_DETAILS_DATA.displayId);d("#activity_toggle .toggle-button").removeClass("active");jQuery("#activity_toggle [rel=toggle]").prop("checked",false)});d("body").on("change.pattern",".selected_to_yellow [type=radio], .selected_to_yellow [type=checkbox]",function(w){d(this).parents(".selected_to_yellow").find(".stripe-select").removeClass("stripe-select");d(this).parents("td").first().toggleClass("stripe-select",d(this).prop("checked"))});d(window).on("unload.ticket_details",function(x){var w=[];if(d("#custom_ticket_form .error:input").length>0){w.push("There are errors in the form.")}if(TICKET_DETAILS_DATA.updating_properties){w.push("Unsaved changes in the form")}if(TICKET_DETAILS_DATA.draft["hasChanged"]&&r==0){autosaveDraft()}if(w.length>0){var y="";w.forEach(function(z){y+=z+"\n"});x=x||window.event;if(x){x.returnValue=y}return y}})})(jQuery);