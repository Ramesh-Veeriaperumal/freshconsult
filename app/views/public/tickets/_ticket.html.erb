<%= render :partial => "/support/shared/ticket_show_sidebar" %> 
<div class="request_details">
  <% if @ticket.deleted %>
    <div class="info-highlight-deleted">    
      <%= t('ticket_deleted') %>
    </div>
  <% end %>
    <div class="requestCnt request-cnt-first">
    <h3 class="forum-title">
      <em><%= "##{@ticket.display_id}" %></em>
      <b><%= h(@ticket.subject) %></b>
    </h3>
    <div class="description">
      <div class="ticket_actions action_icons" id="close_ticket_btn"></div>  
        <div class="user_details">
            <%= user_avatar(@ticket.requester)  %>
            <%= t('reported_by') %> <%= link_to_user(@ticket.requester, :class => "user_name") %> 
            <div class="info"> 
          <%= t('created_on') %><%= formated_date(@ticket.created_at) %>    
        </div>          
        </div>                       
      <div class="request-wrapper">
            <div id="description-full" class="details min_height">
          <span class="seperator"></span>
            <%= @ticket.description_html.html_safe %>
          </div>  
        <% unless @ticket.all_attachments.empty? %>
          <span class="seperator"></span>
          <h4><%= @ticket.all_attachments.size %> <%= t('attachments')%></h4>
          <%= attachment_container(@ticket.all_attachments, false, "ticket", @ticket.id) %>
        <% end %> 
        <% unless @ticket.cloud_files.empty? %>
            <%= attachment_container(@ticket.cloud_files, false, "cloud_file", nil) %>
            <% end %>
      </div>
    </div>
  </div> 
  <% unless @ticket.deleted %>
    <div class="request-wrapper"> 
      <a href="javascript:void(0)" class="btn btn-primary" id="add_note_btn" 
        onclick="jQuery('#ReplyToTicketPublic').show();
        jQuery(this).hide();invokeRedactor('portal_ticket_note_public');"><%= t('ticket.add_note') %></a>     
    </div>  
  <% end %>
  <br />

  <div id="ReplyToTicketPublic" class="request_panel" style="display:none;">
    <%= form_for Helpdesk::Note.new, 
          :url => public_ticket_notes_path(params[:id]),
          :html => {:multipart => true, :rel => "validate" }  do |f| %>
      <%= f.error_messages %>
      <ul class="ui-form">
          <li> 
          <%= content_tag( :h4, t('ticket.note_form.form_title'), :class => "title" ) %>
          <% unless current_user %>
            <%= label_tag :requester_email, (t('your_email')+'<span class="required_star">*</span>').html_safe %>
            <%= text_field_tag :requester_email, nil, :class => "email required"  %>
          <% end %>
          <%= f.fields_for(:note_body, Helpdesk::NoteBody.new) do |ff| %>
                  <%= ff.text_area :body_html, :class => "required",
                  :id=>"portal_ticket_note_public", :value => "" %>
                <% end %>
        </li>
        <li class="attachment-options"  id="attachment-options">
          <% unless local_assigns[:no_attachments] %>
            <%= render :partial => "/helpdesk/shared/attachment_form", :locals => { :nsc_param => "helpdesk_note", :public_ticket => true } %>
          <% end %>
        </li>
        <li class="alignright">
          <%= f.submit t('add'), {:class => "uiButton"} %>
          <a href="javascript:void(0)" class="uiButton" onclick="jQuery('#requester_email').val('');
            jQuery('#ReplyToTicketPublic').hide(); jQuery('#add_note_btn').show();"> <%= t('cancel') %> </a>
        </li>
      </ul>
    <% end %>   
  </div>

  <div class="seperator-shadow"></div>
  <% unless @ticket.notes.visible.public_notes.exclude_source(Account.current.helpdesk_sources.note_exclude_sources).newest_first.blank? then %>
    <h3 class="forum-title"><%= t('conversation') %></h3>
    <div class="requestCnt request-conversation">
      <%= render :partial => '/helpdesk/tickets/note', :collection => @ticket.notes.visible.public_notes.exclude_source(Account.current.helpdesk_sources.note_exclude_sources) %>
    </div>
    <script type="text/javascript">jQuery("a.delete").hide();</script>
  <% end %>
</div>

