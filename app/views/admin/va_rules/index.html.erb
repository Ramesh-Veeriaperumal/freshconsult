<% content_for :helpcard do %>
  <%= render :partial => "helpnote" %>
<% end %>
<div id="cust-list" class="list-page">
  <div class="list-page-header" >
    <div class="row-fluid">
      <div class="span6"><h3 class="title"><%=t('dispatch.dispatch_rules')%></h3></div>
       <div class="span6 pull-right pagination-right header_buttons align-right" >
        <%= link_to t('reorder'),'#', :id => "va_rules_reorder_button", :class => "btn" if(@va_rules.active.size > 1) %>
        <%= (link_to t('dispatch.new_rule'), new_admin_va_rule_path, :class => "btn btn-primary") %>
      </div>
    </div>
  </div>

 <% if current_account.cascade_dispatcher_enabled? %>
  <div class="row-fluid list-page-subheader">
    <span class="vertical-alignment">
      <i class="ficon-arrow-down-2 fsize-18"></i>
    </span>
    <span class="vertical-alignment"><%= t('dispatch.cascade_text') %> &nbsp;</span>
      <%= form_for @va_rules, :url => { :controller => "va_rules", :action => "toggle_cascade" }, :html => { :id => "dispatcher_cascade" , :class => "vertical-alignment"} do |f| %>

        <%= select "cascade_dispatcher", "cascade", VaRule.cascade_dispatcher_option, 
                         {:selected => 1 }, { :class => "select2 select2-flat span12", :id => "cascade_dispatcher" } %>
      <% end %>
      <span id="cascade_loader" class="vertical-alignment loading-tiny loading-left"></span>
  </div>
 <% else %>
  <div class="row-fluid list-page-subheader">
    <span class="vertical-alignment">
      <i class="ficon-arrow-down-2 fsize-18"<></i>
    </span>
    <span class="vertical-alignment"><%= t('dispatch.info_help').html_safe %></span>
  </div>
 <% end %>

  <div>
  <%= render :partial => "/shared/reorder_list", :locals => { 
      :items => @va_rules.active,  
      :action_url => reorder_admin_va_rules_path, 
      :title => :name, :container_id => "va_rules_sort", 
      :reorder_id => "va_rules_reorder_button", :list_id => "va_rules_list"} %>
  </div>

  <div class="list-page-body va_rule-index" id="va_rules_list">
    <table class="table table-striped">
      <% (@va_rules.active + @va_rules.inactive).each do |va_rule| %>
        <tr id=<%= dom_id(va_rule) %>>
          <td <%= "class='va_rule_disabled custom-tip' data-tip-classes = 'va-rule-index-tooltip' title='#{t('admin.va_rules.disabled')}'".html_safe if va_rule.any_restricted_actions? %>>
            <%= form_for va_rule, :url => activate_deactivate_admin_va_rule_path(va_rule) do |f| %>
              <%= f.check_box :active, va_rule_checkbox_options(va_rule), true, false  %>
            <% end %>
          </td>
          <td>
            <strong>
              <%= link_to(h(va_rule.name), edit_admin_va_rule_path(va_rule),va_rule_link_options(va_rule)) %>
            </strong><br/>
            <span class="muted"><%= h va_rule.description %></span>
          </td>
          <td>
          <% if !va_rule.any_restricted_actions? %>
            <div class="item_actions" align="right">
              <%= link_to(t('clone'), clone_rule_admin_va_rule_path(va_rule), :class => "btn btn-mini")%>
              <%= link_to(t('edit'), edit_admin_va_rule_path(va_rule), :class => "btn btn-mini") %>
              <%= link_to "<i class='icon-trash'></i>".html_safe, admin_va_rule_path(va_rule), :confirm => t('confirm_delete_message', :human_name => t('.human_name')), :method => :delete, :class => "btn btn-mini" %>
            </div>
          <% end %>
          </td>
        </tr>
      <% end %>
    </table>  
  </div>

</div>

<%= javascript_tag do %>
  (function($){
     var show_sandbox_notification = <%= show_sandbox_notification %>
     var notification_message = '<%=t("sandbox.sandbox_notification_for_rules").html_safe %>';
     if(show_sandbox_notification && jQuery('#va_rules_list table tbody tr').length >= 10){
             jQuery("#noticeajax").html(notification_message).show();
             closeableFlash('#noticeajax');
     }
    $('.activate').itoggle({
      checkedLabel: "<%= t('plain_on') %>",
      uncheckedLabel: "<%= t('plain_off') %>"
    }).change(function() {
      $(this).parent().submit();  
    });
  })(jQuery)
<% end %>

<script type="text/javascript">
jQuery(document).ready(function() {
  selected_dispatchr_method = 
  jQuery('#cascade_dispatcher').select2({
    minimumResultsForSearch: 1000
  });
});

jQuery('#cascade_dispatcher').change(function() {
    var cascade_value = jQuery('#cascade_dispatcher').val();

    new Ajax.Request('/admin/va_rules/toggle_cascade', 
                     { parameters: {cascade_dispatcher: cascade_value},
                        onLoading: function() {
                          jQuery("#cascade_loader").addClass('sloading');
                        },
                        onSuccess: function(response) {
                          jQuery("#cascade_loader").removeClass('sloading');
                          //nothing doing here.
                          }

                       });
    return false;
  });
</script>


