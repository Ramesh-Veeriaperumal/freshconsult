<%= content_tag(:label, t('mailbox.email_system'), :class => "control-label") %>
<div class="controls row-fluid">
  <%
    serverProfileoptions = Mailbox::MAILBOX_SERVER_PROFILES.map {
      |m| "<option value='#{m[0]}' data-server='#{m[4]}' data-imap-port='#{m[5]}' data-smtp-port='#{m[6]}' data-smtp-alert='#{m[2]}' >#{m[1]}</option>"
    }
  %>
  <%= select_tag("imap[mailbox]", serverProfileoptions.to_s.html_safe, :class => "select2 input-xlarge" ) %>
</div>

</br>
<div class="seperator"></div>

<div class="control-group">
  <div class="row-fluid">
    <%= content_tag(:label, t('mailbox.incoming_mail_settings'), :class => "lead") %>
    <div class="control-group">
      <%= content_tag(:label, t('mailbox.incoming_mail_server') , :class => "control-label") %>
      <div class="controls">
        <div class="form-inline">
          <%= mailbox.text_field :imap_server_name, :class => "text input-xlarge", :placeholder => t('mailbox.imap_server_name')%>
          <%= mailbox.text_field :imap_port, :class => "text port input-small", :placeholder => t('mailbox.imap_port')%>
          <label for="email_config_mailbox_attributes_imap_use_ssl" class="checkbox pl5 pb0">
            <%= check_box "email_config[mailbox_attributes]", "imap_use_ssl", {:checked => "checked"}, "true", "false" %>
            <%=t('mailbox.use_ssl')%>
          </label>
        </div>
        <%= content_tag(:div, t('mailbox.imap_server_info'), :class => "info-data") %>
        </br>
        <label for="email_config_mailbox_attributes_imap_delete_from_server" class="checkbox">
          <%= check_box("email_config[mailbox_attributes]", 'imap_delete_from_server', options = { :checked => 0, :class => "pull-left" }, checked_value = "1", unchecked_value = "0") %>
          <%= t('mailbox.delete_from_server') %>
      </label>
    </div>
  </div>

    <div class="control-group">
      <%= content_tag(:label, t('mailbox.authentication'), :class => "control-label") %>
      <div class="controls">
        <%= select_tag("email_config[mailbox_attributes][imap_authentication]", options_for_select(Mailbox::AUTHENTICATION_OPTIONS), :class => "select2 input-large") %>
        <div class="form-inline mt15">
          <div class="input-prepend tooltip disabled" title="<%= t('mailbox.imap_user_name_tooltip')%>" >
            <span class="add-on"><i class="mailbox-username"></i></span>
            <%= text_field_tag "imap_user_name", "", :class => "text credentials input-large", :autocomplete => "off", :placeholder => t('mailbox.user_name'), :rel=> "username", :disabled => true %>
          </div>
          <%= mailbox.hidden_field :imap_user_name, :id => "hidden_imap_user_name" %>
          <div class="input-prepend ml5">
            <span class="add-on"><i class="mailbox-password"></i></span>
            <%= mailbox.password_field :imap_password, :class => "credentials input-large", :placeholder => t('mailbox.password') %>
          </div>
          <%= mailbox.hidden_field :imap_folder, :value => "inbox" %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="control-group">
  <%= content_tag(:label, t('mailbox.outgoing_mail_settings'), :class => "lead") %>
  <div class="smtp_limit_alert"> <%= t('mailbox.smtp_alert_gmail').html_safe %> </div>
  <div>
    <%= content_tag(:label, t('mailbox.outgoing_mail_server') , :class => "control-label") %>
    <div class="controls">
      <div class="form-inline">
        <%= mailbox.text_field :smtp_server_name, :class => "text input-xlarge", :placeholder => t('mailbox.smtp_server_name')%>
        <%= mailbox.text_field :smtp_port, :class => "text port input-small", :placeholder => t('mailbox.smtp_port') %>
        <label for="email_config_mailbox_attributes_smtp_use_ssl" class="checkbox pl5 pb0">
          <%= check_box "email_config[mailbox_attributes]", "smtp_use_ssl", {:checked => "checked"}, "true", "false" %>
          <%=t('mailbox.use_ssl_tls')%>
        </label>
      </div>
      <%= content_tag(:div, t('mailbox.smtp_server_info'), :class => "info-data") %>
    </div>
    </br>

      <%= content_tag(:label, t('mailbox.authentication'), :class => "control-label") %>
      <div class="controls">
        <%= select_tag("email_config[mailbox_attributes][smtp_authentication]", options_for_select(Mailbox::AUTHENTICATION_OPTIONS[0..1]), :class => "select2 input-large") %>
        <div class="form-inline mt15">
          <div class="input-prepend">
            <span class="add-on"><i class="mailbox-username"></i></span>
            <%= mailbox.text_field :smtp_user_name, :class => "email-icon text credentials input-large", :autocomplete => "off", :placeholder => t('mailbox.user_name'), :rel=> "username" %>
          </div>
          <div class="input-prepend ml5">
            <span class="add-on"><i class="mailbox-password"></i></span>
            <%= mailbox.password_field :smtp_password, :class => "password-icon text credentials input-large", :placeholder => t('mailbox.password')%>
          </div>
        </div>
      </div>
  </div>
</div>

<% content_for :pagefixed do -%>
  <% javascript_tag do %>

    jQuery(document).ready(function(){
      jQuery("#imap_mailbox")
        .bind("change", function(ev){ 
          jQuery(".smtp_limit_alert").html(jQuery("#imap_mailbox").find(":selected").data('smtpAlert'));
          _data = jQuery(this).find(":selected").data();
          ['imap', 'smtp'].each(function(name){

            _id = "#email_config_mailbox_attributes_";

            if (_data.server != ""){
              jQuery(_id + name + '_server_name').val(name + "." + _data.server);
            }
            else {
              jQuery(_id + name + '_server_name').val(null).attr('placeholder', ((name == "imap") ? 'IMAP Server Name' : 'SMTP Server Name'));
            }

            if (_data.server == "gmail.com"){
              jQuery("#email_config_mailbox_attributes_imap_use_ssl").attr("disabled", "disabled").val(true);
              jQuery('input[name="email_config[mailbox_attributes][imap_use_ssl]"][type="hidden"]').val(true);
            } else {
              jQuery("#email_config_mailbox_attributes_imap_use_ssl").removeAttr('disabled');
              jQuery('input[name="email_config[mailbox_attributes][imap_use_ssl]"][type="hidden"]').val(false);
            }

            jQuery(_id + name + '_port').val( (name == "imap") ? _data.imapPort : _data.smtpPort );
            jQuery(_id + name + '_use_ssl').val( true ).attr('checked', true);
          });
        })
        .trigger("change");
    });
  <% end %>
<% end %>
