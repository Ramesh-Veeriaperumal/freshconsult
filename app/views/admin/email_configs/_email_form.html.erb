<% javascript_tag do %>
	construct_reply_url = function(to_email){
		email_split  = to_email.split("@");
		email_name   = email_split[0]||'';
		email_domain = email_split[1]||'';
		if(email_domain != ''){
			email_domain = email_domain.split(".")[0];
		}		
		account_name = "<%=current_account.full_domain%>".toLowerCase();
		reply_email  = "@"+account_name;
		
		
		if(email_domain.toLowerCase() == account_name){
			reply_email = email_name + reply_email;		
		}
		else{
			reply_email = email_domain + email_name + reply_email;
		}
		return reply_email;
	}
	
	
	
	jQuery(document).ready(function(){
		jQuery("#reply_to_id").bind('change keyup', 
											function(ev){			
												reply_email = construct_reply_url(this.value);
												jQuery("#div_reply_email").text(reply_email);
												jQuery("#hidden_reply_to").val(reply_email);
											});
	});
<% end -%>


<% 
	type_check = (type == "edit")
	form_for :email_config, @email_config, 
				:url => (!type_check) ? (admin_email_configs_path) : (admin_email_config_path), 
			    :html => { :method => (!type_check) ? (:post) : (:put) } do |f|
%>
<h3 class="title">
	<% if (type == "edit") %>
		Edit email
	<% else %>
		Add new email
	<% end %>
</h3>  
<ul class="ui-form">
	<li>
			<label>Enter your support email eg. support@yourcompany.com </label>
			<span class"info_data">This is also your Reply-to address</span>
			<%= f.text_field :reply_email, :class => "required text", :id => "reply_to_id" %>						
	</li>
	<li>	
			<label>Forward your emails to</label>
			<div id="div_reply_email" class="email_info">
				<%= (type_check) ? @email_config.to_email : '&nbsp;' %>
			</div>
			<%= f.hidden_field :to_email, :id => "hidden_reply_to" %>
	</li>	
	<li>
			<label>Assign to Group</label>
			<span class="info_data">New tickets to this support email will get automatically assigned to a group </span>
			<%= collection_select(:email_config, :group_id, @groups, :id, :name, options = {:include_blank => "..."}) %>
	</li> 
</ul>
<div class="button-container">
	<div class="floatl">
		<%= link_to('Delete', admin_email_config_path(@email_config), :method => 'delete', :confirm => 'Are you sure you want to delete this email', :class => "uiButton" ) if (type == "edit" and !@email_config.primary_role) %>
	</div>
	<%= f.submit "Save", :class => "uiButton"  %>
	<%= link_to("Cancel", admin_email_configs_path, :class => "uiButton", :id => "email-form-cancel" )  %>
</div> 
<% end %>