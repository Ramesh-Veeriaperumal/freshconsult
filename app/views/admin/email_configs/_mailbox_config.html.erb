<%= javascript_tag do %>
  jQuery(document).ready(function(){
    jQuery("#EnableMailbox")
      .bind("change", function(ev){
        if(this.checked){
          jQuery("#CustomMailbox").slideDown(200);
          jQuery("#FreshdeskMailbox").slideUp(200);
        }else{
          jQuery("#CustomMailbox").slideUp(200);
        }
      })
      .trigger("change");

    jQuery("#DisableMailbox")
      .bind("change", function(ev){
        if(this.checked){
          jQuery("#FreshdeskMailbox").slideDown(200);
          jQuery("#CustomMailbox").slideUp(200);
        }else{
          jQuery("#FreshdeskMailbox").slideUp(200);
        }
      })
      .trigger("change");

    jQuery("#reply_to_id")
      .bind("change keyup", 
        function(ev){
          reply_email = this.value;
          if(this.value != ''){
            reply_email = construct_reply_url(this.value, "<%= current_account.full_domain %>");
          }
          jQuery("#div_reply_email").text(reply_email);
          jQuery("#hidden_reply_to").val(reply_email);
          jQuery("input[rel=username]").val(this.value);
          jQuery("#email_config_smtp_mailbox_attributes_user_name");
      })        

      if(<%= @smtp_mailbox.present? && @smtp_mailbox.new_record? %>) jQuery("#reply_to_id").trigger("change");

      <% if (@smtp_mailbox.present? && @smtp_mailbox.user_name) %>
        jQuery("#email_config_smtp_mailbox_attributes_user_name").val("<%= @smtp_mailbox.user_name%>")
      <% end %>

      jQuery("#email_config_smtp_mailbox_attributes_user_name")
        .bind("change keyup",
          function(ev){
            jQuery("#email_config_smtp_mailbox_attributes_domain").val(this.value.split('@')[1]);
        })
        .trigger("change")
        .blur(function(){ requireDomain(); });
  });

  mailbox_form = jQuery('<%= mailbox_form_id %>');
  
  mailbox_form.bind('submit', function(){
    if(jQuery("#DisableMailbox").is(':checked')) {
      var input = jQuery("<input>")
                     .attr("type", "hidden")
                     .attr("name", "email_config[imap_mailbox_attributes][_destroy]").val("1");
      mailbox_form.append(jQuery(input));
    }

    requireDomain();
  });

  mailbox_form.validate({
    submitHandler: function(form){
      if (jQuery("#EnableMailbox").is(':checked')){

        if(mailbox_form.attr('id') === "editEmailConfigForm"){
          mailbox_form.find("[name=_method]").val("post");
        }

        jQuery.ajax({
          url: '/admin/email_configs/validate_mailbox_details',
          type: 'POST',
          data: mailbox_form.serialize(),
          beforeSend: function(){
            mailbox_form.find("input[type=submit]").attr("disabled", "disabled");
            mailbox_form.find("input[type=submit]").val("<%= t('mailbox.verifying_mailbox_input') %>");
          },
          success: function(data){
            if(data.success){
              mailbox_form.find("input[type=submit]").val("<%= t('saving_draft') %>");
              if(jQuery("#EnableOutgoing").is(':checked')) {
                mailbox_form.find("#incoming_mailbox_settings").remove();
              }
              form.submit();
            }
            else{
              mailbox_form.find("input[type=submit]").removeAttr("disabled");
              mailbox_form.find("input[type=submit]").val("<%= t('save') %>");
              jQuery("#noticeajax").html(data.msg);
              jQuery("#noticeajax").show();
              closeableFlash('#noticeajax');
              jQuery(document).scrollTop(0);
            }
          }
        });
        if(mailbox_form.attr('id') === "editEmailConfigForm"){
          mailbox_form.find("[name=_method]").val("put");
        }
      }
      else{
        form.submit();
      }
    }
  });

	jQuery('#CustomMailbox input:text, #CustomMailbox input:password').each(function(e) {
    jQuery(this).rules('add', {
        required: {
            depends: function(element) {
                return (jQuery("#CustomMailbox").css("display") != "none")
            }
        }
    });
	});

  jQuery("input[name*='email_config[imap_mailbox_attributes][_destroy]']").on("change", function(){
    jQuery("#email_system").trigger("change");
    jQuery("#incoming_mailbox_settings").slideToggle(500);
    jQuery("#email_config_imap_mailbox_attributes_server_name, #email_config_imap_mailbox_attributes_port, #email_config_imap_mailbox_attributes_password").attr('disabled', jQuery("#EnableOutgoing").is(':checked'));
  });

  function requireDomain(){
    smtp_domain = jQuery("#email_config_smtp_mailbox_attributes_domain");
    if(smtp_domain.val() == "") {
      smtp_domain.addClass("required");
      smtp_domain.parent().parent().slideDown(300);
    }
  }
<% end %>