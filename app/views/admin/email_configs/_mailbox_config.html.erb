<% javascript_tag do %>
  jQuery(document).ready(function(){
    jQuery("#hidden_imap_user_name").val(jQuery("#reply_to_id").val());
    jQuery("#EnableMailbox")
      .bind("change", function(ev){
        if(this.checked){
          jQuery("#CustomMailbox").slideDown(200);
          jQuery("#FreshdeskMailbox").slideUp(200);
        }else{
          jQuery("#CustomMailbox").slideUp(200);
        }
      })
      .trigger("change");

    jQuery("#DisableMailbox")
      .bind("change", function(ev){
        if(this.checked){
          jQuery("#FreshdeskMailbox").slideDown(200);
          jQuery("#CustomMailbox").slideUp(200);
        }else{
          jQuery("#FreshdeskMailbox").slideUp(200);
        }
      })
      .trigger("change");

    jQuery("#reply_to_id")
      .bind("change keyup", 
        function(ev){
          reply_email = this.value;
          if(this.value != ''){
            reply_email = construct_reply_url(this.value, "<%= current_account.full_domain %>");
          }
          jQuery("#div_reply_email").text(reply_email);
          jQuery("#hidden_reply_to").val(reply_email);
          jQuery("input[rel=username]").val(this.value);
          jQuery("#hidden_imap_user_name").val(this.value);
      })        
  });

  mailbox_form = jQuery('<%= mailbox_form_id %>');
  mailbox_form.validate({
    submitHandler: function(form){
      if (jQuery("#EnableMailbox").is(':checked')){

        if(mailbox_form.attr('id') === "editEmailConfigForm"){
          mailbox_form.find("[name=_method]").val("post");
        }

        jQuery.ajax({
          url: '/admin/email_configs/validate_mailbox_details',
          type: 'POST',
          data: mailbox_form.serialize(),
          beforeSend: function(){
            mailbox_form.find("input[type=submit]").attr("disabled", "disabled");
            mailbox_form.find("input[type=submit]").val("<%= t('mailbox.verifying_mailbox_input') %>");
          },
          success: function(data){
            if(data.success){
              mailbox_form.find("input[type=submit]").val("<%= t('saving_draft') %>");
              form.submit();
            }
            else{
              mailbox_form.find("input[type=submit]").removeAttr("disabled");
              mailbox_form.find("input[type=submit]").val("<%= t('save') %>");
              jQuery("#noticeajax").html(data.msg);
              jQuery("#noticeajax").show();
              closeableFlash('#noticeajax');
              jQuery(document).scrollTop(0);
            }
          }
        });
        if(mailbox_form.attr('id') === "editEmailConfigForm"){
          mailbox_form.find("[name=_method]").val("put");
        }
      }
      else{
        form.submit();
      }
    }
  });

	jQuery('#CustomMailbox input:text, #CustomMailbox input:password').each(function(e) {
    jQuery(this).rules('add', {
        required: {
            depends: function(element) {
                return (jQuery("#CustomMailbox").css("display") != "none")
            }
        }
    });
	});
<% end %>