<% content_for :layoutType do%>single<% end %>
<%= javascript_include_tag "redactor/redactor.min.js" %>
<%= stylesheet_link_tag "redactor/css/redactor.css" %>
<% javascript_tag do %>
	var active_email_body = null;
	jQuery(document).ready(function(){
		var active_template = null;
		var active_link     = null;
		var notifyType =$H();
		var hideData=null;
		var editorName =null;
		jQuery("a.notify_check").bind("click", function(ev){
			//jQuery(active_template).hide();
			hideData = (jQuery(this).parents("tr").attr("notify_type"));
			var emailTr = jQuery(this).parents("tr").next();
			if(active_link != null && active_link == this){
				jQuery(active_template).hide(); 
				jQuery("#"+active_link.getAttribute("showdiv")).hide();
				active_link = null;
			}
			else{			
				jQuery(active_template).hide();	
				jQuery("#"+jQuery(active_link).attr("showdiv")).hide();
				jQuery('#place-dialog').hide();
				
				active_template = jQuery(emailTr).show(); 
				jQuery("#"+this.getAttribute("showdiv")).show();
				
				active_link = this;


				var template_name=jQuery("#"+active_link.getAttribute("showdiv")).get(0).id;
				var index =template_name.indexOf('_div');
				editorName=template_name.substring(0,index);
			
				jQuery("#"+editorName+"_"+hideData).redactor({autoformat: false,focus: true});
				active_email_body=jQuery("#"+editorName+"_"+hideData);
					
			}
		});
	jQuery("a.close_template").bind("click", function(ev){
			
			jQuery(active_link).parent().parent().next().find("textarea").each(function(index){
			var editorCache = $H();
			if(jQuery("#"+active_link.getAttribute("showdiv")).get(0).id == $(this).name+"_div_"+hideData)
			{
				editorCache[$(this).name]=jQuery("#"+editorName+"_"+hideData).getCode();
				notifyType[hideData]=editorCache;
			}
		});
		
			jQuery(active_template).hide();	
			jQuery("#"+jQuery(active_link).attr("showdiv")).hide();
			jQuery('#place-dialog').hide();
			hideData=null;
	});
		
	jQuery("a.reset_template").bind("click", function(ev){
      jQuery(this).prevAll("input[name$=_subject_template]")
        .val(jQuery(this).prevAll("input[name$=_subject_template_hid]").val());
			template = jQuery(this).prevAll("textarea.desc_info");
			hidname=editorName+"_"+hideData+"_hid";
			 

			jQuery("#"+editorName+"_"+hideData).setCode(jQuery(this).prevAll("input[name$="+hidname+"]").val());
			
		  agent_select = jQuery(this).find("select.customSelect");
		  jQuery.each(agent_select.children("options"), function(i, item){
    	     item.removeAttribute("selected");
		  });         
		  agent_select.val((agent_select.data('default')+"").split(","));		  
		  agent_select.trigger("liszt:updated");
	});


		
		jQuery("#Updateform").submit(function(){
			allNotificationsDom   = jQuery("tr.main_rows");
			var allNotifications  = $H();
			var notifyAgents = $H();
			var currentNotify	  = 0;
			jQuery.each(allNotificationsDom, function(index, item){
				var tempHash 	  = { requester_notification: 0,  agent_notification: 0, requester_subject_template: "", agent_subject_template: "", requester_template: "", agent_template: "" };
				currentNotify 	  = item.getAttribute("notify_type");
				jQuery.each(jQuery(item).find("input.checkbox"), function(index, checkItem){
					tempHash[checkItem.name] = (checkItem.checked)?1:0;		
				});
				
				jQuery.each(jQuery(item).next().find("input[name$=_subject_template]"), function(index, textItem){
					tempHash[textItem.name] = textItem.value;
				});
				
				jQuery.each(jQuery(item).next().find("textarea"), function(index, textareaItem){
					
				tempHash[textareaItem.name] = textareaItem.value;

					var template_data =notifyType[currentNotify];
					if(typeof template_data != 'undefined'){
						
						if(typeof template_data[textareaItem.name] != 'undefined'){
							tempHash[textareaItem.name] = template_data[textareaItem.name];
						}
			
					}
			
				});
				
				notifyAgents.set(currentNotify, jQuery("#notify_agents_"+currentNotify).val());
				allNotifications.set(currentNotify, tempHash);
			});
			jQuery("#AllNotification").val(allNotifications.toJSON()); 
			jQuery("#NotifyAgents").val(notifyAgents.toJSON());
		});


		jQuery('.link_placeholder').live("click", function(ev){
		    ev.preventDefault();
				active_email_body=jQuery("#"+editorName+"_"+hideData);
				jQuery("#"+editorName+"_"+hideData).live("click",function(){
			});
				jQuery('#place-dialog').slideDown();	

		});

		jQuery('input[type="text"]').live('blur',function(){
						active_email_body = jQuery("#"+editorName+"_"+hideData);
		});		
			
	});
<% end %>

<h3 class="title"><%=t('email_notifications.title')%></h3>
<div>
	<% form_for :update, @email_notifications, :url => { :action => "update" }, :html => { :method => :put, :id => "Updateform" } do |f| %>
	<%= f.hidden_field :notification_data, { :id => "AllNotification" } %>
	<%= f.hidden_field :notifyagents_data, { :id => "NotifyAgents" } %>
	<div class="grid">
		<table border="0">
			<tr>
				<th><%=t('email_notifications.event')%></th>
				<th><%=t('email_notifications.requestor_notification')%></th>
				<th><%=t('email_notifications.agent_notification')%></th>
			</tr>
			<% @notifications.each do |item| %>
			<% data = item[:obj] %>
			<tr class="main_rows" notify_type=<%= data.id %>>
				<td><%= item[:type] %> </td>
				<td>
					<% if (item[:requester])  %>
						<% if (item[:userSelect] == false )  
						   	 checkStyle = "visibility:hidden" 
						   end %>
						<input type="checkbox" style="<%=checkStyle%>" name="requester_notification" class="checkbox requester" <%= (data.requester_notification) ? "checked" : "" %> />
						<a href="javascript:void(0)" showdiv='<%= "requester_template_div_#{data.id}" %>' class="notify_check"><%=t('email_notifications.customize_email')%> </a>
					<% end %>
					&nbsp;
				</td>
				<td>
					<% if (item[:agent])  %>
						<% if (item[:agentSelect] == false )  
						   	 checkStyle = "visibility:hidden" 
						   end %>
						<input type="checkbox" style="<%=checkStyle%>" name="agent_notification" class="checkbox agent" <%= (data.agent_notification) ? "checked" : "" %> />
						<a href="javascript:void(0)" showdiv='<%= "agent_template_div_#{data.id}" %>' class="notify_check"><%=t('email_notifications.customize_email')%></a>
					<% end %>
					&nbsp;					
				</td>				
			</tr>
			<tr style="display:none;" notify_type=<%= data.id %>>
				<td colspan="3">
					<div class="requester_div" style="display:none;" id='<%="requester_template_div_#{data.id}" %>'>
						<%if item[:placeholder] != false %>
							<a href="#" class="link_placeholder slim-button"><%=t('email_notifications.insert_placeholder')%> &raquo;</a>
						<% end %>
						<h4 class="title"><%=t('email_notifications.modify_requester_template')%></h4> 
            <input type="hidden" name="requester_subject_template_hid" value="<%= h ("#{data.requester_subject_template}") %>" />              
						<label><%= t('email_notifications.subject') %></label>
						
						<input type="text" name="requester_subject_template" class="text" value="<%= h ("#{data.requester_subject_template}") %>" />
						<%if data[:notification_type] != EmailNotification::USER_ACTIVATION and data[:notification_type] != EmailNotification::PASSWORD_RESET %>
							<div class="info-data"><%=t('email_notifications.do_not_delete_ticket_id_from_subject')%></div>
						<%end%>						
						
						<label><%= t('message') %></label>
						<input type="hidden" value="<%= h ("#{data.requester_template}") %>" name="<%= "requester_template_#{data.id}_hid"%>"/>
						
						<textarea name="requester_template" class="desc_info requesteremail" id="<%="requester_template_#{data.id}"%>" ><%=sanitize( h("#{data.requester_template}"), :tags => %w(p span strong))%></textarea>
						<div class="seperator"></div>						
						<a href="javascript:void(0)" class="button close_template"><%=t('done')%></a>
						<a href="javascript:void(0)" class="button reset_template"><%=t('reset')%></a>
					</div>
					<div class="agent_div" style="display:none;" id='<%="agent_template_div_#{data.id}"%>'>
						<%if item[:placeholder] != false %>
							<a href="#" class="link_placeholder slim-button"><%=t('email_notifications.insert_placeholder')%> &raquo;</a>
						<% end %>
						<h4 class="title"><%=t('email_notifications.modify_agent_template')%></h4>
						 
						<input type="hidden" name="agent_subject_template_hid" value="<%= h ("#{data.agent_subject_template}") %>" />						    
						<label><%= t('email_notifications.subject') %></label>
						<input type="text" class="text" name="agent_subject_template" value="<%= h ("#{data.agent_subject_template}") %>" />						
						<%if data[:notification_type] != EmailNotification::USER_ACTIVATION and data[:notification_type] != EmailNotification::PASSWORD_RESET %>
							<div class="info-data"><%=t('email_notifications.do_not_delete_ticket_id_from_subject')%></div>
						<%end%>
											     
						<label><%= t('message') %></label>
						<input type="hidden" value="<%= h ("#{data.agent_template}") %>" name="<%= "agent_template_#{data.id}_hid"%>"/>
						<textarea name="agent_template" class="desc_info agentemail" id="<%= "agent_template_#{data.id}"%>"><%=sanitize( h("#{data.agent_template}"), :tags => %w(p span strong))%></textarea>
						     
						<% if data[:notification_type] == EmailNotification::NEW_TICKET %>
							<label><%= t('agent.title') %></label>         
							<%= select_tag "notify_agents_#{data.id}", options_for_select( @agent_hash[:options].map {|a| [a[1], a[0]] }, data.agents.collect {|a| a.id} ), { :multiple => true, "data-placeholder"=> t('email_notifications_agent_selection_msg'), :class => "customSelect", "data-default" => data.agents.collect{|a| a.id}.join(",") } %>
						<% end %>                                
						<div class="seperator"></div>
						
						<a href="javascript:void(0)" class="button close_template"><%=t('done')%></a>
						<a href="javascript:void(0)" class="button reset_template"><%=t('reset')%></a>
					</div> 
				</td>
			</tr>
			<% end %> 
			
		</table>
		<div class="button-container">
			<%= link_to "&larr; #{t('account.cancel')}", "/admin/home", { :class => "uiButton floatl" } %>
			<%= f.submit t('save'), { :class => "uiButton" } %>
		</div>
	</div>
	<% end %>
</div>

<% content_for :pagefixed do %>
	<%= render :partial => "shared/notification_placeholder" %>
<% end %>