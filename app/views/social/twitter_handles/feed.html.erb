<% content_for :sidebar do -%>
<%-end %>
<% first_search = nil %>
<% handle_id = nil %>
<h3 class="title">Twitter</h3>
<div class="page-list">
	<table class="tweet-table">
		<tr>
			<td class="left-panel">
			  <% @twitter_accounts.each do |twitter_handle| %>
			    <h4 class="title"><%= twitter_handle.product ? twitter_handle.product.name : current_account.main_portal.name %></h4>
			    <div class="intro">@<%= twitter_handle.screen_name %></div>
			    <ul class="search-keys" id="search_keys">
					  <% twitter_handle.search_keys.each do |search_key| %>
  					  <li>
  							<span class="icon"></span>
  							<% selected_class = (first_search.nil?) ? "selected" : "" %>
  							<% product_id = twitter_handle.product ? twitter_handle.product.id : nil %>
  							<%= link_to( h(search_key), "#", :class => "item_info #{selected_class}", :twitter_id => twitter_handle.id,:product_id => product_id, :title => h(search_key) ) %>
  							<% first_search ||= h(search_key)  %>
  							<% handle_id ||= twitter_handle.id %>
  						</li>
					  <% end %>
					</ul>
					<span class="seperator"></span>
			  <% end %>
			</td>
			<td>
				<div class="search-grey-box">
					<div class="live_search">
						<form action="#" name="search_twitter" id="search_twitter">
							<label class="overlabel" for="twittersearch"><%= t('social.twitter_handles.index.search_twitter') %></label>
							<input class="search" type="text" id="twittersearch" />
							<input type="submit" value="<%= t('social.twitter_handles.index.search') %>" class="uiButton" />
						</form>
					</div>
				</div>
				<div class="info-results" id="tweet_results_info" style="display:none;">
					<%= t('social.twitter_handles.index.results_for') %> <strong id="tweet_results_string"></strong>
				</div>
				<div class="info-highlight" id="tweet_no_search">
				 <%= t('social.twitter_handles.index.no_search_default') %>				  
				</div>
				<div class="info-highlight" id="tweet_noresults" style="display:none;">
				  <%= t('social.twitter_handles.index.no_tweet_results') %><strong id="tweet_noresults_string"></strong>.
				</div>
				<div id="twitter_results" class="list-group"></div>
				<script id="tweetTemplate" type="text/x-jquery-tmpl">
				  <div class="list-item" id="TWEET_DIV_${id_str}" data-tweet-id="${id_str}">
						<div class="preview-pic">
							<img src="${user.profile_image_url}" />
						</div>
						<a href="http://twitter.com/${user.screen_name}" target="_blank" class="username">${user.screen_name}</a>
						<div class="primary-text autolink">${text}</div>
						<div class="info-data">
						  <div class="floatr">
						    <span class="item_actions">
                <% if privilege?(:reply_ticket) %>
						      <a href="#" data-user="${user.screen_name}" class="button reply_button">
						        <%= t('social.twitter_handles.index.reply') %>
					        </a>
                <% end %>
  						    <a href="#" data-text="${text}" data-user="${user.screen_name}" data-id="${id_str}" 
                          data-img-url="${user.profile_image_url}" class="button convert_as_ticket">
  							    <%= t('social.twitter_handles.index.convert_to_ticket') %>
  						    </a>
  						  </span>
						    <a href="#" class="button goto_ticket" style="display:none;" target="_blank">
						      <%= t('social.twitter_handles.index.go_to_ticket') %>
						    </a>
						  </div>
							<span class="prettydate" title="${created_at}">${humaneDate(new Date(created_at))}</span>
						</div>
					</div>
				</script>
				<div class="more_results">
					<a id="moreTweets" style="visibility:hidden;" href="javascript: jQuery('#twitter_results').tweetfeed('nextpage')" class="uiButton"><%= t('social.twitter_handles.index.show_more_results') %></a>
				</div>
				</div>
			</td>
		</tr>
	</table>
</div>
<% javascript_tag do -%>
  function check_tweets_with_tickets( update_div ){
    var tweet_ids = [];
    jQuery.each(update_div, function(index, item){
      tweet_ids.push(item.getAttribute("data-tweet-id"));
    })
    data = { tweet_ids : tweet_ids.toString() };
    jQuery.ajax({ 
        url: "<%= tweet_exists_social_twitters_url %>",
        dataType: 'json',
        data: data,
        success: function(data){ 
          try{
            $H(data).each(function(item){            
              tweet_converted_to_ticket(item[0], item[1]);            
            });
          }catch(e){}
        }
    });
  }
  function tweet_converted_to_ticket( tweet_id, ticket_id ){ 
    jQuery("#TWEET_DIV_"+tweet_id)
	    .addClass("tweet_converted")
	    .find(".goto_ticket")
			.show()
	    .attr("href", "<%= helpdesk_tickets_url %>/"+ticket_id);
  } 
<%- end %>

<% javascript_tag do -%>
  var current_product_id = <%= @twitter_accounts.first.product ? @twitter_accounts.first.product.id : 0 %> ;
  var current_twitter_id = <%= @twitter_accounts.first.id %>;
  var feed = null;
      
	function initTweetFeed(query,twitter_handle){
	  jQuery("#tweet_no_search").hide();
		feed = jQuery("#twitter_results").tweetfeed({ 
                    "query"       : query, 
                    "searchurl"   : 'twitter_search',
                    "twitter_handle": twitter_handle,
                    "templateid"  : "#tweetTemplate",
                    onbeforeload  : function(setting){
                      jQuery("#tweet_results_info").hide();
                      jQuery("#tweet_noresults").hide();
                      jQuery("#moreTweets").css("visibility", "hidden");
                    },
                    onafterload   : function(setting, hasresults, update_div){
                      if(hasresults){										  
                        jQuery("#tweet_results_info").show();
                        jQuery("#tweet_results_string").html(setting.query);
                        jQuery("#moreTweets").css("visibility", "visible"); 
                      }else{
                        jQuery("#tweet_noresults").show();
                        jQuery("#tweet_noresults_string").html(setting.query);
                      }										
                      check_tweets_with_tickets( update_div );
                    }
                  });

     setInterval(function(){ jQuery("#twitter_results span.prettydate").humaneDates(); }, 60000);
	}
<%- end %>
<% content_for :onload_script do -%>
  <% unless first_search.blank? %>
    initTweetFeed("<%= first_search %>",<%=handle_id%>);
  <% end %>   
	jQuery("#search_keys .item_info")
			.click(function(e){
			        e.preventDefault();
			        jQuery("#search_keys .item_info").removeClass("selected");
			        jQuery(this).addClass("selected");
			        jQuery('#twittersearch').val(jQuery.trim(this.title)).trigger("focus");
			        current_product_id = this.getAttribute("product_id");
			        current_twitter_id = this.getAttribute("twitter_id"); 
			        jQuery("#search_twitter").trigger("submit");
						});
						
	jQuery("#search_twitter")
			.submit(function(){
			  if(!feed){
			    initTweetFeed(jQuery('#twittersearch').val(),current_twitter_id);
			  }else{  
				  jQuery('#twitter_results').tweetfeed('search_query', jQuery('#twittersearch').val(),current_twitter_id);
			  }
				return false;
			});
			
	jQuery("#twittersearch")
	  .change(function(){
	    current_product_id = null;
	    current_twitter_id = 0;
	  });
			
	jQuery("#twitter_results a.reply_button")
	  .live("click", function(e){
	    e.preventDefault();   
	     
	    var user = jQuery(this).data("user");
	    jQuery("#twitter_handle").val(current_twitter_id);
	    jQuery("#tweet_form").dialog({  modal:true, width:'600px', height:'auto', position:'top',
                                      title: "Reply to @" + user, resizable: false, draggable: false });

	    jQuery("#tweet_text_area").val("@"+user+" ").trigger("focus");	  
	    jQuery('#SendTweetCounter').html(140 - jQuery.trim($('tweet_text_area').value.length));
	  });
	 
			
	jQuery("#twitter_results a.convert_as_ticket")
	  .live("click", function(e){
	    e.preventDefault(); 
	    var screen_name = this.getAttribute("data-user"),
	        tweet_text  = this.getAttribute("data-text"), 
          image_url   = { "url" : this.getAttribute("data-img-url")},
	        json_data   = { "subject"          : screen_name + ' - ' + tweet_text,
	                        "product_id"       : current_product_id, 
	                        "twitter_id"       : screen_name,
	                        "tweet_attributes" : { "tweet_id": this.getAttribute("data-id"),  
	                        						"twitter_handle_id": jQuery("a.item_info.selected").attr("twitter_id")   },
	                        "ticket_body_attributes" : { "description" : tweet_text }};
                        					
      link = jQuery(this);
       
      //Disable the button to avoid multiple clicks
      link.addClass("disabled");
       
      jQuery.ajax({
      	type: 'POST',
      	url : 'create_twicket',
      	data: {	helpdesk_tickets: json_data , profile_image : image_url },
      	datatype:'json',
      	success: function(data){
          //Enable the button again
          link.removeClass("disabled");
        }
      });
	  });

  jQuery('#form_tweet').validate();
  jQuery('#tweet_text_area').NobleCount('#SendTweetCounter', { on_negative : "error", in_dom: true }); 	  
<%- end %> 

<div id="tweet_form" style="display:none;">  
  <% form_remote_tag :url => { :action => "send_tweet" }, :html => { :class => "uniForm", :id => "form_tweet" } do %>
  <div class="dialog-special">
   <div class="content">
    <table>
      <tr>
        <td width="120px">
          <%= t('social.twitter_handles.index.from') %>
        </td>
        <td>
          <%= select_tag :twitter_handle, options_from_collection_for_select(current_account.twitter_handles, :id, :screen_name) %>
        </td>
   	  </tr>				
	    <tr>
	      <td>
	        Tweet:
	      </td>
        <td>
	        <%= text_area "tweet", :body, { :class => 'required tweet auto-height', :id => 'tweet_text_area', :rows => "3" } %>
	        <div class="info-data">
	          <strong><%= t('social.twitter_handles.index.note_title') %></strong><%= t('social.twitter_handles.index.note') %>
          </div>
	      </td>
	    </tr>
    </table>  
   </div>
  </div>  
  <div class="button-container">  
    <span class="tweet-counter" id="SendTweetCounter">140</span>   
    <%= submit_tag "Tweet", :class => "uiButton" %>
  </div>
  <% end %>
</div>