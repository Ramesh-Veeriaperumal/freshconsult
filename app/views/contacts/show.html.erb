<% content_for :onload_script do %>
	tagsOptions = {
		'add' : '<%= t("add_tags") %>',
		'edit' : '<%= t("edit_tags") %>'
	}
	var MAX_TAG_LENGTH_MSG = "<%= I18n.t('helpdesk.tickets.show.max_tag_length_msg') %>";
<% end %>

<!-- hack for making the following script work even though custom apps might throw javascript error -->
<script type="text/javascript">
	window.ContactDetailsTabLoader = window.ContactDetailsTabLoader || {};
	(function ($) {
		window.ContactDetailsTabLoader.switchConversationView = function (element, tab) {
	    $('.conv-menu .sub-info').text(element.text());

	    //Load content through ajax
	    var url = element.data("url");
	    var href = element.attr("href");
	    var pane = element;
	    $(href).text("Loading...");
	    $(href).load(url, function (result) {
        if (tab) {
          pane.tab('show');
        }
	    });
	  }
	})(window.jQuery);

  window.jQuery(document).ready(function () {
    // Load the first tab on pageload
    let switcher = window.ContactDetailsTabLoader;
    if(window.jQuery("#conv_all-tab").length === 0) {
      switcher.switchConversationView(window.jQuery(".conv-title .sub-info"), false);
    } else {
      switcher.switchConversationView(window.jQuery("#conv_all-tab"), true);
    }
  });

  window.jQuery('body').on('click.contact-view', '.dropdown-menu .item', function(e) {
		e.preventDefault();
		let switcher = window.ContactDetailsTabLoader;
		switcher.switchConversationView(window.jQuery(this), true);
	});
</script>

<div class='page-header-sticky' rel='sticky' id='contactHeaderSticky'>
	<div class='sticky-header-wrapper'>
		<h3 class='lead pull-left'> 
			<%= link_to t('contacts.title'), '/contacts', :'data-pjax' => "#body-container" %> 
			<span class='contact-name ellipsis'> / <%= h(@user.display_name) %></span>
		</h3>
		<% unless @user.deleted? %>
			<div class="btn-group pull-right">
				<%= link_to t('assume_identity_button'), assume_identity_user_path(@user),{
											:class => "btn"
										} if is_allowed_to_assume?(@user) and !current_account.euc_hide_agent_metrics_enabled? %>
				
				<% if privilege?(:admin_tasks) and @user.allow_password_update?%>
			    <%= link_to(t('change_password').html_safe, change_password_contact_path(@user), {:class => "btn", :'data-pjax' => "#body-container"}) %>
      	<% end %>	
	      			<%  if privilege?(:manage_users) and @user.has_email? and !@user.blocked? and !@user.helpdesk_agent?  %>
					<% if current_account.occasional_agent_enabled?%>
						<%= link_to t('contacts.info2'), '#', {
													:class => "btn drop-toggle",
													"data-toggle" => "dropdown"
												}%>
					<% else %>
						<%= link_to( t('contacts.info2'), {:action => :make_agent, :id => @user.id},  :class => "btn", :method => :put, :confirm => t('contacts.convert_note'), 'data-domhelper-name' => 'convert-agent-fulltime' )%>
					<% end %>
				<% end %>
				<%= link_to(t('edit'), edit_contact_path(@user),{
											:class => "btn", 
											:'data-pjax' => "#body-container"
										}) if privilege?(:manage_contacts) and !@user.deleted? and !@user.spam? and !@user.blocked? %>
				
				
				<% if privilege?(:manage_users) %>
					<% if @user.has_email? and !@user.blocked? and current_account.occasional_agent_enabled?%>
						<ul class="dropdown-menu pull-right" role="menu">
							<li><%= link_to( t('contacts.convert_fulltime'), { :action => :make_agent, :id => @user.id},:method => :put, :confirm => t('contacts.convert_note'), 'data-domhelper-name' => 'convert-agent-fulltime' )%></li>
							<li><%= link_to( t('contacts.convert_occasional'), { :action => :make_occasional_agent, :id => @user.id}, :method => :put, :confirm => t('contacts.convert_note'), 'data-domhelper-name' => 'convert-agent-occasional' ) %></li>
						</ul>
					<% end %>
				<% end %>
				<% if privilege?(:manage_contacts) %>
					<%= link_to t('ticket.merge_btn'), new_contact_merge_path({:parent_user => @user.id }), :title => t('merge_contacts.merge_contact'), :class => "btn last", "data-width" => "800", :rel => "freshdialog", "data-target" => "#contact-mergebox", "data-template-footer" => "" unless (@merged_user or @user.deleted?)%>
				<% end %>

				<% if privilege?(:delete_contact) and @user != current_user and 
											!@user.deleted? and !@user.spam? and !@user.blocked? %>
					<%= link_to("<i class='icon-trash'></i>".html_safe, "/contacts/#{@user.id}", 
												:method => 'delete', 
												:class => "btn hide",
												:id => 'delete_customer')  %>
					<button 
						class="btn"
						data-target="#customer-delete-confirmation" 
							rel="freshdialog" 
							title="<%= t('contacts.delete_contact')%>"
							data-submit-label="<%= t('confirm') %>"
							data-submit-class="btn btn-primary"
							data-width="500px"
							data-close-label="<%= t('cancel') %>">
							<i class='icon-trash'></i>
					</button>
				<% end %>
			</div>
		<% end %>
	</div>
</div>
<div class="contact-show-wrapper">
	<div class='contact-show'>
		<div class='contact-info-fields'>
			<div class='contact-info-fields-content'>
				<%= user_avatar(@user, :medium, "profile_pic avatar-pic",{:width => "120px"}) %>
				<div class="user-info pt10 text-center">
					<h3 class="lead break-word mb5"><%= h(@user.display_name) %></h3>
					<% unless @user.job_title.blank? %>
						<div class="break-word user-job-title" title="<%= h @user.job_title %>">
					   		<%= h @user.job_title %>
					   	</div>
					<% end %>
					<%= render :partial => "helpdesk/tickets/components/company_info", 
	                   :locals => { :company => @user.company,
	                                :companies => @selected_companies } unless @user.has_multiple_companies_feature? %>
         			</div>
				<ul class="show-fields">
					<%= render :partial => "helpdesk/tickets/components/company_info", 
	                   :locals => { :company => @user.company,
	                                :companies => @selected_companies } if @user.has_multiple_companies_feature? %>
					<% view_contact_fields.each do |field| %>
				    		<%=  render_as_list nil, field %>
				    	<% end %>
				</ul>
			</div>

		</div>
		<div class="contact-edit-fields">
			<% if @user.deleted || (!@user.active? and @user.has_email?) || @user.blocked? %>
		  		<div class="info-highlight hide">
			        <% if privilege?(:delete_contact) %>
			  			<%= content_tag(:div, "#{ t('contacts.deleted_info_msg') } #{ link_to( t('contacts.restore'), { :action => :restore, :id => @user.id }, :method => :put ) }".html_safe) if @user.deleted and @user.parent.nil? and !@user.spam?%>
			  			<%= content_tag(:div, "#{t('merge_contacts.merged_with')}#{ link_to @merged_user.name, @merged_user}".html_safe) if @user.parent %>
			        <% end %>

			        <% if privilege?(:view_contacts) %>
			  			<%= content_tag(:div, "#{ t('contacts.emailnotverified') }   #{ link_to( t('contacts.send_activation'), send_invite_activation_path(@user), :method => :put ) } ".html_safe ) if !@user.active? and @user.has_email? and !@user.deleted and !@user.spam? and !@user.blocked? and @user.parent.nil?%>
			        <% end %>
		  			<%= content_tag(:div, "#{ t('contacts.blocked_message') } #{ link_to( t('unblock'), { :action => :unblock, :id => @user.id }, :method => :get ) }".html_safe) if @user.blocked? || @user.spam? %>
		  		</div>
			<% end %>
			<% unless @user.parent.present? %>
			<div id="updateForm" class="contact-edit-padding clearfix">
				<%= form_for @user,
					:url => {:controller => 'contacts', :action => 'update_description_and_tags'},
					:html => {
						:class => 'edit_user',
						:method => :put
					} do |f| %>
					<%= f.error_messages %>
					<h4 class="conv-title"><%=t('user.back_info')%></h4>
					<%= f.text_area :description, :class=> "sp_paragraph",:cols => 0,:rows => 0, :placeholder => t("contacts.form_placeholder.description") %>
					<%= f.hidden_field :id, :value => @user.id, :id => 'userid' %>
					<div class='tags-wrapper clearfix hide'>
						<%= f.text_field :tag_names, :rel =>"remote-tag", 'data-allow-create' => current_user.privilege?(:create_tags), :placeholder => t("contacts.form_placeholder.enter_tags"), :class=> "clear-left-margin"%>
					</div>
					<div id='tag-list'>
						<%= render :partial => "/helpdesk/tags/tag_list", :locals => {:tags => @user.tags, :add_tag => true} %>
					</div>
					<% if privilege?(:manage_contacts) %>
						<div class='clearfix'>
							<div class='error ajax-error pull-left'></div>
							<div class="pull-right hide form-save"> 
								<%= link_to t("cancel"), '#' , :class => "btn cancel-form" %>
								<%= f.submit t('save'), :class=>"btn btn-primary save-form" %>
							</div>
						</div>
					<% end %>
				<% end %>	
			</div>
			<% end %>
			<div class='contact-edit-padding'>
			<% if current_account.features?(:forums) or current_account.features_included?(:archive_tickets) %>
					<% list = [
						[
							t('contacts.conversations.all'), '#conv_all', false, {:id => 'conv_all-tab', :'data-url' => view_conversations_contact_path(@user, :type => "all"), :'data-hash-url' => false}
						],
						[
							t('contacts.conversations.tickets'), '#conv_tickets', false, {:id => 'conv_tickets-tab', :'data-url' => view_conversations_contact_path(@user, :type => "tickets"), :'data-hash-url' => false }
						],
						[
							t('contacts.conversations.forums'), '#conv_forums', false, {:id => 'conv_forums-tab', :'data-url' => view_conversations_contact_path(@user, :type => "forums"), :'data-hash-url' => false }
						],
					]
					
					if current_account.features_included?(:archive_tickets) 
						list << [ :divider ]
						list << [ t('contacts.conversations.archive_tickets'), '#conv_archive_tickets', false, {:id => 'conv_archive_tickets-tab', :'data-url' => view_conversations_contact_path(@user, :type => "archived_tickets"), :'data-hash-url' => false } ]
					end

					options = {'data-toggle' => 'tab', 'class' => 'item', 'ul_class' => 'tick'} %>
					<div data-tabs='tabs'>
						<ul role='tablist'>
							<li class="dropdown">
								<h1 class='conv-title conv-menu dropdown-toggle' data-toggle="dropdown">
									<span class='sub-info'><%= t('contacts.conversations.all') %></span>
									<span class='caret'></span>
								</h1>
								<%= dropdown_menu(list, options) %>
							</li>
						</ul>
					</div>
				<% else %>
          <h1 class='conv-title'>
            <span class='sub-info' data-url='<%= view_conversations_contact_path(@user, :type => "all") %>' href='#conv_all'><%= t('contacts.conversations.recent_tickets') %></span>
          </h1>
       <% end %>

				<div class="tab-content">
					
					<div class='tab-pane active' id='conv_all'>
						Loading...
					</div>
					
					<div class='tab-pane' id='conv_tickets'> 
					</div>
					
					<div class='tab-pane' id='conv_forums'> 
					</div>

					<% if current_account.features_included?(:archive_tickets) %>
						<div class='tab-pane' id='conv_archive_tickets'> 
						</div>
					<% end %>

				</div>
			</div>
		</div>
		<div class='contact-sidebar'>
			<div class='contact-sidebar-content' data-domhelper-name='contact-sidebar'>
				<%= render :partial => "/integrations/widgets/contacts_show_side_bar_widget", :locals => {:user => @user}%>
				<%= render :partial => "contacts/integrations/email_marketing_container" , :locals => {:contact => @user} %>
			</div>
		</div>
	</div>
</div>

<div class="hide" id="customer-delete-confirmation">
 	<p class="margin-bottom">
		<%= t('contacts.delete_confirmation') %>
	</p>
</div>

<script type="text/javascript">
	Fjax.current_page = 'contacts';
</script>