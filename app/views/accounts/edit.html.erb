<% content_for :helpcard do %>
<%= render :partial => "helpnote" %>
<% end %>
<%= javascript_tag do %>
	jQuery(document).ready(function(){
		if(<%=request.referrer and request.referrer.include?('email_notification')%>){
			jQuery("#supported_language_list").animateHighlight();
		}

		jQuery("#ResetColors").click(function(){
			jQuery("#HeaderColor").val("#252525").trigger("keyup");
			jQuery("#TabColor").val("#006063").trigger("keyup");
			jQuery("#BackgroundColor").val("#efefef").trigger("keyup");
		});
		jQuery("#account_main_portal_attributes_portal_url").blur(function(){
			input_url = jQuery('#account_main_portal_attributes_portal_url').val();
			protocol_exists = !(input_url.indexOf('http://') && input_url.indexOf('https://'));
			if(protocol_exists)
			{
			    get_index = input_url.indexOf("://");
			    result_url = input_url.substring(get_index+3);
			    jQuery('#account_main_portal_attributes_portal_url').val(result_url);
			}
		});

		jQuery("#account_forum_enabled").change(function() {
		    jQuery('#accounts_bitmap_forums').val(+this.checked);
		});

		jQuery("#account_submit").bind('click', function(ev){
				var language_flag = jQuery.inArray(jQuery("#account_main_portal_attributes_language").val() , jQuery("#account_account_additional_settings_attributes_supported_languages").val() );
				if(language_flag != -1 ){
				ev.preventDefault();
				alert("<%= t('account.same_language_alert')%>");
				}
    	});

    <% if @restricted_helpdesk %>
      jQuery(".domains-list").show();
      jQuery(".moderation-info").show();
    <% end %>

	});
<% end %>

<div id="admin-account-rebraning-page" class="rebrand-page">
	<%= form_for @account, :url => { :action => 'update' },
									:html => { :multipart => true ,
											   :method => :put,
											   "data-rebrand-form" => true,
											   :id => "edit_form", :class => "form-horizontal", :rel=> "validate"  } do |f| %>
	<h4 class="lead pb10"><%=t('account.helpdesk')%></h4>

	<%= error_messages_for :account %>

	<div class="row-fluid">
		<%= f.fields_for :main_portal do |portal| %>
			<div>
					<div class="fields">
						<div class="control-group">
							<%= portal.label :name, t('account.helpdesk_name_plain'), :class => "control-label" %>
							<div class="controls">
								<%= f.text_field :helpdesk_name, :value => @account.helpdesk_name, :class => "text required auto", :size => "50" %>
								<span class="help-block">
									<%= t(:'helpdesk.rebranding.name.info') %>
								</span>
							</div>
						</div>

						<%= render :partial => "languages", :locals => { :portal => portal } %>

						<%= f.fields_for :account_additional_settings do |settings| %>
							<div class="control-group">
								<%= settings.label :date_format, t('account.date_format'), :class => "control-label"  %>
								<div class="controls">

									<% options_for_dateformat = []%>
									<% 	AccountConstants::DATEFORMATS.invert.each do |format, val|
											options_for_dateformat.push([t("account.#{format}"),val])
										end
									%>
									<%= settings.select :date_format, options_for_dateformat, {}, {}%>
									<span id="sample_date"></span>
				 				</div>
							</div>
						<%end%>
						<div class="control-group">
							<%= f.label :time_zone, t('account.time_zone'), :class => "control-label"  %>
							<div class="controls">
								<%= f.time_zone_select :time_zone, ActiveSupport::TimeZone.all %>
						 		<% if current_account.time_zone_updation_running? %>
							 		<span class="help-block">
											<%= t(:'account.time_zone_updation') %>
									</span>
								<% end %>
					 		</div>
						</div>
						<div class="control-group">
							<%= f.label :ticket_display_id, "#{t('next')} Ticket ID #", :class => "control-label" %>
							<div class="controls">
								<%= f.text_field :ticket_display_id, :value => @ticket_display_id, :class => "text number auto", :size => "15" %>
								<div class="help-block"><%=t('account.info4')%></div>
					  		</div>
						</div>
						<% if current_account.reverse_notes_enabled? && current_account.falcon_ui_enabled?(current_user) %>
							<div class="control-group">
								<%= f.label :sort_conversations, t('account.sort_conversations.label'), :class => "control-label"  %>
								<div class="controls">
									<%= select_tag :oldest_on_top, options_for_select([[t("account.sort_conversations.option1"), false], [t("account.sort_conversations.option2"), true]], current_account.oldest_notes_first_enabled?) %>
									<div class="help-block"><%=t('account.sort_conversations.helpnote')%></div>
						 		</div>
							</div>
						<%end%>
						<% if current_account.subscription.forum_available_plan? %>
							<div class="control-group account-forum-toggle">
								<%= f.label :account_forums, t('account.forums_toggle.title') , :class => "control-label" %>
								<div class="controls">
		              <%= f.feature_check_box :forums, { :id => 'account_forum_enabled', :checked => current_account.features_included?(:forums) }, 1, 0 %>
		              <div class="help-block"><%= t('account.forums_toggle.helpnote') %></div>
		              <input type="hidden" name="account[bitmap_features][forums]" id="accounts_bitmap_forums" class="text disabled" />
		            </div>
	            </div>
            <% end %>

						<!-- freshdesk branding -->
					    <div class="control-group account-branding-toggle">
			              <%= f.label :account_branding, t('account.branding_toggle.title'), :class => "control-label" %>
			              <div class="controls">
			                <% unless current_account.subscription.trial_or_sprout_plan? %>
			                    <%= f.fields_for :bitmap_features do |bm| %>
			                        <%= bm.check_box :branding, {:id => 'account_branding_enabled', :checked => Account.current.branding_enabled?} %>
			                        <div class="help-block"><%= t('account.branding_toggle.helpnote') %></div>
			                    <% end %>

			                <% else %>
			                    <%= link_to "javascript:void(0)", :class => "btn" do %>
			                        <span class='ficon-lock locked'></span>
			                        <%=t('account.branding_toggle.disable_branding') %>
			                    <% end %>
			                    <% unless current_account.anonymous_account? %>
				                    <div class="branding-upgrade-message">
				                      <% options = (current_user.privilege?(:manage_account)) ? {:tag => :a, :href => subscription_url} : {:tag => :p} %>
				                      <%= content_tag(options[:tag], t('subscription.upgrade.message'), :href => options[:href]) %>
				                    </div>
				                  <% end %>
			                <% end %>
			              </div>
			            </div>

						<% if current_account.rebranding_enabled? && !(current_account.subscription.sprout_plan?)%>
								<div class="control-group">
									<label class="control-label"><%= t("admin.products.portal.agent_portal") %></label>
									<div class="controls">
										<%= link_to t("admin.products.portal.edit_branding"), '/a/admin/preferences',
										:class => "btn btn-bold", :id => 'edit-branding', :target => "_top" %>
									</div>
								</div>
						<% end %>
						<div class="control-group">
							<label class="control-label"><%= t("admin.products.portal.customer_portal") %></label>
							<div class="controls">
								<%= link_to t("admin.products.portal.edit_portal"),
													current_account.multi_product_enabled? ? edit_admin_portal_path(@account.main_portal) : admin_portal_index_path,
													:class => "btn btn-bold", :id => 'edit-portal' %>
							</div>
						</div>

					</div>

			</div>
		<% end %>
	</div>
	<% if @restricted_helpdesk_launched %>

		<hr>

		<div id = "permission">
			<h4 class="pb10" ><%=t('account.permission.helpdesk_restrictions')%></h4>
			<strong> <%=t('account.permission.who_can_create')%> </strong>
			<div class="moderation-setting">
				<%= f.fields_for :account_additional_settings do |settings| %>
					<label class="radio  disable-moderation">
						<%= settings.radio_button_tag :enable_restricted_helpdesk, "destroy", !@restricted_helpdesk, :class => "pull-left" %>
						<%= t('account.permission.users_from_any_domain')%>
					</label>
					<label class="radio enable-moderation">
						<%= settings.radio_button_tag :enable_restricted_helpdesk, "create", @restricted_helpdesk, :class => "pull-left"  %>
						<%= t('account.permission.users_from_selected_domains')%>
						<span class="muted"><%= t('account.includes_contacts_company_domain')%></span>
					</label>
				<% end %>
			</div>


			<div class="row-fluid">
				<div class="span8">
					<div class="domains-list hide">
					<%= f.text_field :permissible_domains, :class => "select2", :id => "domains-list", :data => {:width => '100%', "select-on-blur" => "true" } %>
					</div>
				</div>
				<div class="span4 moderation-info alert-text hide">
					<span class="ficon ficon-warning" aria-hidden="true">
						<%= t("account.important")%>
					</span>
					<div class="moderation-alert">
            <%= t("account.twitter_disabled")%>
					</div>
				</div>
			</div>
		</div>
	<% end %>
	<hr>
	<div class="pull-right">
  		<input type="hidden" name="redirect_url" id="redirect_url" value="" />
		<%= link_to "#{t('account.cancel')}".html_safe, "/admin/home", :class => "btn" %>
		<%= submit_tag t('account.save'), :class => 'btn btn-primary', :id => 'account_submit' %>
	</div>

<% end %>
</div>
<% content_for :onload_script do %>

	DATE_FORMATS_BINDING = <%= AccountConstants::DATEFORMATS.to_json.html_safe%>

	jQuery(document).ready(function(){
		window.App = window.App || {};
		window.App.Channel = window.App.Channel || new MessageChannel();
	});

	jQuery("#edit-branding").on("click", function(e){
		if(!(isIe())) {
			e.preventDefault();
		}
		window.App.Channel.port1.postMessage({action: "preferences"});
	});

	jQuery("#manage-language-button").on("click", function(e){
		if(!(isIe())) {
			e.preventDefault();
		}
		window.App.Channel.port1.postMessage({action: "manage-language"});
	});
	
	function isIe() {
		if (document.documentMode || /Edge/.test(navigator.userAgent)) {
		   return true;
		} else {
			return false;
		}

	}

	var set_default_date = function(element){
		var date_format = DATE_FORMATS[DATE_FORMATS_BINDING[element.val()]]['moment_date_with_week']
		jQuery("#sample_date").html("<span class='muted'>"+moment(new Date()).format(date_format)+"</span>");
	}

	jQuery("#account_account_additional_settings_attributes_date_format").on("change",function(){
		set_default_date(jQuery(this));
	}).trigger('change');

	jQuery("[data-rebrand-form]").on("change", function(ev){
		var target = jQuery(ev.target);
		if(target.attr('data-loadedScript'))
		{
			target.removeAttr('data-loadedScript');
		}
		else
		{
			jQuery(this).data('formChanged', true)
		}
	})
	jQuery("[rel=customize-portal]").on("click", function(ev){
		var form = jQuery(this).parents('form:first')
		if(form.data('formChanged')){
			ev.preventDefault()
			if(confirm("You have unsaved changes in your form. Do you want to save and continue?")){
				jQuery("#redirect_url").val(this.href)
				form.submit()
			}
		}
	})
	jQuery("#edit-portal").on("click", function(ev){
		var form = jQuery(this).parents('form:first')
		if(form.data('formChanged')){
			ev.preventDefault()
			if(confirm("You have unsaved changes in your form. Do you want to save and continue?")){
				jQuery("#redirect_url").val(this.href)
				form.submit()
			}
		}
	})
	jQuery(document).on("change", '.fileAdminUpload', function(){
		if ( jQuery(this.form).valid() ) {
			jQuery("#redirect_url").val("<%= edit_account_path %>")
			this.form.submit()
		}
	})

	<% if current_account.subscription.non_sprout_plan? %>
    jQuery("#account_forum_enabled").itoggle();
  <% end %>
  <% unless current_account.subscription.trial_or_sprout_plan?  %>
    jQuery("#account_branding_enabled").itoggle();
   <% end %>

	<% if @restricted_helpdesk_launched %>


    jQuery("input[type=radio][name=enable_restricted_helpdesk]").change(function(){
      if(this.value == "create"){
        jQuery(".domains-list").show();
        jQuery(".moderation-info").show();
      }else{
        jQuery(".domains-list").hide();
        jQuery(".moderation-info").hide();
      }
    })


	<% end %>

	<% if current_account.time_zone_updation_running? %>
	   jQuery("#account_time_zone").prop("disabled", true)
	<% end %>

<% end %>
