<% content_for :layoutType do %><% end %>
<% @page_title = @topic.title %>
<% @monitoring = logged_in? && !Monitorship.count(:id, :conditions => ['user_id = ? and topic_id = ? and active = ?', current_user.id, @topic.id, true]).zero? %>

<% content_for :sidebar do -%>
	<% if logged_in? && current_user.has_manage_forums? %>
	<div class="rtCnt sidepanel">
		<div class="rtDetails_forum">
		<% if logged_in? && current_user.has_manage_forums? %>
			<% if @forum.ideas? %>
				<%= content_tag(:h4, t(".mark_this_idea_as"), :class => "title") %>
				<div class="mark_action">
					 <% Topic::IDEAS_STAMPS_OPTIONS.each do |k,v| %>
					 	<% class_name = "stamp_type_#{v}" %>
					 	<%if @topic.stamp_type != v %>
							<%= link_to (k , update_stamp_category_forum_topic_path(@forum_category,@forum,@topic,:stamp_type => v),  :method=>:put, :class => class_name )   %>
						<%else%>
							<%= link_to (k , remove_stamp_category_forum_topic_path(@forum_category,@forum,@topic), :method=>:put , :class => class_name + " active")   %>
						<%end%>
					<% end %>
			    </div>
			<% end %>
			<div>
				<%= link_to((t('connect_ticket') + " &raquo;").html_safe, new_helpdesk_ticket_path(:topic_id => @topic.id), :class => "uiButton full-width") if logged_in? and @topic.ticket_topic.nil?  %>
				<%= link_to((@topic.ticket.subject), helpdesk_ticket_path(@topic.ticket)) unless @topic.ticket_topic.nil? %>
			</div> 
		<% end %>
		</div>
	</div>
	<% end %>
<% end %>    
		<div class="request_details">   
  		<div class="breadcrumbs">
  			<%= link_to(t('forum.title'), categories_path) %> &rarr;
  			<%= link_to( "#{h(@forum_category.name)}", category_path(@forum_category)) %> &rarr;
  			<%= link_to( "#{h(@forum.name)}", category_forum_path(@forum_category, @forum)) %> 
  		</div>
	    	<div class="requestCnt request-cnt-first">  
			  <h3 class="forum-title">
			    <%= h @topic.title  %>
			  </h3>
				<% first_post = @topic.posts.first %>
				<div class="description">
					<% if permission?(:manage_forums) and feature?(:gamification) %>
						<textarea id="agent-hovercard" style="display:none;">
							<div class="contact_hover" style="min-height:50px;">
							  <%= user_avatar(@topic.user) if @topic.user %>
							  <%= content_tag :div, link_to(CGI.escapeHTML(h(@topic.user)), @topic.user), :class => "user_name" %>
							  <% if @topic.user.agent? %>
							  	<strong><%= content_tag :div, h(@topic.user.agent.level.name) unless @topic.user.agent.level.blank? %></strong>
							  <% end %>
							</div>
						</textarea>
            		<% end %>
					<div class="user_details">
						<%= user_avatar( @topic.user ) %>
            			<%=t('posted_by')%> <%= link_to_user ( @topic.user, :class => "user_name", "data-placement" => "topRight", :rel => "hover-popover", "data-widget-container" => "agent-hovercard" ) %>
            			<div class="info">
						  <%= formated_date(@topic.created_at) %>
						  <% if @forum.ideas? %>
    		    		<span class="mark_action">
    							<% if @topic.stamp_type %>
    								<% class_name = "stamp_type_#{@topic.stamp_type}" %>
    								<span class="<%=class_name%> stamp"><%= h(@topic.stamp_name) %></span>
    							<% end %>
    					  </span>
    				  <% end %>
						</div>
          </div>
					<div class="ticket_actions action_icons">
            <% if logged_in? and current_user.has_email?%>
              <% if @topic.editable_by?(current_user) -%>
                <div class="action_buttons">
                  <%= link_to(t('topic.edit'), edit_category_forum_topic_path(@forum_category,@forum, @topic) , :class => "last" ) %>
                </div>
                <div class="action_buttons">
                <%= link_to( (@topic.locked)?t('topic.open'):t('topic.close'),
		              update_lock_category_forum_topic_path(@forum_category,@forum, @topic),
		              :method => :put, :class => "last" )	if logged_in? && current_user.has_manage_forums? %>
		        </div>
              <% end %>
						  <div class="floatr"> 
							  <%= link_to(image_tag("/images/spacer.gif"), category_forum_topic_monitorship_path(@forum_category,@forum, @topic), :method => :post, :class => "monitor", :title => "Monitor this topic" ) unless @monitoring %>
							  <%= link_to(image_tag("/images/spacer.gif"), category_forum_topic_monitorship_path(@forum_category,@forum, @topic), :method => :delete, :class => "monitor_active",  :title => "Stop monitoring this topic" ) if @monitoring %>
						  </div>	  	
						<% end %> 
					</div>
		      <div class="request-wrapper">    	 
					  <div class="details min_height">    
					    <span class="seperator"></span>
						  <%= first_post.body_html.html_safe %>     
							<span class="seperator"></span>  
						</div>
					 
					<% unless first_post.attachments.empty? %>
  					<span class="seperator"></span>
					  <h4><%= first_post.attachments.size %> attachment(s)</h4>
					  <ul class="attachment_list">
              <%= render :partial => '/helpdesk/shared/attachment', :collection => first_post.attachments, 
                :locals => { :url => [first_post], :show_delete => (logged_in? && @topic.editable_by?(current_user)) } %>
 					  </ul>
 					<% end %>
					<% unless @topic.forum.announcement? %>   
						<div class="status" id="voting_container"> 
							  <%= render (:partial => "/forum_shared/topic_vote", :object => @topic) if logged_in? %> 
						</div>
					<% end %>             
					<div class="alignright">
           <%= content_tag(:h4, t('topic.msg1'), :class => "title" ) if @topic.locked? %>
           <%= link_to_function (t('reply_comment'), "jQuery('#reply').toggle();jQuery('#post_body_html').getEditor().focus();", :class => "uiButton special") if logged_in? && !@topic.locked? %>
          </div>
					</div>   
        </div>
      </div>
      <div class="seperator-shadow"></div>
      <% if logged_in? %>
        <%= render :partial => "reply_to_post" %>
      <% end %>
      <% if (@posts.size > 1) %>
        <div class="requestCnt request-conversation">
        <h3 class="forum-title"><%=t('comments')%></h3>          
        <% last_post = @posts.last %>
          <% @posts.each do |post| %>
            <% unless (post == first_post) %>
              <%= render :partial => "forum_shared/post", :object => post %>							
            <% end %>
          <% end %> 
          <%= will_paginate @posts %>
        </div>  
      <% end %>
      <div id="edit"></div>
    </div>
    <% javascript_tag do %>
    	(function($) {
		    $('.requestCnt').on('click', '.reset_button, .save_button', function(ev){
		    	var id = $(this).data('id');
		    	$('#post_' + id + '_body_html').destroyEditor();
				$('#edit_post_' + id).hide();
				$('#loading_' + id).removeClass('hide');
				if($(this).hasClass('reset_button')) {
					$('#post_details_' + id).html($(this).data('html'));
					$('#loading_' + id).addClass('hide');
				}
			});
		})(jQuery)
    <% end %>