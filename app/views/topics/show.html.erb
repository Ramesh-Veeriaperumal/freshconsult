<% content_for :layoutType do %><% end %>
<% @page_title = @topic.title %>
<% @monitoring = !@monitorship.zero? %>

<% content_for :sidebar do -%>
	<div class="rtCnt sidepanel">
		<% if @topic.published? %>
		<div class="rtDetails_forum">

			<% if @forum.ideas? %>
				<%= content_tag(:h4, t(".mark_this_idea_as"), :class => "title") %>
				<div class="mark_action">
					<% Topic::IDEAS_STAMPS_OPTIONS.each do |k,v| %>
					 	<% class_name = "stamp_type_#{v}" %>
					 	<%if @topic.stamp_type != v %>
							<%= link_to(k , update_stamp_category_forum_topic_path(@forum_category,@forum,@topic,:stamp_type => v),  :method=>:put, :class => class_name )   %>
						<%else%>
							<%= link_to(k , remove_stamp_category_forum_topic_path(@forum_category,@forum,@topic), :method=>:put , :class => class_name + " active")   %>
						<%end%>
					<% end %>
			    </div>
			<% elsif @forum.problems? %>
				<%= content_tag(:h4, t(".mark_this_problem_as"), :class => "title") %>
				<div class="mark_action">
				 	<%unless @topic.solved? %>
				 		<% class_name = "stamp_type_#{Topic::PROBLEMS_STAMPS_BY_TOKEN[:solved]}" %>
						<%= link_to(t('topic.problems.solved') , update_stamp_category_forum_topic_path(@forum_category,@forum,@topic,:stamp_type => Topic::PROBLEMS_STAMPS_BY_TOKEN[:solved]),  :method=>:put, :class => class_name )   %>
					<%else%>
						<% class_name = "stamp_type_#{Topic::PROBLEMS_STAMPS_BY_TOKEN[:unsolved]}" %>
						<%= link_to( t('topic.problems.unsolved'), update_stamp_category_forum_topic_path(@forum_category,@forum,@topic,:stamp_type => Topic::PROBLEMS_STAMPS_BY_TOKEN[:unsolved]), :method=>:put , :class => class_name + " active")   %>
					<%end%>
			    </div>
			<% end %>
			<div>
				<%= link_to((t('connect_ticket') + " &raquo;").html_safe, new_helpdesk_ticket_path(:topic_id => @topic.id), :class => "btn full-width") if @topic.ticket_topic.nil?  %>
				<%= link_to(h(@topic.ticket.subject), helpdesk_ticket_path(@topic.ticket)) unless @topic.ticket_topic.nil? %>
			</div>
		</div>
		<% end %>
	</div>
<% end %>
		<div class="request_details">
	  		<div class="breadcrumbs">
	  			<%= link_to(t('forum.title'), categories_path) %> &rarr;
	  			<%= link_to( "#{(@forum_category.name)}", category_path(@forum_category)) %> &rarr;
	  			<%= link_to( "#{(@forum.name)}", category_forum_path(@forum_category, @forum)) %>
	  		</div>
	    	<div class="requestCnt request-cnt-first">
	    	<div class="topic_head">
		    	<div class="row-fluid">
						<div class="vertical-alignment span10">
							<span class="vertical-alignment monitor_link_holder position_forum_title" id="monitorship_link">
								<%=
										link_to_remote "",
										:url => toggle_monitorship_path("topic", @topic, (@monitoring ? "unfollow" : "follow")),
										:method => :post,
										:before => "jQuery('#toggle_monitorship_status').hide();jQuery('#monitorship_link').addClass('sloading loading-small');",
										:html => {
															:class => "forum_follow_icon tooltip #{@monitoring ? 'active' : ''}",
															"data-placement" => 'below',
															:id => "toggle_monitorship_status",
															:title => t((@monitoring ? 'monitorships.unfollow_title' : 'monitorships.follow_title'))
															} if @topic.published?
								%>
							</span>
						<% if privilege?(:edit_topic, @topic) -%>
						<span class="vertical-alignment action_icons position_forum_title">
							<%=
								link_to("",
								edit_category_forum_topic_path(@forum_category,@forum, @topic),
								:method => :get,
								:class => "icons-edit-forum tooltip",
								"data-placement" => 'below',
								:title => t('topics.edit_title') )
							%>
						</span>
						<% end %>
						<span class="vertical-alignment"><h3 class="position_forum_title lead"><%= @page_title  %></h3></span>
						<% if @topic.published %>
							<span class="vertical-alignment tooltip" title='<%= t('topic.view_on_portal')%>'>
								<%= link_to '<i class="agent-preview"></i>'.html_safe, support_discussions_topic_path(@topic.id), :target => "_blank" %>
							</span>
						<% else %>
							<span class="label ml20"><%= t('topic.spam') %></span>
						<% end %>
					</div>
					<% if privilege?(:edit_topic, @topic) and @topic.published? %>
					<div class="pull-right mt20">
						<ul class="nav-drop">
			  			<li>
			  				<a href="#" class="menu-trigger nav-item-icon"><span class="item-options"></span></a>
			  				<ul class="menu-box mt20 mr5">
			  					<li class="menu-item">
									<%= link_to( (@topic.locked)?t('topic.open'):t('topic.close'),
						              update_lock_category_forum_topic_path(@forum_category,@forum, @topic),
						              :method => :put) %>
						        </li>
						        <li class="menu-item">
									<%= link_to( t('topic.mark_as_spam'),
						              mark_as_spam_discussions_moderation_path(@topic.posts.first),
						              :method => :put) %>
						        </li>
						    </ul>
						</li>
						</ul>
					</div>
					<% end %>
				</div>
			</div>
				<% first_post = @topic.posts.first %>
				<div class="description">
					<div class="user_details">
						<%= user_avatar( @topic.user ) %>
            			<%=t('posted_by')%> <%= link_to_user( @topic.user) %>
            			<div class="info">
						  <%= formated_date(@topic.created_at) %>
						  <% if @forum.stamps?%>
    		    		<span class="mark_action">
    							<% if @topic.stamp_type %>
    								<% class_name = "stamp_type_#{@topic.stamp_type}" %>
    								<span class="<%=class_name%> stamp">
    									<%=
    									if @forum.ideas?
    										h(@topic.stamp_name)
    									elsif @forum.questions? && @topic.answered?
    										t('topic.questions.answered')
    									elsif @forum.problems? && @topic.solved?
    										t('topic.problems.solved')
    									end %>
    								</span>
    							<% end %>
    					  </span>
    				  <% end %>
				</div>
          </div>
		      <div class="request-wrapper">
					  <div class="details min_height">
					    <span class="seperator"></span>
						  <%= first_post.body_html.html_safe %>
							<span class="seperator"></span>
						</div>
					<% unless first_post.attachments.empty? %>
  					<span class="seperator"></span>
					  <strong><%= first_post.attachments.size %> <%= t('attachments') %></strong> 
					  <%= attachment_container(first_post.attachments, privilege?(:edit_topic, @topic), "article", nil) %>
 					<% end %>
					<% if @topic.published? and  !@topic.forum.announcement? %>
						<div class="status" id="voting_container">
							<%= render(:partial => "/forum_shared/topic_vote", :object => @topic) %>
						</div>
					<% end %>
					<div class="alignright">
           <%= content_tag(:h4, t('topic.msg1'), :class => "title" ) if @topic.locked? %>
           <%= link_to_function(t('reply_comment'), "jQuery('#reply').toggle();jQuery('#post_body_html').getEditor().focus();", :class => "btn btn-primary", :id => "reply-to-post") if !@topic.locked? and @topic.published? %>
          </div>
					</div>
        </div>
      </div>
      <div class="seperator-shadow"></div>
        <%= render :partial => "reply_to_post" %>
      <% if (@posts.size > 1 or (params[:page] and params[:page].to_i > 1)) %>
        <div class="requestCnt request-conversation">
        <h3 class="forum-title"><%=t('comments')%></h3>
        <% last_post = @posts.last %>
          <% @posts.each do |post| %>
            <% unless (post == first_post) %>
              <%= render :partial => "forum_shared/post", :object => post %>
            <% end %>
          <% end %>
          <%= will_paginate @posts %>
        </div>
      <% end %>
      <div id="edit"></div>
    </div>
    <% javascript_tag do %>
    	(function($) {
		    $('.requestCnt').on('click', '.reset_button, .save_button', function(ev){
		    	var id = $(this).data('id');
		    	$('#post_' + id + '_body_html').destroyEditor();
				$('#edit_post_' + id).hide();
				$('#loading_' + id).removeClass('hide');
				if($(this).hasClass('reset_button')) {
					$('#post_details_' + id).html($(this).data('html'));
					$('#loading_' + id).addClass('hide');
				}
			});
		})(jQuery)
		highlight_code();
    <% end %>
