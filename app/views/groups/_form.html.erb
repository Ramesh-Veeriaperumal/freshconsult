 <%= include_stylesheets :pattern %>
<%= include_javascripts :pattern %>

 <h3 class="lead"><%=title%></h3> <br/>
	<% form_for(@group, :html => {:id => "group_form"}) do |f|  %>
	  <%= f.error_messages %>
	   <div class="row-fluid group-management">
		 	<ul class="unstylGroup::d">
		 		<li class="row-fluid">
		 			<%= f.label :name, "<b> #{t('group.name')} </b>" , :class => "control-label span2" %>
					  <div class="span10">
						 <%= f.text_field :name , :class => "text required span12", :placeholder => t('group.name')  %>
					  </div>
		 		</li>
		 		<li class="row-fluid">
		 			 <%= f.label :description, "<b> #{t('description')} </b>", :class => "control-label span2" %>
					  <div class="span10">
						 <%= f.text_area :description , :class => "text required smallpara span12", :placeholder => t('group.name')  %>
					  </div>
		 		</li>
		 		<li class="row-fluid margin-bottom">
		 			<label class="control-label span2"><b><%=t('group.info1')%></b></label>
		 			<input type="hidden" id="agent_list" name="group[agent_list]" class="span10"
		 			data-placeholder = "<%= t("helpdesk.tickets.add_watcher.add_agent") %>"/>
				</li>
		 			 
		 			 <% 
						account_id =  @group.account_id
						if account_id.nil?
							account_id = current_account.id
						end
						 @exclude_list = @group.excluded_agents(current_account) %>
					<%  
						if(@exclude_list.nil? ||@exclude_list.size == 0)
							showagent = "display:none"
						end 
					%>
					
		 		<% if feature?(:round_robin) %>
			 		<li class="row-fluid">
						<label class="control-label span2"><b><%=t('group.ticket_assignment') %></b></label>
						<div class="span10">
							<ul class="unstyled">
								<li class="margin-bottom">
									  <div class="margin-bottom"><input type="radio" rel="toggle" name="group[ticket_assign_type]" id="ticket_assign_type" value="1" <%= @group.ticket_assign_type == Group::TICKET_ASSIGN_TYPE[:round_robin] ? "checked" : "" %> >
									  </div>
									  <div class="muted info_data">
									  	<%=t('group.round_robin_desc')%>&nbsp;<a href="https://support.freshdesk.com/support/solutions/articles/77157-assigning-tickets-in-a-group-automatically" target="_blank"><%=t('group.learn_more')%></a>
									  </div>

								</li>
						</div>
	            	</li>
            	<% end %>
            	<br/>
            	<li class="row-fluid">
            		<div class="offset2 span10">
            			<ul class="unstyled group-ticket-assign">
            				<li class="row-fluid">
            					<span class="span6 group-text-align"><%=t('group.info4')%> :</span>
            					<%= f.select :assign_time , Group::ASSIGNTIME_OPTIONS,{}, { :class => 'select2 span3' } %>
            				</li>
            				<li class="row-fluid">
            					<span class="span6 group-text-align"> &nbsp; &nbsp;<%#=t('group.info3')%> ....then send escalation email to :</span>
            					<input type="hidden" id="escalate_to" name="group[escalate_to]" class="span3"
            					data-placeholder = "<%= t("group.select_an_agent") %>"/>
            				</li>
            			</ul>
            		</div>
            	</li>
		 	</ul>
		 </div>
	  <br />
	  <div class="button-container">	    
		<%= link_to t('cancel'), groups_path, :class => "btn" %>	
		<%= f.submit t('save'), :class => "btn btn-primary" %>
	  </div>
<% end %>

<script type="text/javascript">

jQuery(document).ready(function() {

<%
all_agents = []
all_agents_list = @group.all_agents_list(current_account)
if all_agents_list
  all_agents_list.each do |req|
    all_agents << "{id: '#{req.user_id}',
                  value: '#{escape_javascript(req.user.name)}',
                  text: '#{escape_javascript(req.user.name)}'}"
  end
end

selected_agents = []
agents = @group.agents
if agents
	 agents.each do |req|
    selected_agents << "{id: '#{req.id}',
                  value: '#{escape_javascript(req.name)}',
                  text: '#{escape_javascript(req.name)}'}"
  end
end 
%>

jQuery('#agent_list').select2({
	multiple: true,
	data: [<%=all_agents.join(",")%>],
	initSelection : function (element, callback) {
      callback( [<%=selected_agents.join(",")%>] );
    }
	
});
jQuery("#agent_list").select2("val",[]);

<%
	technicians = []
	account_id =  @group.account_id
	if account_id.nil?
		account_id = current_account.id
	end
	technician_list = Agent.technician_list(account_id)
	if technician_list
		technician_list.each do |req|
			technicians << "{id: '#{req.id}',
                  value: '#{escape_javascript(req.name)}',
                  text: '#{escape_javascript(req.name)}'}"
		end
	end

	escalate_to_agent = []
	if @group.escalate
		escalate_to_agent << "{id: '#{@group.escalate.id}',
                  value: '#{escape_javascript(@group.escalate.name)}',
                  text: '#{escape_javascript(@group.escalate.name)}'}"
    end
%>
jQuery('#escalate_to').select2({
	multiple: false,
	data: [<%=technicians.join(",")%>],
	initSelection : function (element, callback) {
        var data = {id: '<%=@group.escalate_to%>', text: '<%=@group.escalate && @group.escalate.name%>'};
        callback(data);
    }
});

jQuery("#escalate_to").select2("val",[]);


});

</script>
