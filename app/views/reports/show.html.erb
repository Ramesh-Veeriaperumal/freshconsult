<%
date_range = params[:date_range].blank? ? "#{31.days.ago.strftime("%d %B %Y")} -#{1.days.ago.strftime("%d %B %Y")}" :  h(params[:date_range])
%>
<script src="/javascripts/report/date.js" type="text/javascript"></script>
<script src="/javascripts/report/daterangepicker.jQuery.js" type="text/javascript"></script>
<link href="/stylesheets/ui.daterangepicker.css" media="screen" rel="stylesheet" type="text/css">
<%= include_cloudfront_css :reports, :media => "screen, print, projection"  %>
<%= include_cloudfront_css :report_print, :media => "print, projection" %>
<span class="floatr">
	<%= link_to("&larr; #{t('reports.summary_report.back_to_reports')}".html_safe, reports_url, :class => "slim-button") %>
</span>
<h3 class="title">
	<%= @current_report[:label] %>
<h4 class='title'> <%= date_range %></h4>
</h3>

<% content_for :sidebar do %>
<div class="sidepanel">
  <h4 class="title"><%= t('reports.select_time_period')%></h4>
	<form id="report_search">
		<ul class="ui-form">
			<li class="inline-field">
				<div>
					<%= text_field_tag :date_range, date_range, :class => "required" %>
				</div>
			</li>
		</ul>
		<div class="button-container">
			<%= submit_tag t('reports.summary_report.show_report'), :class => "uiButton" %>
		</div>
	</form>

</div>

<div class="sidepanel helpcard">
	<p>	<%= t('reports.summary_report.helptext').html_safe %> </p>
</div>


<% javascript_tag do %>
jQuery(document).ready(function() {
	jQuery("#date_range").daterangepicker({
		earliestDate:Date.parse('04/01/2013'),
		latestDate:Date.parse('Today-1'),
		presetRanges: [
			{text: '<%= t('reports.date_ranges.yesterday') %>', dateStart: 'Today-1', dateEnd: 'Today-1' },
			{text: '<%= t('reports.date_ranges.last_7_days') %>', dateStart: 'Today-8', dateEnd: 'Today-1' },
			{text: '<%= t('reports.date_ranges.last_30_days') %>',dateStart: 'Today-31', dateEnd: 'Today-1'},
			{text: '<%= t('reports.date_ranges.last_90_days') %>',dateStart: 'Today-91',  dateEnd: 'Today-1'}
		],
		presets: {
			dateRange: '<%= t('reports.date_ranges.custom') %>'
		},
		dateFormat: 'dd MM yy',
		closeOnSelect: true
	});   

	jQuery("#date_range").bind('keypress keyup keydown', function(ev) {
		ev.preventDefault();
		return false;
	});
});     
<% end %>
<% end %>

<div class="grid report" id="agent_ticket_summary">	
	<table width="100%" id="summary_report" class="tablesorter">
		<thead>
			<tr>
				<th>
					<%= @current_report[:title] %>
				</th>

				<th>
					<%= t('reports.summary_report.tickets_resolved').html_safe %>
				</th>

				<th>
					<%= t('reports.summary_report.on_time_resolution').html_safe %>
				</th>

				<th>
					<%= t('reports.summary_report.fcr_count').html_safe %>
				</th>

				<th>
					<%= t('reports.summary_report.avg_1st_response_time').html_safe %>
				</th>

				<th>
					<%= t('reports.summary_report.avg_response_time').html_safe %>
				</th>

				<th>
					<%= t('reports.summary_report.avg_resolution_time').html_safe %>
				</th>
			</tr>
		</thead>
		<% @current_object.each do |obj| %>
		<tr class="<%= cycle("odd", "even") %>">
			<% case @current_report[:name] 
					when "responder" %>
						<td>
							<% if obj.user.twitter_id.blank? %>
								<%= obj.user.name %>
							<% else %>
								<%= obj.user.name_details %>
							<% end %>	
						</td>
						<% data = @report_data.fetch(obj.user_id, {}) %>
			<%	when "group" %>
						<td>
							<%= obj.name %>
						</td>
						<% data = @report_data.fetch(obj.id, {}) %>	
			<% end 

			resolved_count = data.fetch(:tot_tkts, 0).to_i
			otr_percentage = percentage(data.fetch(:tkt_res_on_time,0).to_i,resolved_count)
			fcr_percentage = percentage(data.fetch(:fcr,0).to_i,resolved_count)
			afrt = data.fetch(:average_first_response_time, 0)
			art = data.fetch(:average_response_time, 0)
			areslt = data.fetch(:average_resolution_time, 0)
			%>
			<td>
				<%= resolved_count %>
			</td>
			<td>
				<%= otr_percentage %> 
				<% count = data.fetch(:tkt_res_on_time, 0) %>
				<% if count != 0 %>
					(<%= count %>)
				<% end %>
			</td>
			<td>
				<%= fcr_percentage %> 
				<% count = data.fetch(:fcr, 0) %>
				<% if count != 0 %>
					(<%= count %>)
				<% end %>
			</td>
			<td>
				<%= timediff_in_words(afrt) %>
			</td>
			<td>
				<%= timediff_in_words(art) %>
			</td>
			<td>
				<%= timediff_in_words(areslt) %>
			</td>
		</tr>
		<% end %>
		<%if @report_data.key?("Unassigned")
			data = @report_data["Unassigned"]
			resolved_count = data.fetch(:tot_tkts, 0).to_i
			otr_percentage = percentage(data.fetch(:tkt_res_on_time,0).to_i,resolved_count)
			fcr_percentage = percentage(data.fetch(:fcr,0).to_i,resolved_count)
			afrt = data.fetch(:average_first_response_time, 0)
			art = data.fetch(:average_response_time, 0)
			areslt = data.fetch(:average_resolution_time, 0)
		%>
		<tr class="<%= cycle("odd", "even") %>">
			<td><%=t('filter_options.unassigned')%></td>
			<td>
				<%= resolved_count %>
			</td>
			<td>
				<%= otr_percentage %> 
				<% count = data.fetch(:tkt_res_on_time, 0) %>
				<% if count != 0 %>
					(<%= count %>)
				<% end %>
			</td>
			<td>
				<%= fcr_percentage %> 
				<% count = data.fetch(:fcr, 0) %>
				<% if count != 0 %>
					(<%= count %>)
				<% end %>
			</td>
			<td>
				<%= timediff_in_words(afrt) %>
			</td>
			<td>
				<%= timediff_in_words(art) %>
			</td>
			<td>
				<%= timediff_in_words(areslt) %>
			</td>
		</tr>
		<%end%>
	</table>	
</div>