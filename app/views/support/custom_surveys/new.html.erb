<%= stylesheet_link_tag_with_rtl :'cdn/survey' %>

<link href="<%= helpdesk_theme_url %>" media="screen" rel="stylesheet" type="text/css">

<%= javascript_include_tag :'cdn/survey'  %>

<%= javascript_tag do %>
  surveyFeedbackI18n = {};
  surveyFeedbackI18n.thanksFeedback =  "<%= t('admin.surveys.new_thanks.thanks_feedback')%>";
  surveyFeedbackI18n.surveyFeedback = "<%=t('admin.surveys.index.survey_feedback')%>";
  surveyFeedbackI18n.portalMsg = "<%= t('admin.surveys.index.portal_msg') %>";
  surveyFeedbackI18n.thanksMessage = "<%= @survey_handle.survey.thanks_text %>";
<% end %>

<script>
	var isCommentable = <%=@survey_handle.survey.can_comment%>;
	var isPreview = <%=@survey_handle.preview?%>
	var hasQuestandComments = false
	<% if @survey_handle.survey.feedback_questions.blank? && !@survey_handle.survey.can_comment? %>
		hasQuestandComments = true
	<% end %>
</script>

<% cache ["v1","survey",@survey_handle.portal] do %>
	<%
		cssText = render(:partial=>"rating_text")
		engine = Sass::Engine.new(cssText , :syntax => :scss, :cache => true, :style => :compressed)
	%>
	<style>
	<%= engine.render %>
	</style>
<% end %>

<% csat_email_scan_compatibile = @survey_handle.account.csat_email_scan_compatibility_enabled? %>

<% unless csat_email_scan_compatibile %>
	<script type="text/javascript">
		if(document.referrer.length > 0){
			Feedback.refreshTab();
		}
		<% if @rating_via_handle %>
			Feedback.surveySaveHit(null, "<%= @rating %>","<%= @survey_code %>","<%= @source %>");
		<% end %>
	</script>
<% end %>

<body class="single">
	<div class="cust-survey-wrapper content rounded-6">
		<%= form_for :survey_handle, html: {
					id: 'survey_form', method: :post, onsubmit: csat_email_scan_compatibile ? "javascript:Feedback.surveySaveHit(event, '#{@rating}', '#{@survey_code}', '#{@source}')" : "javascript:Feedback.submit(event)", 'data-email-scan-compatible': csat_email_scan_compatibile, 'data-handle': @survey_handle.id_token } do |f| -%>
			<div class="highlighter">
				<% if csat_email_scan_compatibile %>
					<h2></h2>
					<%= render partial: 'layouts/shared/survey', locals: { survey_handle: @survey_handle, rating: @rating, translation_record: @translation_record, language: @language} %>
				<% else %>
					<h2><%= @translation_record.present? ? @translation_record.translations[:thanks_text] || @survey_handle.survey.thanks_text : @survey_handle.survey.thanks_text%></h2>
				<% end %>
				<div class="survey-overlay center" style="display:none;"></div>
				<div class="loading">
					<span class='loading-text'> <%=t('admin.surveys.index.portal_msg')%> </span>
				</div>
			</div>
			<div class="survey_question_list" id='survey_question'>
				<% unless @survey_handle.survey.feedback_questions.blank? %>
					<div class="survey_question_wrapper">
						<% @survey_handle.survey.feedback_questions.each_with_index do |question,qindex| %>
							<div class="survey-question">
								<span class="pull-left"><%= qindex+1 %>.</span>
								<div class = "ques-desc"><%= @translation_record.present? ? @translation_record.translations.fetch(:additional_questions, {})["question_#{question.id}".to_sym] || question.label : question.label %></div>
								<div class="ques-ans">
									<% question.choices.each_with_index do |option, index| %>
										<span class="survey-rating none question-rating-<%=qindex%>" id="rating_<%=index%>" data-class="<%=CustomSurvey::Survey::CUSTOMER_RATINGS_STYLE[option[:face_value]]%>" data-id="<%=option[:face_value]%>" data-question-id="<%=qindex%>" data-name="<%=@translation_record.present? ? @translation_record.translations.fetch(:additional_questions, {}).fetch(:choices, {})[option[:face_value]] || option[:name] : option[:name]%>" onmouseover="javascript:SurveyRating.hover(this);" onmouseout="javascript:SurveyRating.resetLabel(this);" onclick="javascript:SurveyRating.input(this);"></span>
									<%end%>
									<label id="rating-label-<%=qindex%>" class="muted rating-label" data-selected-value="&nbsp;" data-selected-id="none" data-custom-field="<%=question.name%>">&nbsp;</label>
								</div>
							</div>
						<%end%>
					</div>
				<%end%>
				<%if @survey_handle.survey.can_comment? %>
					<textarea autocomplete="off" class="input-comment required" id="survey_feedback" name="feedback" rel="ghostwriter" type="text" width="100%"
						placeholder= "<%= @translation_record.present? ? @translation_record.translations[:comments_text] || @survey_handle.survey.comments_text : @survey_handle.survey.comments_text %>" ></textarea>
				<% end %>
				<% if csat_email_scan_compatibile || (!@survey_handle.survey.feedback_questions.blank? || @survey_handle.survey.can_comment?) %>
					<%= f.submit t('support.surveys.new.submit'),:id => "submit_survey", :class => "btn btn-primary btn-comment" %>
				<% end %>
			</div>
		<%end%>
	</div>
</body>
<script>
	jQuery(document).ready(function(){
		jQuery("#survey_form").on("submit", function(){
			jQuery("#submit_survey").prop("disabled",true);
			jQuery("#submit_survey").addClass("survey-button-disable");
		})
	})
</script>