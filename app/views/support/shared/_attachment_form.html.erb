<% return if @widget_form && !widget_option(:screenshot) && !widget_option(:attachFile) %>
<% 
  attach_id ||= "ticket"
  original_attachments ||= {:regular => [], :cloud_files => []}
  nsc_param = nsc_param || "helpdesk_ticket"
%>
<div class="attach-wrapper row-fluid">
  <div class="span7">    
    <% if widget_option(:attachFile) %>
      <% unless dropbox_app_key.blank? %>
        <div class="dropdown dropup">        
          <a class="dropdown-toggle attach-link" data-toggle="dropdown" href="#">
            <i class="wicon-paper-clip"></i><%=I18n.t('attach')%><b class="caret"></b>
          </a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
            <li class="portal-attach">
             <span class="attach-proxy">
               <a href="#" class="attach-link-wrap" 
                  id="<%=attach_id%>_file_proxy_link" 
                  data-file-id="<%=attach_id%>_file" 
                  onclick="Helpdesk.Multifile.clickProxy(this); return false;">
                 <%= I18n.t('portal.attach_file').html_safe %>
               </a>
             </span>
             <div class="attach-file attach-link-file hide" id="<%= attach_id %>-attach-container">
               <input type="file" name="emptyfile" 
                 id="<%=attach_id%>_file"
                 data-attach-id="<%=attach_id%>_file"
                 nameWhenFilled="<%=nsc_param%>[attachments][][resource]" 
                 fileContainer="<%=attach_id%>-container" 
                 fileList="<%=attach_id%>-attachments"
                 sendFocusTo="<%=attach_id%>-body" />
              </div>
           </li>
            <% unless dropbox_app_key.blank? %>
              <li id="dropboxjs" data-app-key="<%=dropbox_app_key%>">
                  <input type="hidden"  id="<%=attach_id%>_url" name="dropboxURL" nameWhenFilled="[cloud_file_attachments][]" 
                    fileContainer="<%=attach_id%>-container" fileList="<%=attach_id%>-attachments" sendFocusTo="<%=attach_id%>-body" />
                  <a href="#" class="dropbox_button" name="selected-file" id="db-chooser" 
                    data-holder="<%=attach_id%>_url" onclick='initDropbox(this); event.preventDefault(); '><%=I18n.t('dropbox_attach_from').html_safe %></a>         
              </li>
            <% end %>
          </ul>      
        </div>
      <% else %>      
        <div class="attach-link portal-attach">
          <i class="wicon-paper-clip"></i>
          <span class="attach-proxy">
               <a href="#" class="attach-link-wrap" 
                  id="<%=attach_id%>_file_proxy_link"
                  data-file-id="<%=attach_id%>_file" 
                  onclick="Helpdesk.Multifile.clickProxy(this); return false;">
                 <%= I18n.t('portal.attach_file').html_safe %>
               </a>
             </span>
             <div class="attach-file attach-link-file hide" id="<%= attach_id %>-attach-container">
               <input type="file" name="emptyfile" 
                 id="<%=attach_id%>_file"
                 data-attach-id="<%=attach_id%>_file"
                 nameWhenFilled="<%=nsc_param%>[attachments][][resource]" 
                 fileContainer="<%=attach_id%>-container" 
                 fileList="<%=attach_id%>-attachments"
                 sendFocusTo="<%=attach_id%>-body" />
              </div>
        </div>
      <% end %>    
      <div class="attachments-list-form" id="<%= attach_id %>-container">
        <div id="<%= attach_id %>-attachments"></div>
      </div>
    <% end %>    
  </div>
  <% if @widget_form && widget_option(:screenshot) %>
    <div class="span5 omega align-right">
      <% if is_application_installed?("screenr") && widget_option(:screenr_recording)%>
        <div class="screenshot-wrap controls">
          <div class="ie8plusonly pull-right">        
            <div class="dropdown">
              <div class="dropdown-toggle attach-link" data-toggle="dropdown" href="#">
                Screen Capture<b class="caret"></b>
              </div>
              <ul class="dropdown-menu screenr-dropdown align-left" role="menu" aria-labelledby="dLabel">
                <li class="portal-attach">
                  <div id="takescreen-btn">
                    <a href="#"><i class="wicon-camera"></i> <%=t('.feedback_widgets_screenshot')%></a>
                  </div>
                </li>
                <li>
                  <%= render :partial => "shared/screenr_recorder", :locals => { :location => "widget" } %>
                </li>
              </ul>
            </div>
            <div class="flash" style="display:none"></div>
            <div id="screenshot-wrap" style="display:none">
              <canvas class="f-screenshot" id="f-screenshot"></canvas>
              <a href="#" class="close screenshot-remove" onClick="remove_screenshot()">&times;</a>
            </div>
          </div>
        </div>
      <% else %>
        <div class="screenshot-wrap controls">
          <div class="ie8plusonly">
            <div id="takescreen-btn">
              <i class="wicon-camera"></i>
              <a href="#"><%=t('.feedback_widgets_screenshot')%></a>
            </div>
            <div class="flash" style="display:none"></div>
            <div id="screenshot-wrap" style="display:none">
              <canvas class="f-screenshot" id="f-screenshot"></canvas>
              <a href="#" class="close screenshot-remove" onClick="remove_screenshot()">&times;</a>
            </div>
          </div>
        </div>
      <% end %>      
    </div>
  <% end %>
</div>

<% if widget_option(:attachFile) %>
    <%= render :partial => "/support/shared/multifile_ticket_template"%>
    <script type="text/javascript">
      // Fix for Firefox/IE - To override :hover style persistance after click on input[type=file] element
      jQuery('div.attach-wrapper a[data-toggle="dropdown"]').bind('click', function(){
        jQuery(this).parents('div.attach-wrapper').find('a.attach-link-wrap').first().css({
              'background-color': 'inherit',
              'background-image': 'inherit',
              'color': 'inherit',
              'box-shadow': 'inherit'
          });
      });
      jQuery('li.portal-attach a.attach-link-wrap')
        .bind('mouseover', function(){
          jQuery(this).removeAttr('style');
        })
        .bind('mousemove', function(event){
          // Fix to move "Browse" button along with mouse pointer - fix for IE.
          p=jQuery(this).find('div').first();
          newLeft = Math.min(175, Math.max(event.clientX - p.offset().left + p.position().left - 5, 0));
          window.title = newLeft;
          p.css({left: newLeft, top: 0});
        })
    </script>
  <% unless dropbox_app_key.blank? %>
    <script type="text/javascript">
      function initDropbox(inp){
        Dropbox.choose({success:function(files){
            var inputElement = jQuery(inp).data('holder');

          jQuery('#'+inputElement)
            .val(JSON.stringify({link: files[0].link,name: files[0].name, provider: 'dropbox'}))
            .data('filename', files[0].name)
            .data('provider', 'Dropbox');
            Helpdesk.Multifile.addFileToList(jQuery('#'+inputElement));
            newInput = Helpdesk.Multifile.duplicateInput(jQuery('#'+inputElement));
            jQuery(inp).data('holder',newInput.attr('id'));
        }, extensions:""})
      }
    </script>
    <script type="text/javascript" src="https://www.dropbox.com/static/api/1/dropbox.js"></script>
  <% end %>
<% end %>


