<% unless current_user %>
	<%= post_topic_in_portal current_portal.to_liquid, true %>
<% else %>
	<% @topic ||= current_account.topics.new %>
	<% form_for @topic, :url => @topic.new_record? ? support_discussions_topics_path : support_discussions_topic_path(@topic), 
						:method => @topic.new_record? ? :post : :put,
						:html => { :multipart => true, :rel => "validate", :class => "form-portal" } do |form| -%>
	<%= form.error_messages %>					
	<div class="control-group">
		<label class="control-label required" for="topic_title">
			<%= t('portal.topic.topic_title') %>
		</label>
		<div class="controls suggestions">
			<%= form.text_field :title, :class => "required text span12", 
			:autocomplete => :off, :tabindex => 10, 
			'data-suggestions' => @topic.new_record? ? "/support/search/topics/suggest" : '', 
			'data-left-position' => "96.5%", 'data-top-position' => "5%" %>
		</div> 	
	<div class="control-group">
		<label class="control-label required description-label" for="topic_body">
			<%= t('message') %>
		</label>
		<div class="controls">
			<%= form.rich_editor :body_html, :value => !@topic.new_record? ? @topic.posts.first.body_html : "", 
				:rows => 12, "editor-type" => :forum, :class => "required_redactor" %>
		</div>
	</div>	
	<div class="control-group">
		<label class="control-label required">
			<%= t('portal.topic.post_topic') %>
		</label>
		<div class="controls">
			<%= form.select :forum_id, grouped_options_for_select(forum_options), 
				{ :include_blank => t("portal.topic.default_select_option") },
				{ :class => "required custom-select", 
				  :disabled => !@topic.new_record? } %>
			<% javascript_tag do %>
				jQuery("#topic_forum_id").val(<%= params[:forum_id] || @topic.forum_id %>)
			<% end %>
		</div>
	</div>
	<div class="control-group">
		<label class="control-label"><%= t('attach_files') %></label>	
		<% attach_id = attach_id || "post" %>
		<div class="controls">
			<input type="file" id="<%=attach_id%>_file" name="emptyfile" nameWhenFilled="post[attachments][][resource]" fileContainer="<%=attach_id%>-container" fileList="<%=attach_id%>-attachments" sendFocusTo="<%=attach_id%>-body" />
			<div class="attachments" id="<%=attach_id%>-container" style="display:none">
			  <div id="<%=attach_id%>-attachments"></div>
			</div>
		</div>	
					
		<%= render :partial => "/support/shared/multifile_template" %>
	</div>
	<% unless @topic.new_record? %>
	<div class="control-group">
		<div class="controls">
			<div class="attachment-list-container">
				<% unless @topic.posts.first.attachments.empty? %>
				    <%= content_tag('h5', t('attachments')) %>
				    <%= attachment_container(@topic.posts.first.attachments, true, "article", nil) %>
			    <% end %>
			</div>
		</div>
	</div>
	<%end%>
	<div class="control-group">
		<div class="controls">
			<% if is_application_installed?("screenr") %>
			  <%= render :partial => "shared/screenr_recorder", :locals => { :location => "portal_forum" } %>
			<% end %>
		</div>
	</div>

	<% if @topic.new_record? %>
		<div class="control-group"> 
	    	<%= content_tag( :label, t('ticket.verify_human'), :class => "control-label" ) %>
	    	<div class="controls recaptcha-control">
	    		<%= recaptcha_tags :display => { :theme => "white" }, :ssl => current_account.ssl_enabled? %>
	    	</div>
	  	</div>
  	<% end %>
	<div class="form-actions">
		<input type="submit" class="btn btn-primary" value=<%= t('save') %> />
		<a href="javascript:history.back()" class="btn"><%= t('cancel') %></a>
		<% unless @topic.new_record? %>
			<%= link_to t('delete'), support_discussions_topic_path(@topic), 
				:class => "btn btn-danger pull-right", 
				"data-method" => "delete",
				"data-confirm" => "#{t('delete_topic_msg')}?" %>
		<% end %>
	</div>
	<% end %>
<% end %>