<% content_for :sidebar do -%>
  <div class="sidepanel helpcard">
    <%= t("integrations.custom_application.helptext", :full_domain => current_account.full_domain) %>
  </div>
  <div>Preview <%=link_to "Refresh", "#", :class => "preview_link", :preview_page=>"ticket" %></div><div id="preview" class=""></div>
<%- end %>
  <%widget = @application.widgets.first 
  disp_in_pages = widget.display_in_pages_option || {}%>


  <ul class="ui-form">  
    <li class="inline-field">
      <label class="caption">
        <div class="logo application-logo-custom_app"></div>
        <div class="logo info-data">
          <%= t("integrations.custom_application.small_help_text") %>
        </div>
      </label>
      <div class="fields">
        <ul class="app-form">
          <li class="field">
            <label class="caption"><%=t('integrations.custom_application.name')%></label>
            <%= text_field_tag "application[display_name]", @application.display_name%>
          </li>
          <li class="field">
            <label class="caption"><%=t('integrations.custom_application.description')%></label>
            <%= text_field_tag "application[description]", @application.description%>
          </li>
          <li class="field">
            <label class="caption"><%=t('integrations.custom_application.script')%></label>
            <%= text_area_tag "application[script]", widget.script%>
          </li>
          <li class="field">
            <label class="checkwrapper">
              <%= check_box_tag "application[view_pages][]", "helpdesk_tickets_show_page_side_bar", 
                      disp_in_pages.include?('helpdesk_tickets_show_page_side_bar')%>
                  Show the widget in ticket view page. 
                  | <%=link_to "Preview", "#", :class => "preview_link", :preview_page=>"ticket" %>
            </label>
            <label class="checkwrapper">
              <%= check_box_tag "application[view_pages][]", "contacts_show_page_side_bar", 
              disp_in_pages.include?('contacts_show_page_side_bar')%>
              Show the widget in contact view page. 
              | <%=link_to "Preview", "#", :class => "preview_link", :preview_page=>"contact" %>
            </label>
          </li>
        </ul>
      </div>

    </li>
  </ul>
<%#<div id="capsule_widget" domain="freshdeskdemo.capsulecrm.com" title="Custom CRM App"><div class="content"></div></div><script type="text/javascript">CustomWidget.include_js("/javascripts/capsule_crm.js");capsuleBundle={ t:"b43cff831b56cec58fa8cd95c21b47f5", reqId:"{{requester.id}}", reqName:"{{requester.name | escape_html}}", reqOrg:"{{requester.company_name}}", reqPhone:"{{requester.phone}}", reqEmail:"{{requester.email}}"}; </script>%>
<% javascript_tag do %>
  jQuery('.preview_link').bind("click", function(ev){
      ev.preventDefault();
      preview_box = jQuery("#preview")
      preview_box.html("<div class='loading-box'>Generating Preview</div>"); 
      params = {"application_script": jQuery("#application_script").val()};
      jQuery.ajax({
        url: "/integrations/applications/custom_widget_preview/"+this.getAttribute("preview_page"),
        type: "POST",
        data: params,
        dataType: "script",
        success: function(msg){ 
        }
      }); 
  }); 
<%end%>
