<% content_for :helpcard do -%>
  <div class="helpcard">
    <%= t("integrations.custom_application.helptext", :full_domain => current_account.full_domain).html_safe %>
  </div>
  <div id="sample_preview" class="hide">
    <div class="titlebar">
      <a class="preview_link" href="#"><%= t('integrations.freshplugs.refresh') %></a>
      <%= t('integrations.freshplugs.custom_widget_preview').html_safe %>
    </div>
    <div id="preview" class=""></div>
  </div>

<%- end %>
  <%widget = @application.custom_widget
  disp_in_pages = widget.display_in_pages_option || {}%>


  <ul class="ui-form">  
    <li class="inline-field">
      <label class="caption">
        <div class="logo application-logo-custom_app"></div>
        <div class="logo info-data">
          <%= t("integrations.custom_application.small_help_text").html_safe %>
        </div>
      </label>
      <div class="fields">
        <ul class="app-form">
          <li class="field">
            <label class="caption"><%=t('integrations.custom_application.name').html_safe%></label>
            <%= text_field_tag "application[display_name]", @application.display_name%>
          </li>
          <li class="field">
            <label class="caption"><%=t('integrations.custom_application.description').html_safe%></label>
            <%= text_field_tag "application[description]", @application.description%>
          </li>
          <li class="field">
            <label><%=t('integrations.custom_application.script').html_safe%></label>
            <%= f.code_editor_tag nil , nil , :id => "application_script" , :name => "application[script]" , :value => widget.script, :class => "insert-placeholder-target" %>   
          </li>
          <li class="field custom_app_preview">
            <a class='l_placeholder slim-button' href='javascript:void(0)'><%= t('integrations.custom_application.form.insert_placeholder').html_safe %> &raquo;</a>
            <div class="custom_app_preview_link">
              <%=link_to t('integrations.freshplugs.show_preview'), "#", :class => "toggle_preview", 
                    "data-toggled-text" => t('integrations.freshplugs.hide_preview'), "data-toggled-class" => "active", 
                    "data-default-text" => t('integrations.freshplugs.show_preview'), 'data-default-class' => "" %>
              <span class="hide"> <br />This integration will appear in the sidebar</span>
            </div>
            <label class="checkwrapper">
              <%= check_box_tag "application[view_pages][]", "helpdesk_tickets_show_page_side_bar", 
                      disp_in_pages.include?('helpdesk_tickets_show_page_side_bar')%>
                  <%= t('integrations.freshplugs.show_widget_in_ticket_view_page') %>
            </label>
            <label class="checkwrapper">
              <%= check_box_tag "application[view_pages][]", "contacts_show_page_side_bar", 
              disp_in_pages.include?('contacts_show_page_side_bar')%>
              <%= t('integrations.freshplugs.show_the_widget_in_contact_view_page') %>
            </label>
            
          </li>
        </ul>
      </div>

    </li>
  </ul>
<%#<div id="capsule_widget" domain="freshdeskdemo.capsulecrm.com" title="Custom CRM App"><div class="content"></div></div><script type="text/javascript">CustomWidget.include_js("/javascripts/capsule_crm.js");capsuleBundle={ t:"b43cff831b56cec58fa8cd95c21b47f5", reqId:"{{requester.id}}", reqName:"{{requester.name | escape_html}}", reqOrg:"{{requester.company_name}}", reqPhone:"{{requester.phone}}", reqEmail:"{{requester.email}}"}; </script>%>
<% content_for :pagefixed do %>
  <%= render :partial => "/shared/placeholder_help", :locals => { :placeholders => ticket_placeholders }  %>
<% end %>
<% javascript_tag do %>
  jQuery('.preview_link').bind("click", function(ev){
      ev.preventDefault();
      preview_box = jQuery("#preview")
      preview_box.html("<div class='sloading loading-small loading-block'>Generating Preview</div>"); 
      params = {"application_script": jQuery("#application_script").val()};
      jQuery.ajax({
        url: "/integrations/applications/custom_widget_preview/",
        type: "POST",
        data: params,
        dataType: "script",
        success: function(msg){ 
        }
      }); 
  });

  jQuery('.toggle_preview').click(function(ev) {
    ev.preventDefault();
    var sample_preview = jQuery('#sample_preview');
    sample_preview.toggleClass('hide');
    jQuery('.custom_app_preview_link span').toggleClass('hide');
    var elem = jQuery(this);
    if (sample_preview.hasClass('hide')) {
      elem.text(elem.data('default-text')).removeClass(elem.data('toggled-class')).addClass(elem.data('default-class'));
    } else {
      elem.text(elem.data('toggled-text')).removeClass(elem.data('default-class')).addClass(elem.data('toggled-class'));

      jQuery('.preview_link').trigger('click');
    }
  }); 

  jQuery('.l_placeholder').bind("click", function(ev){
      ev.preventDefault();
      jQuery('#place-dialog').slideDown('slow', function(){
        jQuery(this).groupPlaceholders({'truncateItems': false});
      });
      jQuery('#application_script').focus();
  });

<%end%>
