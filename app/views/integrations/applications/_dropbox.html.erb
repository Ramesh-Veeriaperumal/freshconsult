<% unless dropbox_app_key.blank? %>
  <li id="dropboxjs" data-app-key="<%=dropbox_app_key%>">
      <input type="hidden"  id="<%=attach_id%>_url" name="dropboxURL" nameWhenFilled="[cloud_file_attachments][]" fileContainer="<%=attach_id%>-container" fileList="<%=attach_id%>-attachments" sendFocusTo="<%=attach_id%>-body" />
      <a href="#" class="dropbox_button" name="selected-file" id="db-chooser" 
        data-holder="<%=attach_id%>_url" onclick='initDropbox(this); event.preventDefault();'><%=I18n.t('dropbox_attach_from_text').html_safe%></a>         
  </li>
<% end %>
<% unless dropbox_app_key.blank? %>
  <script type="text/javascript" src="https://www.dropbox.com/static/api/1/dropbox.js"></script>
  <script type="text/javascript">
    function initDropbox(inp){
      Dropbox.choose({success:function(files){
          var inputElement = jQuery(inp).data('holder');

          jQuery('#'+inputElement)
            .val(JSON.stringify({link: files[0].link,name: files[0].name, provider: 'dropbox'}))
            .data('filename', files[0].name)
            .data('provider', 'Dropbox');
          if(jQuery("#attachment-type").data('multifile-enable')==true)
          {
            Helpdesk.MultifileUpload.addFileToList(jQuery('#'+inputElement));
            newInput = Helpdesk.MultifileUpload.duplicateInput(jQuery('#'+inputElement));
            jQuery(inp).data('holder',newInput.attr('id'));
          }
          else
          {
            Helpdesk.Multifile.addFileToList(jQuery('#'+inputElement));
            newInput = Helpdesk.Multifile.duplicateInput(jQuery('#'+inputElement));
            jQuery(inp).data('holder',newInput.attr('id'));
          }
      }, extensions:""})
    }
  </script>
<% end %>