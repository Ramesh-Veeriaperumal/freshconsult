<% content_for :helpcard do %><div class="helpcard"><%=t('integrations.google_contacts.edit_helptext').html_safe%></div><% end %>
<h3 class="title"><%=t("integrations.google_contacts.edit_form.#{@omniauth_origin}_title").html_safe%></h3>
<%= form_for @google_account, :url => { :controller=> "integrations/google_accounts", :action => "update" }, method: :put do |f|  %>
	<ul class="ui-form google_accounts">
			
			<div class="error alert hide" id="error_display"></div>
		<h4 class="title"><%=t('integrations.google_contacts.edit_form.mail_box_detail').html_safe%> <%=@google_account.name%> ( <%=@google_account.email%> )</h4>
		
		<fieldset>
			<legend><%=t('integrations.google_contacts.edit_form.import_group').html_safe%></legend>
			<div class="fields">
				<%@google_groups.each {|gg| %>
					<label class="checkwrapper"><%=check_box_tag "integrations_google_account[import_groups][]", gg.group_id%><%=gg.name%></label>
				<%}%>
			</div>

		</fieldset>
		
		<fieldset>
			<legend><%=t('integrations.google_contacts.tag')%></legend>
			<div class="fields">
				<label class="caption" for="integrations_google_account_sync_tag"><%=t('integrations.google_contacts.tag_label')%></label>
				<%=text_field_tag "integrations_google_account[sync_tag]", @google_account.sync_tag.blank? ? "gmail": @google_account.sync_tag, :onchange=>"tag_changed()" ,  "data-placement" => "right", :class=>"form-tooltip mini", :title => t("integrations.google_contacts.info1")%>
			</div>
			
			<div class="special-notice">
				<%=t('integrations.google_contacts.sync_group_info', :group_name => h(@google_account.sync_group_name)).html_safe%>
			</div>

			<div class="fields">
				<label>
				    <%=t("integrations.google_contacts.overwrite_existing_user")%> <%=check_box_tag "integrations_google_account[overwrite_existing_user]", 1, true, :class => 'iphone' , "data-active-text" => "Yes", "data-inactive-text" => "No" %>
					
				</label>
			</div>

		</fieldset>
		<li class="inline-field">
			<div class="fields">
				<label id="tag_usage_status">
					<% tag_to_acc_map = {}
					@existing_google_accounts.each { |g_account|
						s_tag = g_account.sync_tag
						unless s_tag.blank?
							tag_to_acc_map[s_tag] = [] if tag_to_acc_map[s_tag].blank?
							tag_to_acc_map[s_tag].push(g_account.email)
						end
					}%>
					<%=javascript_tag "var tag_to_acc_map = #{tag_to_acc_map.to_json.html_safe}" %>
				</label>
			</div>
		</li>
		
		

	<%=f.hidden_field :sync_group_id%>
	<%=f.hidden_field :sync_group_name%>
	<%=hidden_field_tag :omniauth_origin, :omniauth_origin, :value => @omniauth_origin %>
	<%=f.hidden_field :id %>
	<%=f.hidden_field :name %>
	<%=f.hidden_field :email %>
	<%if @google_account.id.blank?%>
		<%=f.hidden_field :token %>
		<%=f.hidden_field :secret %>
	<%end%>
	<div class="button-container">
		<%= f.submit t("integrations.google_contacts.#{@omniauth_origin}"), :class => "uiButton special" %>
	</div>
<%end%>
 
<script type="text/javascript">
/*    function group_changed(evt) {
		group_select_field = $('integrations_google_account_sync_group_id')
		sidx = group_select_field.selectedIndex
		if (sidx > -1) {
			group_name = group_select_field[sidx].innerHTML
			$('integrations_google_account_sync_group_name').value = group_name
			$('integrations_google_account_sync_tag').value = "gmail-"+group_name.toLowerCase().replace(" ", "-");
		}
	}
*/
		var check_box_count = 0;
    function tag_changed(evt){
		sync_tag_field = $('integrations_google_account_sync_tag')
		tag_using_accs = tag_to_acc_map[sync_tag_field.value] || "None of the accounts";
		tag_usage_status_field = $('tag_usage_status')
		// tag_usage_status_field.innerHTML = tag_using_accs+' sharing the same tag for syncing.'
	}

	jQuery('#integrations_google_account_submit').on('click', function(e) {
  	jQuery(".fields #integrations_google_account_import_groups_").each(function(index,obj){
  		if(obj.checked){
  			check_box_count += 1;
  		}
  	});
  	if (check_box_count == 0)
  	{
  		e.preventDefault();
  		return jQuery("#error_display").text( "Please select a group" ).show();
  	}
	});
</script>
