
<div class="queues-wrapper">
	<h1 class='wi'>Queues</h1>
	<% javascript_tag do -%>
	  jQuery('.header').hide();
	<% end %>
	

	  <p class='intro'>The list below contains all the registered queues with the number of jobs currently in the queue. </p>
	  <table class="queues-table" border="1">
	    <tr>
	      <th>Name</th>
	      <th>Jobs</th>
	      <th>Failed Jobs</th>
	    </tr>
	    <% for queue in Resque.queues.sort_by { |q| q.to_s } %>
		    <tr>
		      <td class='queue'><%= queue %></td>
		      <td class='size'><%= Resque.size queue %></td>
		      <td class="failed_inqueue"> <%= link_to "Failed" , admin_resque_failed_show_path(:queue_name => queue) %></td>
		    </tr>
	    <% end %>
	    <tr class="<%= Resque::Failure.count.zero? ? "failed" : "failure" %>">
	      <td class='queue failed'><%= link_to "Failed" , admin_resque_failed_index_path() %></td>
	      <td class='size'><%= Resque::Failure.count %></td>
	      <td></td>
	    </tr>
	  </table>
	  <%
	    workers = Resque.working
	    jobs = workers.collect {|w| w.job }
	    worker_jobs = workers.zip(jobs)
	    worker_jobs = worker_jobs.reject { |w, j| w.idle? || j.empty? }
	  %>

	  <h1 class='wi'><%= worker_jobs.size %> of <%= Resque.workers.size %> Workers Working</h1>
	  <p class='intro'>The list below contains all workers which are currently running a job.</p>
	  <table class='workers' border="1">
	    <tr>
	      <th>Where</th>
	      <th>Queue</th>
	      <th>Processing</th>
	    </tr>
	    <% if worker_jobs.empty? %>
	    <tr>
	      <td colspan="4" class='no-data'>Nothing is happening right now...</td>
	    </tr>
	    <% end %>

	    <% worker_jobs.sort_by {|w, j| j['run_at'] || '' }.each do |worker, job| %>
	      <tr>
	        
	        <% host, pid, queues = worker.to_s.split(':') %>
	        <td class='where'><%= host %>:<%= pid %></td>
	        <td class='queues queue'>
	          <%= job['queue'] %>
	        </td>
	        <td class='process'>
	          <% if job['queue'] %>
	            <code><%= job['payload']['class'] %></code>
	            <small id="worker_time"><%= job['run_at'] %></small>
	          <% else %>
	            <span class='waiting'>Waiting for a job...</span>
	          <% end %>
	        </td>
	      </tr>
	    <% end %>
	  </table>
</div>