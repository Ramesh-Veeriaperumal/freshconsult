<%
  current_plan_id = current_account.subscription.subscription_plan_id
  subscribed_plan = current_account.subscription.subscription_plan
  current_plan_name = subscribed_plan.name.downcase
  current_plan_ranking = SubscriptionsHelper::PLAN_RANKING["#{current_plan_name}"] || 0 # default rank as zero
  has_credit_card = current_account.has_credit_card?
  field_agent_limit = @subscription.field_agents_display_count
  fluffyMinLevelEnabled = current_account.fluffy_min_level_enabled?
  omni_account = current_account.omni_bundle_account?
  freddy_enabled = current_account.freddy_self_service_enabled? || current_account.freddy_ultimate_enabled?
  freddy_option = ''
  if freddy_enabled && !current_account.freddy_ultimate_enabled?
    freddy_option = 'freddy_self_service'
  elsif freddy_enabled && current_account.freddy_ultimate_enabled?
    freddy_option = 'freddy_ultimate'
  end
%>
<div id="ChangePlan">
  <div class="plans <%='omni_change_plan' if omni_account%>">
    <table>
      <tr>
        <% plans.each do |plan| %>
          <input type="hidden" data-omni-plan-id="<%= plan.name.parameterize.underscore %>" data-plan-amount="<%= fetch_plan_amount(plan) %>" data-plan-id="<%= plan.id %>"/>
          <%
            next if !omni_account && !(subscription.trial? || subscription.suspended?) &&
              ((subscribed_plan.omni_plan? && subscribed_plan.basic_variant_name == plan.name) ||
              (subscribed_plan.basic_variant? && subscribed_plan.omni_plan_name == plan.name))
            plan_name = plan.name.downcase.split(' ').first
            plan_name_id = plan.name.parameterize.underscore
            plan_ranking = SubscriptionsHelper::PLAN_RANKING["#{plan.name.downcase}"] || 0 # default rank as zero
            downgrade_plan_check = plan_ranking > current_plan_ranking
            plan_has_omni = plan.omni_plan? || plan.free_omni_channel_plan?
            subscribed_to_omni = subscribed_plan.omni_plan? || subscribed_plan.free_omni_channel_plan?
            show_omni_downgrade = subscribed_to_omni ? (plan_has_omni ? false : true) : false
            is_new_sprout = new_sprout?(plan.name)
            equal_plan_check = (plan_ranking == current_plan_ranking) && (current_plan_name != plan.name.downcase)
            is_active = (plan.id == current_plan_id) || (subscribed_plan.omni_plan? &&
              (subscribed_plan.basic_variant_name == plan.name)) || (subscribed_plan.omni_plan_name == plan.name)
            omniFilter = "omni"
          %>
          <% unless plan_name == "free"  %>
            <% unless (plan.id == subscription.subscription_plan_id and !omni_account) and !subscription.trial? and !show_all%>
              <td class="pricelist <%= plan_name %> <%= is_active ? 'active' : ''%> <%= plan_name_id.include?(omniFilter) && !omni_account ? 'hide' : ''%>"
                  id = "plan-<%= plan_name_id %>" width='<%="#{(100/(plans.size.to_f)).to_i}%"%>'>
                  <input type="hidden" data-omni-plan-id="<%=plan_name_id%>" data-plan-amount="<%= fetch_plan_amount(plan) %>" data-plan-id="<%= plan.id %>"/>
                  <!--# Allow subscription to be updated to current plan omni variant. eg. Estate Jan 19 to Estate Omni Jan 19 -->
                  <% old_plan_omni_added = false %>
                  <% if !old_plan_omni_added && subscribed_plan.classic && subscribed_plan.basic_variant? %>
                     <% old_plan_omni = subscribed_plan.omni_plan_variant %>
                     <input type="hidden" data-omni-plan-id="<%= old_plan_omni.name.parameterize.underscore %>" data-plan-amount="<%= fetch_plan_amount(old_plan_omni) %>" data-plan-id="<%= old_plan_omni.id %>"/>
                     <% old_plan_omni_added = true %>
                  <% end %>
                  <div class="plan-details">
                    <div class="plan-title">
                      <% bool_beta_plan = (plan_name == "premium" && @discount  && @discount.name.downcase == "beta users special") %>
                      <%= content_tag(:h2, plan.display_name, :class => "lead") %>
                      <div class="plan-brief"></div>
                      <% if(bool_beta_plan) %>
                        <%= content_tag(:h3, "<span class='discount-strikethrough'>$29 </span> $19 " +  content_tag(:span, t('plan_amount'), :class => "info-data")) %>
                      <% else %>
                        <% if plan_name.include?("sprout") %>
                          <%= content_tag(:h3, "Free", :class => "plan-cost") %>
                          <%= content_tag(:div, t('free_plan_agents_v2').html_safe, :class => "info-data") %>
                        <% else %>
                          <% if omni_account %>
                            <div class="omni_plan_pricing">
                              <h3 class="bundle-price"><%= fetch_plan_amount(plan) %></h3>
                            </div>
                          <% else %>
                            <%= content_tag(:h3, fetch_plan_amount(plan), :class => "plan-cost") %>
                          <% end %>
                          <%= content_tag(:div, t('billed_annually'), :class => "info-data") %>
                        <% end %>
                      <% end %>
                      <%= content_tag(:div, (plan_name == "premium") ? t("special_beta_offer") : "&nbsp;".html_safe, :class => "discount-info-text" ) if(@discount && @discount.name.downcase == "beta users special")  %>
                    </div>
                    <%
                      plan_name = plan.name.downcase.split(' ').first
                      basic_plan = (plan_name === 'sprout' || (omni_account && plan_name === 'estate')) || false
                    %>
                    <p class="plan-details plan-feature-list <%='basic_plan' if basic_plan %> <%='hide_first_feature' if omni_account && basic_plan %>">
                      <% unless SubscriptionsHelper::PLANS_FEATURES["#{plan.name.downcase}"].nil? %>
                        <%
                          if (omni_account)
                            omni_features_list = SubscriptionsHelper::IMPORTANT_OMNI_FEATURES["#{plan.name.downcase}"].clone.map{ |x| x.to_s }
                          end
                          plans_features = SubscriptionsHelper::PLANS_FEATURES["#{plan.name.downcase}"].clone
                          features_list = omni_account ? plans_features.insert(plans_features.length - 2, *omni_features_list) : plans_features
                        %>
                        <% features_list.each do |feature_name| %>
                          <% if feature_name == "omni_channel_option" || feature_name == "omni_channel_option_basic" %>
                            <%= render :partial => "/subscriptions/features/info-box/ocr_info", :locals => { :plan => plan,
                              :feature_name => feature_name }%>
                          <% elsif feature_name == "fsm_option" %>
                            <%= render :partial => "/subscriptions/features/info-box/fsm_info", :locals => { :plan => plan,
                              :feature_name => feature_name }%>
                          <% else %>

                                 <% if feature_name.include? "api_rate_limit_"%>
                                  <% if fluffyMinLevelEnabled %>
                                     <span><%= t("features.#{feature_name}").html_safe %></span>
                                  <% end %>
                                <% else %>
                                  <span><%= t("features.#{feature_name}").html_safe %></span>
                               <% end %>

                          <% end %>
                        <% end %>
                      <% end %>
                    </p>
                    <%= render :partial => "/subscriptions/features/features_toggle", :locals => { :plan => plan,
                      :plan_name_id => plan_name_id }%>
                  </div>
                  <% subscribe_direct_flag =  (current_account.full_time_support_agents.count) <= plan.free_agents %>
                  <% request_change = (@subscription.state == 'active' && current_account.launched?(:downgrade_policy) && @subscription.cost_per_agent != 0 && (@subscription.agent_limit > @subscription.free_agents) ) ? 'request_change' : 'activate_free_plan'%>
                  <% if is_new_sprout %>

                    <% if current_account.launched?(:downgrade_policy) && @subscription.subscription_request.present? && @subscription.cost_per_agent != 0  %>
                     <button  data-id="#confirm-message-<%= plan.id %>" class="btn btn-flat sprout-second-downgrade-modal" title="" data-submit-label="<%= t('request_change') %>" data-submit-class="btn btn-primary sprout-downgrade"> <%= t('choose_plan') %></button>

                      <div id="confirm-message-<%= plan.id %>" class="modal hide sprout-form-submit"  aria-hidden="true" role="dialog">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h3 class="ellipsis modal-title"><%= t('downgrade_plan_title') %></h3>
                        </div>
                        <div class="modal-body">
                            <div id="" class="plan-confirm-message">
                              <%= render :partial => "submit_plan",
                                    :locals => {
                                      :agent_limit => "", :plan => plan , :currency => @subscription.currency_name ,
                                      :plan_switch => !@subscription.trial?, :submit_flag => false, :downgrade_message_flag => true ,
                                      :show_omni_warning => show_omni_downgrade,
                                      :downgrade_msg => t(subscription.trial? ? 'sprout_free_plan_v2' : 'downgrade_confirm_v2', :current_plan => current_account.subscription.subscription_plan.display_name,
                                          :new_plan => plan.display_name)
                                    }
                              %>
                            </div>
                        </div>
                        <div class="modal-footer mt12">
                           <button class="btn btn-secondary" data-dismiss="modal" aria-hidden="true"><%= t("account.cancel") %></button>
                           <button id="sprout-downgrade-submit" class="btn btn-primary" data-dismiss="modal" aria-hidden="true" >
                            <%= t(request_change) %></button>
                        </div>
                      </div>
                      <div id="sprout-downgrade-modal-show" class="modal hide second-downgrade-modal-wrapper"  aria-hidden="true" role="dialog">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                              <h3 class="downgrade-header mt14"><%= t("downgrade.header_txt") %></h3>
                          </div>
                        <%= render :partial => "second_time_downgrade_modal" ,:locals => { :new_sprout => is_new_sprout , :sprout_plan => plan.name, :sprout_plan_display_name => plan.display_name, :actual_plan => plan } %>
                        <div class="modal-footer mt12">
                          <button class="downgrade-btn btn-secondary" data-dismiss="modal" aria-hidden="true"><%= t("account.cancel") %></button>
                          <button id="downgrade-sprout-btn" class="downgrade-btn btn-primary" data-dismiss="modal" aria-hidden="true"><%= t("downgrade.confirm_btn") %></button>
                        </div>
                      </div>
                    <% else %>
                      <%= plan_button(plan, t('choose_plan'), "free-plan-button btn btn-flat", subscribe_direct_flag, true, equal_plan_check ? t('change_equal_plan_title', :to_plan => plan.display_name): t(subscription.trial? ? 'change_plan_title' : 'downgrade_plan_title'),
                        t(request_change, :name => plan.display_name), t('cancel') ) %>
                        <div id="confirm-message-<%= plan.id %>" class="plan-confirm-message hide">
                          <%= render :partial => "submit_plan",
                                :locals => {
                                  :agent_limit => "", :plan => plan , :currency => @subscription.currency_name ,
                                  :plan_switch => !@subscription.trial?, :submit_flag => false, :downgrade_message_flag => true ,
                                  :show_omni_warning => show_omni_downgrade,
                                  :downgrade_msg => t(subscription.trial? ? 'sprout_free_plan_v2' : 'downgrade_confirm_v2', :current_plan => current_account.subscription.subscription_plan.display_name,
                                      :new_plan => plan.display_name)
                                }
                            %>
                        </div>
                  <% end %>
                  <% else %>
                    <% if subscribe_direct_flag %>
                      <!-- By default it will be hidden. Will be shown once Choose plan button is clicked. Showing part Handled in js -->
                      <!-- activate-options class has css display:none -->
                      <div class="activate-options">
                        <hr class="billing-divider" />
                        <h5 class="lead">
                          <%= "#{plan.free_agents} Agents Free" %>
                        </h5>
                        <div class="add-more">
                          <a href="javascript:;" data-plan="<%= plan_name_id %>" data-plan-id = "<%= plan.id %>" class="plan-button1" id='<%= "#{ plan_name_id }_button" %>' data-current-plan=false><%= t("add_more_free", :free_agents => plan.free_agents) %></a>
                        </div>
                        <hr class="billing-divider" />
                        <h5 class="billing-total-cost lead">
                          <%= "#{t('total_price')} : <strong>#{format_amount(0, @subscription.currency_name)}</strong>".html_safe %>
                        </h5>
                        <% unless has_credit_card %>
                          <div class="currency-note"><span class="arrow-up"></span>
                            <%= t('subscription.free_plan_currency_note') %> <%= @subscription.currency_name %>
                          </div>
                        <% end %>
                        <div class="billing-actions">
                          <% downgrade_confirm = ((plan_ranking < current_plan_ranking) or current_account.subscription.classic? ) ? true : false %>
                          <% if downgrade_confirm %>

                            <%= plan_button(plan, t('activate_free_plan'), "free-plan-button btn btn-flat", subscribe_direct_flag, true, t('change_plan_title'), t('confirm'), t('cancel') ) %>

                            <div id="confirm-message-<%= plan.id %>" class="plan-confirm-message hide">
                              <%= render :partial => "submit_plan",
                                    :locals => {
                                      :agent_limit => plan.free_agents , :plan => plan ,
                                      :currency => @subscription.currency_name , :plan_switch => false,
                                      :show_omni_warning => show_omni_downgrade,
                                      :field_agent_limit => field_agent_limit,
                                      :submit_flag => false, :downgrade_message_flag => true ,
                                      :downgrade_msg => I18n.t('sprout_free_plan_v2', :current_plan =>current_account.subscription.subscription_plan.display_name, :new_plan => plan.display_name)
                                    }
                              %>
                            </div>
                          <% else %>
                            <%= render :partial => "submit_plan",
                                  :locals => {
                                    :agent_limit => plan.free_agents , :plan => plan ,
                                    :show_omni_warning => show_omni_downgrade,
                                    :field_agent_limit => field_agent_limit,
                                    :currency => @subscription.currency_name , :plan_switch => false,
                                    :submit_flag => true, :downgrade_message_flag => false
                                  }
                            %>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                    <% if subscription.trial? %>
                      <% if current_plan_id == plan.id || (plan_name == "sprout" && subscribe_direct_flag) || is_active %>
                        <%= plan_button(plan, plan_name == "sprout" ? t('choose_plan') : t('change_my_plan'), "trial-plan-change btn btn-flat", subscribe_direct_flag, false) %>
                      <% elsif plan_name == "sprout" %>
                        <%= plan_button(plan, t('choose_plan'), "downgrade-plan-button btn btn-flat", subscribe_direct_flag, true,
                          t('change_plan_title'), t('confirm'), t('cancel'), "downgrade-modal" ) %>

                        <div id="confirm-message-<%= plan.id %>" class="plan-confirm-message hide">
                          <%= render :partial => "downgrade_feature_loss",
                                :locals => {
                                  :downgrade_msg => t('downgrade_to_sprout_v2', :current_plan => current_account.subscription.subscription_plan.display_name, :new_plan => plan.display_name ).html_safe,
                                  :current_plan_name => current_account.subscription.subscription_plan.display_name.upcase,
                                  :current_plan => current_plan_name,
                                  :plan => plan
                                }
                          %>
                        </div>
                      <% elsif downgrade_plan_check %>
                        <%= render :partial => "submit_plan",
                              :locals => {
                                :agent_limit => "", :plan => plan , :currency => @subscription.currency_name ,
                                :show_omni_warning => show_omni_downgrade,
                                :field_agent_limit => field_agent_limit,
                                :plan_switch => true, :submit_flag => true, :downgrade_message_flag => false
                              }
                        %>
                      <% else %>
                        <%= plan_button(plan, t('choose_plan'), "btn btn-flat", subscribe_direct_flag, true, equal_plan_check ? t('change_equal_plan_title', :to_plan => plan.display_name) : t('change_plan_title'),
                            t(equal_plan_check ? 'trial_plan_name_v2' : 'trial_plan_name', :name => plan.display_name), t('cancel') ) %>

                        <div id="confirm-message-<%= plan.id %>" class="plan-confirm-message hide">
                          <%= render :partial => "submit_plan",
                                :locals => {
                                  :agent_limit => "", :plan => plan , :currency => @subscription.currency_name ,
                                  :show_omni_warning => show_omni_downgrade,
                                  :plan_switch => true, :submit_flag => false, :downgrade_message_flag => true ,
                                  :field_agent_limit => field_agent_limit,
                                  :downgrade_msg => t('downgrade_confirm_v2', :current_plan => current_account.subscription.subscription_plan.display_name,
                                      :new_plan => plan.display_name)
                                }
                          %>
                        </div>
                      <% end %>
                    <% elsif subscription.active? %>
                      <% if downgrade_plan_check || subscribe_direct_flag %>
                        <%= plan_button(plan, t('choose_plan'), "plan-button btn btn-flat", subscribe_direct_flag, false) %>
                      <% else %>
                        <% if plan.id === subscription.subscription_plan_id && omni_account %>
                          <button class='btn btn-flat current-plan-disabled' disabled><%= t('current_plan') %></button>
                        <% else %>
                          <%= plan_button(plan, t('choose_plan'), "downgrade-plan-button btn btn-flat", subscribe_direct_flag, true,
                            equal_plan_check ? t('change_equal_plan_title', :to_plan => plan.display_name) : t('downgrade_plan_title'), t('proceed_billing_info'), t('cancel'), "downgrade-modal" ) %>

                          <div id="confirm-message-<%= plan.id %>" class="plan-confirm-message hide">
                            <%= render "downgrade_feature_loss",
                                {
                                  :downgrade_msg => t('downgrade_confirm_v2', :current_plan => current_account.subscription.subscription_plan.display_name, :new_plan => plan.display_name ).html_safe,
                                  :current_plan_name => current_account.subscription.subscription_plan.display_name.upcase,
                                  :current_plan => current_plan_name,
                                  :plan => plan,
                                  :show_omni_warning => show_omni_downgrade
                                }
                            %>
                          </div>
                        <% end %>
                      <% end %>
                    <% elsif subscription.suspended? %>
                      <% if (plan_ranking >= current_plan_ranking || subscribe_direct_flag) && !equal_plan_check%>
                        <%= plan_button(plan, t('choose_plan'), "suspended-plan-button btn btn-flat", subscribe_direct_flag, false) %>
                      <% else %>
                        <%= plan_button(plan, t('choose_plan'), "downgrade-plan-button btn btn-flat", subscribe_direct_flag, true,
                          equal_plan_check ? t('change_equal_plan_title', :to_plan => plan.display_name) : t('downgrade_plan_title'), t('proceed_billing_info'), t('cancel'), "downgrade-modal" ) %>

                        <div id="confirm-message-<%= plan.id %>" class="plan-confirm-message hide">
                          <%= render :partial => "downgrade_feature_loss",
                                :locals => {
                                  :downgrade_msg => t('downgrade_confirm_v2', :current_plan => current_account.subscription.subscription_plan.display_name, :new_plan => plan.display_name ).html_safe,
                                  :current_plan_name => current_account.subscription.subscription_plan.display_name.upcase,
                                  :current_plan => current_plan_name,
                                  :plan => plan,
                                  :show_omni_warning => show_omni_downgrade
                                }
                          %>
                        </div>
                      <% end %>
                    <% end %>
                    <div id="billing-<%= plan_name_id %>"></div>
                  <% end %>
              </td>
            <% end %>
          <% else %>
            <% @free_plan_id = plan.id %>
          <% end %>
      <%end%>
      </tr>
    </table>

  </div>
</div>
<%= render :partial => "subscriptions/features/dialogs/fsm_disable", :locals => {
  :current_account => current_account, :identifier => 'fsm-billing-change' } %>

<div id="billing-template" class="billing hide" >
  <%= render :partial => "calculate_amount", :locals => { :amount => 0, :discount => nil, :monthly_amount => 0 } %>
</div>

<script type="text/javascript">

  if(App.SelectPlan != undefined){ App.SelectPlan.destroy() }
    let planInfo = {
      currency_name: '<%= @subscription.currency_name %>',
      renewal_period: <%= @subscription.renewal_period %>,
      subscribed_plan_id: <%= @subscription.subscription_plan.id %>,
      agent_limit: <%= @subscription.agent_limit || 0 %>,
      fsm_agent_limit: <%= @subscription.field_agent_limit || 0 %>,
      downgrade_policy_launched: <%= current_account.launched?(:downgrade_policy) %>,
      subscribed_plan_name: '<%= current_account.plan_name %>',
      fsm_enabled: <%= current_account.field_service_management_enabled? %>,
      freddy_enabled: <%= freddy_enabled %>,
      freddy_option: '<%= freddy_option %>',
      freddy_session_pack: <%= @subscription.freddy_session_packs || 0 %>,
      subscription_state: '<%= @subscription.state %>',
      has_account_cancellation_request: <%= current_account.account_cancellation_requested? %>,
      free_agents_count: <%= @subscription.free_agents %>,
      is_omni_plan: <%= subscribed_plan.omni_plan? %>
    };

  App.SelectPlan.initialize(planInfo);

</script>
