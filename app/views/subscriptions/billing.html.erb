<% content_for :helpcard do -%>
	<% if @subscription.trial? or @subscription.trial_expired? %>
		<div class="sidepanel"> 
			<h3 class="title"><%= t("accounts.billing.billing").html_safe %></h3>
			<p><%= t("accounts.billing.begin_subscription_info").html_safe %></p>
		</div>
	<% end %>
<%- end %>

<h3 class= "title"><%= @page_title = t('plans_billing').html_safe %></h3>
<%= form_for :creditcard, @creditcard, :url => { :action => 'billing' }, :html => {
		:id => "credit-card-form"} do |f| %>
	<ul class="ui-form">
		<li class="inline-field">  
			<% if @subscription.trial? or @subscription.trial_expired?  %>
				<div class="info-highlight"> 
					<h3 class="title">
  					<%= t('current_plan_details', :plan_name  => @subscription.subscription_plan.name, :agent_limit => @subscription.agent_limit).html_safe %>
					</h3>	
					<% if @subscription.amount > 0 %>			
					<%= get_payment_string( @subscription.renewal_period,@subscription.amount.to_i ) %>
					<%end%>
					<%= t('currency_note').html_safe %>		
				</div>
			<% end %>
			<%= content_tag(:h3, t("credit_card_info").html_safe, :class => "title") %>
		   	<%= render :partial => 'shared/credit_card_form' %>
				<%= hidden_field_tag :charge_now, "false", :id => "chargenow" %>
				<span class="seperator"></span>
				<div class="button-container">
					<% if @subscription.trial? or @subscription.trial_expired? %>
						<%= link_to( "&larr; #{t('select_another_plan')}".html_safe, subscription_url, :class => "btn floatl" ) %>
						<%= submit_tag t('accounts.billing.begin_subscription'), :class => "uiButton special", :id => "begin_subscription", "data-loading-text" => t('please_wait') %>	
					<% else %>
						<%= link_to( "&larr; #{t("cancel_and_back")}".html_safe, subscription_url, :class => "btn floatl" ) %>
						<%= submit_tag t('accounts.billing.update_billing_info'), :class => "uiButton", "data-loading-text" => t('please_wait') %>
					<% end %>
				</div>
		</li>
	</ul> 
<% end %>
<% content_for :pagefixed do %>
	<%= javascript_tag do %>
		jQuery("#begin_subscription")
			.click(function(){
				if (jQuery('#credit-card-form').valid()) {
					$("chargenow").value = true;
					<%if @subscription.amount.to_i == 0 %>
					  return true;
					<%end%>
					return confirm("<%= t('begin_subscription_confirm', :cost => format_amount(@subscription.amount.to_i, @subscription.currency_name) ) %>") ;
				}
			});
		jQuery('body').on('click', '.uiButton', function(){
			if (jQuery('#credit-card-form').valid()) {
				jQuery(this).button('loading');
			}
		});
	<% end %>
	<script type="text/javascript" src="https://js.braintreegateway.com/v1/braintree.js"></script>
	<script type="text/javascript">
		var braintree = Braintree.create("<%= BraintreeConfig["client_side_encryption_key"][Rails.env] %>")
		braintree.onSubmitEncryptForm("credit-card-form");
	</script>

<% end %>