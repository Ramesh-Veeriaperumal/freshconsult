<% content_for :pagetop do -%>
  <% if @ticket.deleted %>
    <div class="alert-message block-message warning">
      <div class="alert-actions-right">
        <%= link_to(t('ticket.restore_btn'), restore_helpdesk_ticket_path(@ticket), :method => :put, :class => "btn small", :title => t('ticket.restore_btn_title') ) %>
      </div>
      <p><strong><%= t('this_ticket_has_been_deleted') %></strong></p>
    </div>
  <% end %>  
<% end %>
 
  <div class="request_details">
    <div class="requestCnt request-cnt-first">
      <div class="request-title">
        <%= content_tag :span, h(@ticket.priority_name), :class => "priority-pointer #{@ticket.priority_key}" %>
        <%= content_tag :span, "##{h(@ticket.display_id)}", :class => "ticket-id" %>
        <%= content_tag :span, h(@ticket.subject), :class => "subject" %>
        <%
                customer_opinion = ""                                
                unless @ticket.survey_result.nil? || @ticket.survey_result.last.nil?
                  customer_opinion = ["<div class='customer-opinion ", @ticket.survey_result.last.get_small_img_class ,"'></div>"].join
                end  
        %>
        <%=customer_opinion%>

        <div id="adjacents"></div>
      </div>
			<div class="description">         
        <div class="user_details">
			    <%= user_avatar(@ticket.requester)  %>
			    <% if is_application_installed?("capsule_crm") %>
				    <textarea id="widget-capsule-crm" style="display:none;">
					    <% @liquid_objects = {"requester" => @ticket.requester} %>
				 	    <%= get_app_widget_script("capsule_crm", "contact_widget", @liquid_objects) %>
				    </textarea>
				    <div class="app-link">
					    <a data-placement="topRight" href="#" rel="widget-popover" data-widget-container="widget-capsule-crm">
						    <%= image_tag("application-logo/capsule_crm-small.png") %>
					    </a>
				    </div> 
	        <% end %>
          
          <textarea id="contact-hovercard" style="display:none;">
            <div class="contact_hover">
              <%= user_avatar(@ticket.requester) %>
              <%= content_tag :div, link_to(h(@ticket.requester.display_name), @ticket.requester), :class => "user_name" %>

              <div class="user_desig">
                <%= render :partial => "helpdesk/tickets/components/company_info", :locals => { :user => @ticket.requester } %>
              </div>

              <%= content_tag :div, h(@ticket.requester.email), :class => "user_email" unless @ticket.requester.email.blank?  %>
              <%= content_tag :div,"", :class => "clearfix" unless @ticket.requester.email.blank? and @ticket.requester.customer.blank?  %>
              <% is_desig_and_email_available = @ticket.requester.email.blank? and @ticket.requester.customer.blank? %>
              <%=  '<div>' if is_desig_and_email_available %>
                  <%= content_tag :div, h(@ticket.requester.twitter_id), :class => "user_twitter" unless @ticket.requester.twitter_id.blank?  %>
              <%= '</div>' if is_desig_and_email_available %>
              
              <div class="clearfix"></div>
                <%= content_tag :div, h(@ticket.requester.phone), :class => "user_phone" unless @ticket.requester.phone.blank?  %>
                <%= content_tag :div, h(@ticket.requester.mobile), :class => "user_mobile" unless @ticket.requester.mobile.blank?  %>
            </div>
          </textarea>

           <%
                          contact = @ticket.requester
                          contact = "javascript:void(0)" unless current_user.can_view_all_tickets?
          %>
 
          <%= link_to( h(@ticket.requester.display_name), contact, :class => "user_name", "data-placement" => "topRight", :rel => "hover-popover", "data-widget-container" => "contact-hovercard" )%>
          
          <%= "&lt;#{@ticket.requester.email}&gt;" if @ticket.requester.email %> 
          on <%= formated_date(@ticket.created_at) %>
          <div class="info"> 
            <%if @to_emails && @to_emails.length > 0 %>                        
                  <%if @to_emails.length < 3 %>
                      <%= content_tag :span, "To: " + @to_emails.collect{ |to_e| to_e.gsub("<","&lt;").gsub(">","&gt;") }.join(", "), :class => "" if (@ticket.source == (Helpdesk::Ticket::SOURCE_KEYS_BY_TOKEN[:email])) %>  
                  <% else %>
                      <%= content_tag :span, "To: " + @to_emails[0,2].collect{ |to_e| to_e.gsub("<","&lt;").gsub(">","&gt;") }.join(", ") + "<span class='toEmailMoreContainer hide'>,&nbsp;"+ @to_emails[2,@to_emails.length].collect{ |to_e| to_e.gsub("<","&lt;").gsub(">","&gt;") }.join(", ") +" </span> <a href='javascript:showHideToEmailContainer();'  class='toEmailMoreLink'> #{@to_emails.length-2} "+t('ticket_cc_email_more')+"</a>", :class => "" if (@ticket.source == (Helpdesk::Ticket::SOURCE_KEYS_BY_TOKEN[:email])) %>  
                  <% end %>
            <% end %> 
            via <%= @ticket.source_name %>
            <% metainfo = @ticket.notes.find_by_source(Helpdesk::Note::SOURCE_KEYS_BY_TOKEN["meta"]) %> 
          <%= content_tag :span, t("helpdesk.tickets.show.meta"), :title => metainfo.body, :class => "meta_icon tooltip" unless(metainfo.blank?) %>
          </div> 
		  <% cc_email_hash_value = @ticket.cc_email_hash %>
          <% unless cc_email_hash_value.nil? %>
            <% @cc_email_count = cc_email_hash_value[:cc_emails].length %> 
            <div class="info">
				<%if @cc_email_count > 0 %>            	           
                	<%if @cc_email_count < 3 %>
                  		<%= content_tag :span, "Cc: " + cc_email_hash_value[:cc_emails].collect{ |cc_e| cc_e.gsub("<","&lt;").gsub(">","&gt;") }.join(", "), :class => "" %>  
                	<% else %>
                  		<%= content_tag :span, "Cc: " + cc_email_hash_value[:cc_emails][0,2].collect{ |cc_e| cc_e.gsub("<","&lt;").gsub(">","&gt;") }.join(", ") + "<span class='ccEmailMoreContainer hide'>,&nbsp;"+ cc_email_hash_value[:cc_emails][2,@cc_email_count].collect{ |cc_e| cc_e.gsub("<","&lt;").gsub(">","&gt;") }.join(", ") +" </span> <a href='javascript:showHideEmailContainer();'  class='ccEmailMoreLink'> #{@cc_email_count-2} "+t('ticket_cc_email_more')+"</a>", :class => "" %>  
                	<% end %>
				<% end %>             
            </div>
          <% end %> 
        </div>
        <% unless @ticket.deleted %>
          <div class="ticket_actions">          	
           	<div class="item-right-actions">
        			<ul class="nav-drop"> 
        				<li>
        					<a href="#" class="menu-trigger nav-item-icon"><span class="item-options"></span></a>
                  <ul class="menu-box">
                    <li class="menu-item"> 
                       <%= link_to(t('ticket.edit_btn'), edit_helpdesk_ticket_path(@ticket)  ) %>     
                    </li>	 
                    <li class="menu-item">
                      <%= link_to(t('ticket.delete_btn'), helpdesk_ticket_path({:id => @ticket.display_id, :page => params[:page]}), :method => :delete, :title => t('ticket.delete_btn_title')) %>
                    </li>
                  </ul>
                </li> 
              </ul>
            </div>
            <div class="action_buttons clearfix">
              <%= link_to( "Print", print_helpdesk_ticket_path(@ticket), :target => "_blank") %>
              <%= link_to t('ticket.merge_btn'), "/helpdesk/tickets/show_tickets_from_same_user/#{@ticket.display_id}", :id => "Merge", :title => "Merge ticket", "data-ajax-dialog" => true %>
              <%= link_to(t('ticket.close_btn'), close_helpdesk_ticket_path({:id => @ticket.display_id, :page => params[:page]}), :method => :put, :title  => t('ticket.close_btn_title'), :class => "last") unless @ticket.closed? %> 
            </div>	
            <div class="action_icons floatr"> 
              <% if is_application_installed?("jira")  %>   
                  <%= render :partial => "/helpdesk/integrations/jira_issue"%>
              <% end %>             
              <span id="monitor">
                <%= render :partial => "/helpdesk/subscriptions/monitor" %>
              </span>
              <span id="spamicon">
                <%= render :partial => "spam", :locals => { :ticket => @ticket, :page => params[:page] } %>
              </span>
            </div>
     	    </div>	
        <% end %>
        <div class="request-wrapper">
        <div id="description-full" class="request_mail details min_height">
          <span class="seperator"></span>
          <div class="request_mail">
            <%= @ticket.description_html %>
          </div>
        </div>      
        <% unless @ticket.attachments.empty? %>
          <span class="seperator"></span>
          <h4><%= pluralize(@ticket.attachments.size, t("attachment"), t("attachments")) %></h4>
          <ul class="attachment_list">
            <%= render :partial => '/helpdesk/shared/attachment', :collection => @ticket.attachments, :locals => {:show_delete => true, :url => [@item] } %>
          </ul>
        <% end %>
        <% unless @ticket.ticket_topic.nil? %>
          <div class="info-highlight">
            <%= t("helpdesk.tickets.show.linked_ticket") %>
            "<%= link_to("#{truncate(h(@ticket.topic.title))}", category_forum_topic_path(@ticket.topic.forum.forum_category.id, @ticket.topic.forum.id, @ticket.topic.id), :class => "link_to") %>"
          </div>
        <% end %>
      </div>
    </div>
  </div>