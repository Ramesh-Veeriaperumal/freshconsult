<%
  category_id = "#{field_id}_category"
  sub_category_id = "#{field_id}_sub_category"
  sub_category_item_id = "#{field_id}_item_sub_category"
%>
<% options = options.unshift([t('any'),"-1"]) %>
<%= select_tag name, options_for_select(options.map {|k, v| [CGI.unescapeHTML(k), v.to_s]}, selected_val), 
                    :id => category_id, :class => "dropdown nested_field select2", "data-minimum-results-for-search" => 10 %>
<%
  sub_category  = nested_fields[0] if nested_fields.size > 0
  item  = nested_fields[1] if nested_fields.size > 1
  if !sub_category.nil? && !selected_val.blank?
    category_picklist_value = current_account.ticket_fields.find(field_id).picklist_values.find_by_id(selected_val)
    unless category_picklist_value.nil?
      sub_category[:options] = category_picklist_value.choices
      sub_category[:options].unshift(["...",""])

      sub_category_selected = current_options[sub_category[:condition].to_s]

      if !item.nil? && !sub_category_selected.blank?
        sub_category_picklist_value = category_picklist_value.sub_picklist_values.find_by_id(sub_category_selected) 
        item[:options] = sub_category_picklist_value.choices unless sub_category_picklist_value.nil?
        item[:options].unshift(["...",""])
      end
    end 
  end
%>
<% unless sub_category.nil? %>
  <% content_tag :div,{ :id  => "div_ff_#{sub_category[:condition]}", 
                :class       => "ff_item level_2", 
                :condition   => sub_category[:condition],
                :operator    => sub_category[:operator],
                :ff_name     => sub_category[:ff_name],
                :container   => 'nested_field' } do %>
    <h4 class="title"><%= sub_category[:name].html_safe %></h4>
    <%= select_tag sub_category[:name], "", :id => sub_category_id, 
                  :class => "dropdown nested_field select2", "data-minimum-results-for-search" => 10 %>
  <%end%>
        
  <% unless item.nil? %>
      <% item_val = current_options[item[:condition].to_s].to_s %>
      <% content_tag :div,{ :id => "div_ff_#{item[:condition]}", 
                    :class       => "ff_item level_3", 
                    :condition   => item[:condition],
                    :operator    => item[:operator],
                    :container   => 'nested_field' } do %>
        <h4 class="title"><%= item[:name].html_safe %></h4>
        <%= select_tag item[:name], "", :id => sub_category_item_id, 
                    :class => "dropdown nested_field select2", "data-minimum-results-for-search" => 10 %>
      <% end %>
  <% end %>
  <% javascript_tag do %>
      jQuery('#<%=category_id%>')
        .nested_select_tag({
          initValues: { 
            item_val: '<%= item_val %>',
            subcategory_val: '<%= current_options[sub_category[:condition].to_s].to_s %>',
            category_val: '<%= selected_val %>'            
          },
          include_blank: "Any",
          data_tree: <%= options.to_json.html_safe %>,
          subcategory_id: '<%= sub_category_id %>',
          item_id: '<%= sub_category_item_id %>',
          change_callback: toggle_save_and_refresh
        });
        jQuery('#s2id_<%= category_id %>').live('click', function(){
          jQuery('#s2id_<%= sub_category_id %>').select2("enable");
        });
        jQuery('#s2id_<%= sub_category_id %>').live('click', function(){
          jQuery('#s2id_<%= sub_category_item_id %>').select2("enable");
        });
    <% end %>
<%end%>