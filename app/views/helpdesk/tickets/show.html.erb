<% content_for :sidebar do -%>
     <%= render :partial => "/helpdesk/integrations/crm_widget", :locals => {:user => @ticket.requester} %>
  
  <div class="rtCnt sidepanel ticket-panel">
    <%= ticket_sidebar unless @ticket.deleted %>
  </div>
<%- end %>

<%= render :partial => "ticket_info" %>       

<div class="request-well">			
	<%= ticket_tabs %>        
	<% unless @ticket.deleted %>
		<div class="replylinks">
			<%= link_to_function("<span></span>" + t('ticket.reply_to'), "swapEmailNote('cnt-reply', this)", :id => "ReplyButton", :class => "button email reply") unless @item.from_email.nil? %>
			<%= link_to_function("<span></span>" + t('fwd_to'), "swapEmailNote('cnt-fwd', this)", 
				:id => "FwdButton", :class => "button forward reply") %>
			<%= link_to_function("<span></span>" + t('ticket.reply_to'), "swapEmailNote('cnt-tweet', this)",  :id => "TweetButton", :class => "button tweet reply") if @item.requester && @item.is_twitter?%>
			<%= link_to_function("<span></span>" + t('ticket.reply_to'), "swapEmailNote('cnt-fb-post', this)",  :id => "FacebookButton", :class => "button facebook reply") if @item.requester && @item.is_facebook?%>
			<%= link_to_function(t('ticket.add_note'), "swapEmailNote('cnt-note', this)", :id => "AddNoteButton", :class => "button") %>		
			<%= link_to_function(t("ticket.add_time"), "jQuery('#TimesheetTab').click(); jQuery(this).button('toggle')", :id => "TimeSheetButton", :title => "Add time entry", :class => "button") if feature?(:timesheets) %>
		</div>
	<% end %>
</div>		
<div class="tab-content">
	<div class="requestCnt request-conversation active tab-pane set-top" id="Pages">
		<div id="TicketForms">
		  	<%= render(:partial => '/helpdesk/shared/reply_form', :locals => { :id => 'send-email', :cntid => 'cnt-reply', :note => [@ticket, Helpdesk::Note.new(:private => false)], :conv_id => nil }) %>

		  	<div class="request_panel hide" id="cnt-fwd">
				<%= render(:partial => '/helpdesk/shared/forward_form', :locals => { :id => 'send-fwd-email', :cntid => 'cnt-fwd', :note => [@ticket, Helpdesk::Note.new(:private => true)], :conv_id => nil }) %>
		  	</div>

			<%= render(:partial => '/helpdesk/shared/note_form', :locals => { :id => 'add-note',	:cntid => "cnt-note", :note => [@ticket, Helpdesk::Note.new(:private => true)] }) %>
			<%= render(:partial => '/helpdesk/shared/tweet_form', :locals => { :id => 'send-tweet', :cntid => 'cnt-tweet', :note => [@ticket, Helpdesk::Note.new(:private => true)] }) %>
			<%= render(:partial => '/helpdesk/shared/facebook_form', :locals => { :id => 'send-fb-post', :cntid => 'cnt-fb-post', :note => [@ticket, Helpdesk::Note.new(:private => true)] }) %>
			<% content_for :pagefixed do %> 
				<div class="canned-response-menu hide" id="canned_response_container"> 
				  <div>
				    <%= link_to("Add Canned response", new_admin_canned_response_path, :target => "_blank", :class => "button") if(current_user.admin?) %>
				  </div>
				  <div id="canned_response_list"></div>
				</div>
			<% end %>
		</div> 
		<% unless @ticket_notes.blank? %>
			<%= render :partial => 'note', :collection => @ticket_notes %>
			<%= will_paginate @ticket_notes %>
		<% end %>	
  </div>			  
	<div class="requestCnt request-conversation tab-pane" id="Timesheet">
	  <div class="loading-box"></div>
	</div>
</div>



<% content_for :pagefixed do %> 
  <%= pageless(@ticket_notes.total_pages, helpdesk_ticket_helpdesk_notes_path(@ticket)) %>  
  <%= include_tiny_mce_if_needed %>
	<% javascript_tag do %>
	var activeForm = null;
	swapEmailNote = function(formid, link){  
			jQuery("#PagesTab").click();
			
			if((activeForm != null) && (jQuery(activeForm).get(0).id != formid))
				jQuery("#"+activeForm.get(0).id).hide();


			activeForm = jQuery('#'+formid).show();
			switch(formid){
				case 'cnt-reply':
				case 'cnt-note':
				case 'cnt-fwd':
					insertIntoConversation("");
				break; 
				case 'cnt-fb-post': 
					setCaretToPos($('send-fb-post-cnt-fb-post-body'), 0); 
				break;
				case 'cnt-tweet' : 
					setCaretToPos($('send-tweet-cnt-tweet-body'), 0);
				break;
			}
		}

	var activeTinyMce = null;
    function show_canned_response(button, ticket_id){
      	jQuery("#canned_response_container").css(jQuery(button).offset());

      	activeTinyMce = jQuery(button).data("tinyMceId") || "";
      	
      	jQuery("#canned_response_container")   	
        	.show()
        	.addClass("loading");

      	jQuery("#canned_response_list")
        	.load("/helpdesk/tickets/canned_reponse/"+ticket_id, function(){
          		jQuery("#canned_response_container")
            		.removeClass("loading");
        	})
      		.show();        
    }

    function insetIntoBlankCaret(element_id, value){
    	if(!$(element_id)) return 

    	currentEditItem = tinyMCE.get(element_id);
    	currentEditItemCaret = currentEditItem.dom.select('span#caret_pos_holder')[0];
    	if(!jQuery.browser.msie){
			currentEditItem.selection.select(currentEditItemCaret);
			currentEditItem.dom.remove(currentEditItemCaret);
		}
		tinyMCE.execInstanceCommand(element_id, "mceInsertContent", false, value);
	}
    
	function insertIntoConversation(value, element_id){
		note_area  = jQuery('#cnt-note');
		reply_area = jQuery('#cnt-reply');
		fwd_area = jQuery('#cnt-fwd')
		tweet_area = jQuery('#cnt-tweet');
		if($(element_id)){
			insetIntoBlankCaret(element_id, value);
		}
		else if(note_area.css("display") == 'block'){               
			insetIntoBlankCaret("add-note-cnt-note-body", value);
		} 
		else if(tweet_area.css("display") == 'block'){
			get_short_url(value, function(bitly){
					insertTextAtCursor( $('send-tweet-cnt-tweet-body'), bitly || value );
					jQuery('#send-tweet-cnt-tweet-body')
							.trigger("focus")
							.trigger("keydown");
			});			
		}
		else{
			if(reply_area.css("display") == 'none' && fwd_area.css("display") == 'none')
				jQuery('#ReplyButton').trigger("click");
    		
    		var msg_body_id = reply_area.css("display") == 'none' ? "send-fwd-email-cnt-fwd" : "send-email-cnt-reply";
			insetIntoBlankCaret(msg_body_id+"-body", value);
			//Fix for the viewport scrolling in firefox.
			if(jQuery.browser.mozilla){
				editor =  tinyMCE.get(msg_body_id+"-body");
				viewportBodyElement =  editor.getBody();
				viewportBodyElement.scrollTop = 0;
			}
		}		
		return;
	}
	
  	function showHideEmailContainer(){
  		jQuery(".ccEmailMoreContainer").toggle();
  		if(jQuery(".ccEmailMoreContainer").css("display") == "inline"){
  			jQuery(".ccEmailMoreLink").text('');
  		}
  	}

  	function showHideToEmailContainer(){
  		jQuery(".toEmailMoreContainer").toggle();
  		if(jQuery(".toEmailMoreContainer").css("display") == "inline"){
  			jQuery(".toEmailMoreLink").text('');
  		}
  	}
		
	function getCannedResponse(ticket_id, ca_resp_id){
  		jQuery("#canned_response_container").addClass("loading")
  		jQuery.ajax({	type: 'POST',
  						url: '/helpdesk/tickets/get_ca_response_content/'+ticket_id+'?ca_resp_id='+ca_resp_id,
  						contentType: 'application/text',
  						async: false,
  						success: function(data){		
  							elementId = jQuery("#canned_response_container").data("tinyMceId")

  							insertIntoConversation(data, activeTinyMce);
  							jQuery("#canned_response_list")
  							    .removeClass("loading")
  							    .hide(300);
  							}
  						});
  		return true;
  	}

	function validateMCEData(){
		if(jQuery.browser.opera)
			jQuery('#HelpdeskReply textarea').val(tinyMCE.activeEditor.getContent());
	}
	
  <% end %>

<% end %>

<% content_for :onload_script do -%> 	
	jQuery('#custom_ticket_form').validate();
	<% unless @draft.nil? %>
		jQuery(window).load(function(){jQuery("#ReplyButton").trigger('click');});
	<% end %>
	jQuery.getScript("/helpdesk/tickets/prevnext/<%=@item.display_id%>");
<%- end %>