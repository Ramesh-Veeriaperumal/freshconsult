<!-- Note: when any changes made to TICKET_FORM PARTIAL in the future,
      please update the memcache key version. key_name :: AGENT_NEW_TICKET_FORM  -->

<%= ticket_form.error_messages %>
<% current_portal.ticket_fields_including_nested_fields.each do |field|
    next if field.section_field?
    if is_edit or params[:template_form]
      field_value = @item.send(field.field_name)
      field_value = nested_ticket_field_value(@item, field) if field.field_type == "nested_field"
    elsif field.is_default_field? or !params[:topic_id].blank?
      field_value = @item[field.field_name]
    end
    field_label = ( field.is_default_field? ) ? I18n.t("ticket_fields.fields.#{(field.name)}").html_safe :
                                                (field.label).html_safe
  %>
  <%= construct_new_ticket_element f, :helpdesk_ticket,
                                  field,
                                  field_label,
                                  field.dom_type,
                                  field.required,
                                  field_value,
                                  "",
                                  false,
                                  is_edit  %>

  <% if field.has_section?
    section_container = construct_new_section_fields(f, :helpdesk_ticket, field, is_edit, @item, false) %>
    <%=content_tag(:li, section_container.html_safe)%>
  <% end %>
  <%#= render(:partial => "/shared/nested_fields", :locals => { :ticket => nil, :category => field, :category_field_value =>  field_value, :type => "edit"}) if field.field_type == "nested_field"%>
<% end %>

<% values = params[:template_form] ? @template.template_data[:tags] : @item.tags.collect{|tag| tag.name}.join(',')%>
<%= render :partial => "/helpdesk/tickets/remote_tags" , :locals => {:values => values }%>

<%= ci_fields(ticket_form)%>
<input type="hidden" id="companyurl" value="<%= helpdesk_commons_user_companies_path %>" />
