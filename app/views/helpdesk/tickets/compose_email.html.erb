<% content_for :sidebar do -%>&nbsp;<%- end %>
<div class="compose-new-email">
  <%= form_for @item, :html => {:multipart => true, :id => "ComposeTicket", :ignore => "", :rel => "validate" } do |f| %>
     <%= render :partial => "helpdesk/tickets/ticket_widget/new_email_title" %>
        <div class="muted">
              <%= t("ticket.compose.compose_email_info") %>
              <a href="https://support.freshdesk.com/support/solutions/articles/211974" target="_blank"><%= t("ticket.compose.learn_more") %></a>
       </div>
  <div class="address-details">
    <div class="requester-email details-widget light-border">
    <label class="inline-label" for="cc-email-address"><%= t('ticket.compose.from') %> </label>
      <%= select_tag "helpdesk_ticket[email_config_id]", options_for_compose,  {:class => "required from_address_wrapper", :data => {:placeholder => t("ticket.compose.compose_choose_email")}}%>
    <div>
    </div>
    </div>
    <div class="to-address details-widget">
      <label class="inline-label" for="cc-email-address"><%= t('ticket.compose.to') %></label>
      <%= render(:partial => "/shared/autocomplete_email", :formats => [:html],  :locals => {:placeholder => "Type a contact", :object_name => :helpdesk_ticket, :url => requesters_search_autocomplete_index_path }) %>
      <span class="show-cc" data-action="show-cc"><%= t('helpdesk.shared.cc_label') %></span>
    </div>

      <div class="cc-address hide details-widget">
      <label class="inline-label" for="cc-email-address"><%= t('helpdesk.cc') %>: </label>
          <%= render :partial => "helpdesk/tickets/ticket_widget/new_email_cc" %>
          <span class="hide-cc" data-action="hide-cc"><%= t('helpdesk.shared.hide_cc') %></span>
    </div>

  </div>
  <div class="ticket-details">
        <%= ticket_body_form f %>
    </div>
        <div class="compose-new-ticket">
        <h3 class="lead"><%= t('ticket.compose.properties') %></h3>
        <%= render :partial => '/helpdesk/tickets/show/ticket_field_elements',  :locals => {:form_builder => f, :ticket =>  @item} %>
        </div>

  <% end %>
  </div>

<% content_for :onload_script do -%> 
   
     jQuery(".from_address_wrapper").select2({minimumResultsForSearch: 10});

      jQuery(".from_address_wrapper").on("select2-open", function() { 
           jQuery('body').addClass('compose-from-select2');
      });
      jQuery(".from_address_wrapper").on("select2-close", function() { 
           jQuery('body').removeClass('compose-from-select2');
      });




   jQuery("#helpdesk_tags").select2({  
    tags: "<%= escape_javascript(current_account.tags.most_used(25).collect{|tag| tag.name}.join(',').html_safe) %>".split(","),
    tokenSeparators: [',']
  });

 jQuery('body').on('assetLoaded.fjax', function(){
  window.App.Tickets.Compose.original_requester_error_message = jQuery.validator.messages.requester;
 })
      jQuery("[data-action='show-cc']").on('click', function(){
          jQuery('.show-cc').addClass('muted');
          jQuery('.cc-address ').removeClass('hide');
           jQuery('.to-address').addClass('light-border');
      });

      jQuery("[data-action='hide-cc']").on('click', function(){
           jQuery('.show-cc').removeClass('muted');
          jQuery('.cc-address ').addClass('hide');
           jQuery('.to-address').removeClass('light-border');
      });
      var close_flash = jQuery("#compose-notice")
      closeableFlash(close_flash);
    //TODO - Change to a generic truncate function.
  jQuery('.invalid_attachment a').livequery(function(ev){
      jQuery(this).text(jQuery(this).text().substring(0,19)+"...");
    });
<% end %>
