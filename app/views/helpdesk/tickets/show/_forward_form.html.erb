<% hide_class = conv_id.nil? ? "hide" : ""
  note_details_id = conv_id.nil? ? "" : "note_details_#{@note.id}"  
%>
<script type="text/javascript">
  function lookup(searchString, callback) { 
    new Ajax.Request('<%=requesters_search_autocomplete_index_path%>?q='+encodeURIComponent(searchString), 
                                              { 
                                              method : "GET",
                                              onSuccess: function(response) {
                                                var choices = $A();
                                                response.responseJSON.results.each(function(item){
                                                  choices.push([item.details, item.details]);
                                                });                                                
                                                callback(choices);
                                              } });
                                            }
  var cachedBackend = new Autocompleter.Cache(lookup, {searchKey: 0, choices: 10});
  var cachedLookup = cachedBackend.lookup.bind(cachedBackend);

</script>
<%= form_for note,
            :url => forward_helpdesk_ticket_conversations_path(@ticket),
            :html => {
              :multipart => true, 
              :id => "HelpdeskFwd_#{cntid}", 
              :rel => 'forward_form', 
              :class => "form-unsaved-changes-trigger",
              "data-panel" => conv_id.nil? ? "cnt-fwd" : "cnt-fwd-#{@note.id}",
              "data-form" => conv_id.nil? ? "" : "inline_form",
              "data-show-pseudo-reply" => conv_id.nil?.to_s,
              "data-fetch-latest" => 'true',
              "data-destroy-editor" => true,
              "data-cnt-id" => cntid,
              "data-domhelper-name" => "cnt-fwd",
              "data-fulltext" => true,
              "data-submitting" => 'false'
            } do |f| %>
 <div class="form_title custom-selectdrop" id="fwd_title" >
 <b><%= t('.title').html_safe %></b>

<select id="reply_email_id" name="reply_email[id]" class="select2  responder_field " data-container-css-class="ticketSelect2Container" data-dropdown-css-class="ticketSelect2">
        <% @reply_emails.each do |re| %>
          <% if re[1].downcase == @selected_reply_email.downcase %>
            <% @selected_email_config_id = re[0]%>
            <option value="<%=re[1]%>" data-email-config-id="<%=re[0]%>" selected="selected"><%= h re[1].gsub(/"/,'') { |match|  }%></option>
          <% else %>
            <option value="<%=re[1]%>" data-email-config-id="<%=re[0]%>"><%= h re[1].gsub(/"/,'') { |match|  }%></option>
          <% end %>  
        <%end%>
      </select>
 </div>

<% if conv_id.nil? %>
<div class="list_agents_replying" class="hide"></div>
<% end %>
<%= f.error_messages %>       
<ul class="ui-form dont-validate botm-space">
<!-- <li class="inline-field field" >
      # <%= f.label(:reply_email, t('ticket.from'), :class => "mailaddr-label from" ) %>
      <%#= select :reply_email, :id, options_for_select(@reply_emails, @selected_reply_email), {}, {:class => 'select2 responder_field'} %>
  </li> -->
  <li class="inline-field field cc_fields forward">
     <%= f.label(:forward_email, t('helpdesk.tickets.to'), :class => "caption mailaddr-label" ) %>
      
      <div class="request_form_options">
        <a  href="#" rel="toggle_email_container" id="fwd_add_cc_btn_<%=cntid%>"
            data-container="fwd_cc-form-container-<%=cntid%>" 
            data-toggle-button="fwd_add_cc_btn_<%=cntid%>"
            data-toggle-checkbox="fwd_include_cc_<%=cntid%>">
          <%= t(".cc") %>
        </a>
        <a  href="#" rel="toggle_email_container" id="fwd_add_bcc_btn-<%=cntid%>" 
            class="<%=bcc_drop_box_email.blank? ? '' : 'hide' %> "
            data-container="fwd_bcc-form-container-<%=cntid%>"
            data-toggle-button="fwd_add_bcc_btn-<%=cntid%>" 
            data-toggle-checkbox="fwd_include_bcc_<%=cntid%>" >
          <%= t(".bcc") %>
        </a>
      </div>

      <div class="email_container forward_email">
        <input type="text" id="to_emails_<%=cntid%>" name="helpdesk_note[to_emails]" />
        <script type="text/javascript">
          new Autocompleter.MultiValue("to_emails_<%=cntid%>", cachedLookup, $A(), {frequency: 0.1, acceptNewValues: true,allowSpaces: true, separatorRegEx:/;|,/});
        </script>
      </div>

      <input type="checkbox" class="hide" id="fwd_include_cc_<%=cntid%>" name="include_cc" />              
      <input type="checkbox" class="hide" id="fwd_include_bcc_<%=cntid%>" name="include_bcc" <%=bcc_drop_box_email.blank? ? "" : "checked" %> />

  </li>
  <li class="inline-field field hide cc_fields" id="fwd_cc-form-container-<%=cntid%>">
    <label class = "mailaddr-label" for="cc_emails_<%=cntid%>"><%= t(".cc") %>:</label>
    <a href="#" class="clear_emails" rel='toggle_email_container' 
        data-container="fwd_cc-form-container-<%=cntid%>" 
        data-toggle-button="fwd_add_cc_btn_<%=cntid%>" 
        data-clear="true"><%= t('clear') %></a>
        <div class="email_container">
          <input type="text" id="fwd_cc_emails_<%=cntid%>" name="helpdesk_note[cc_emails]" />
          <script type="text/javascript">
             new Autocompleter.MultiValue("fwd_cc_emails_<%=cntid%>", cachedLookup, $A(), {frequency: 0.1, allowSpaces: true, acceptNewValues: true,separatorRegEx:/;|,/});
          </script>
        </div>
  </li>
  <li class="inline-field field <%=bcc_drop_box_email.blank? ? "hide" : '' %>  cc_fields" id="fwd_bcc-form-container-<%=cntid%>">
    <label class = "mailaddr-label" for="cc_emails_<%=cntid%>"><%= t(".bcc") %>:</label>
    <a href="#" class="clear_emails" rel='toggle_email_container' 
        data-container="fwd_bcc-form-container-<%=cntid%>" 
        data-toggle-button="fwd_add_bcc_btn-<%=cntid%>" 
        data-clear="true"><%= t('clear') %></a>
        <div class="email_container">
          <input type="text" id="fwd_bcc_emails_<%=cntid%>" name="helpdesk_note[bcc_emails]" />
          <script type="text/javascript">
            new Autocompleter.MultiValue("fwd_bcc_emails_<%=cntid%>", cachedLookup, $A(<%= bcc_drop_box_email.map{|item|[item, item]}.to_json.html_safe unless bcc_drop_box_email.blank? %>), {frequency: 0.1, acceptNewValues: true, allowSpaces: true,  separatorRegEx:/;|,/});
          </script>
        </div>
  </li>
  <li class="inline-field field clearField message">
    <%= render :partial => 'helpdesk/tickets/show/editor_insert_buttons', :locals => { :cntid => cntid } %>
    <% conv_item = conv_id.nil? ? @ticket : @note %>
    <% fwd_draft = forward_template_draft(conv_item, @signature) %>
    <%= f.fields_for(:note_body, Helpdesk::NoteBody.new) do |ff| %>
            <%= ff.text_area :body_html, :class => "body_html", :id => "#{cntid}-body",  :"data-wrap-font-family" => true, :"data-quoted-textarea" => "##{cntid}-quoted", :value => fwd_draft["draft_text"]%>
            <%= ff.text_area :full_text_html, :id => "#{cntid}-body-fulltext", :value => "", 
                                  :style => "display:none;"%>
            <%if  current_browser == "Internet Explorer" %>
                <%= text_area_tag "quoted_text_html", h(quoted_text(conv_item, true)), { :id => "#{cntid}-quoted", :class => "hide" } %>
            <% else %>
              <template name = "quoted_text_html" id = "<%= cntid %>-quoted" class="hide">
                <%= h(quoted_text(conv_item, true)) %>
              </template>
            <% end %>
    <% end %>
  </li>
  <li class="inline-field field continous file_size_alert hide" id="file_size_alert_<%= cntid %>">
    <span class="alert-text"><%= t('helpdesk.tickets.show.forward_form.not_sent') %></span>
    <%= t('helpdesk.tickets.note.attachment_size.exceeded', :attachment_limit => current_account.attachment_limit) %>
  </li>
  <li class="attachment-options-reply" id="attachment-options-reply">
      <% unless local_assigns[:no_attachments] %>
      <% attachments = {:regular => conv_item.all_attachments, :cloud_files => conv_item.cloud_files } %>
        <%= render :partial => "/helpdesk/tickets/show/multi_attachment_form", :locals => { :attach_id => id , :nsc_param => "helpdesk_note", :forward=>true,:original_attachments => attachments} %>
      <% end %>    
  </li>


    <!-- forward will be always private -->
    <%= f.hidden_field :private , :value => true %>
    <%= f.hidden_field :source , :value => current_account.helpdesk_sources.note_source_keys_by_token["forward_email"] %>
    <%= f.hidden_field :from_email , :id => "fwd_from_email_#{cntid}", :value => @selected_reply_email %>
    <%= f.hidden_field :email_config_id, :value => @selected_email_config_id %>
    <%= hidden_field_tag(:page , params[:page], :id=>:page  ) unless params[:page].nil? %>


</ul>

<div class="btn-toolbar no-width">

  <span>
    <a class="btn cancel_btn" data-show-pseudo-reply="<%=conv_id.nil?.to_s %>" data-cnt-id="<%=cntid%>">
      <%= t('cancel') %>
    </a>
  </span>

  <span class="btn-group">
    <button class="btn btn-primary submit_btn"><%= t('forward') %></button>
  </span>

</div>
<div class="clearfix overflowh"></div>
<% if conv_id.present? %>
<script type="text/javascript">
  invokeRedactor('<%= "#{cntid}-body" %>', 'cnt-fwd');
</script>
<% end %>

<script type="text/javascript">
    
    jQuery(".cancel_btn").click(function() {
      jQuery("#HelpdeskFwd_<%=cntid%>").find('.cc-error-message').remove();
    })

    jQuery('#HelpdeskFwd_<%=cntid%>')      
      .bind("submit", function(ev){
      var tkt_recipient_arr = [];
      if( <%= do_spam_check? && free_admin_email_account? %>) {
        tkt_recipient_arr = <%= unique_ticket_recipients(@ticket).to_json.html_safe %>;
        var limit       = <%= get_trial_account_max_to_cc_threshold %>;
        var msg         = "<%= t(:'flash.general.recipient_limit_exceeded', :limit =>get_trial_account_max_to_cc_threshold ) %>";
        App.Tickets.LimitEmails.titleMsg = "<%= t(:'flash.general.recipient_limit_exceeded', :limit => get_trial_account_max_to_cc_threshold ) %>";
        App.Tickets.LimitEmails.okBtnMsg = "<%= I18n.t('ok') %>";
        if(!App.Tickets.LimitEmails.limitForwardEmails(jQuery('#HelpdeskFwd_<%=cntid%>'), '.cc_fields:visible:last' ,tkt_recipient_arr, limit, msg)) {
          return false;
        }
      }

      jQuery("#HelpdeskFwd_<%=cntid%>").find('.cc-error-message').remove();

      })
      .validate();

      jQuery('html, body').animate({
        scrollTop: jQuery("#<%= cntid %>").offset().top-110
    }, 100);
</script>


<% end %>




<% content_for :pagefixed do %>
  <script type="text/javascript">
    jQuery('#HelpdeskFwd_<%=cntid%> select#reply_email_id').on('change',function(e){
      try {
        var selectObj = jQuery(e.target),
        form = e.target.form,
        fromEmail = selectObj.val();
        form['helpdesk_note[from_email]'].value = fromEmail;
        email_config_id = jQuery(selectObj).find(":selected").data().emailConfigId;
        form['helpdesk_note[email_config_id]'].value = email_config_id;
      } catch(e) {

      }
  })
  </script>



<% end %>
