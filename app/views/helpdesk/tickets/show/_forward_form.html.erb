<% hide_class = conv_id.nil? ? "hide" : ""
  note_details_id = conv_id.nil? ? "" : "note_details_#{@note.id}"  
%>
<div class="request_panel <%= hide_class %>" id="cnt-fwd">
    <%= content_tag( :h4, t("fwd_to"), :class => "title", :id => "fwd_title" ) %>
    <% form_for note, :html => {:multipart => true, :id => "HelpdeskFwd_#{cntid}" } do |f| %>
    <%= f.error_messages %>       
    <ul class="ui-form dont-validate">
      <li class="inline-field field" >
          <%= f.label(:reply_email, "From:" ) %>
          <%= select :reply_email, :id, options_for_select(@reply_email, @selected_reply_email) %>
      </li>

      <li class="inline-field field cc_fields" id="fwd_to_mail">
          <%= f.label(:forward_email, "To:", :class => "caption" ) %>

          <div class="request_form_options">
            <a  href="#" rel="toggle_email_container" id="fwd_add_cc_btn_<%=cntid%>"
                data-container="fwd_cc-form-container-<%=cntid%>" 
                data-toggle-button="fwd_add_cc_btn_<%=cntid%>"
                data-toggle-checkbox="fwd_include_cc">
              <%= t(".cc") %>
            </a>
            <a  href="#" rel="toggle_email_container" id="fwd_add_bcc_btn-<%=cntid%>" 
                class="<%=bcc_drop_box_email.blank? ? '' : 'hide' %> "
                data-container="fwd_bcc-form-container-<%=cntid%>"
                data-toggle-button="fwd_add_bcc_btn-<%=cntid%>" 
                data-toggle-checkbox="fwd_include_bcc" >
              <%= t(".bcc") %>
            </a>
          </div>
          <div class="email_container">
            <input type="text" id="to_emails_<%=cntid%>" name="helpdesk_note[to_emails]" />
            <% javascript_tag do -%>
              new Autocompleter.MultiValue("to_emails_<%=cntid%>", cachedLookup, $A(), {frequency: 0.1, acceptNewValues: true,separatorRegEx:/;|,/});
            <%- end %>
          </div>
          <input type="checkbox" class="hide" id="fwd_include_cc" name="include_cc" />              
          <input type="checkbox" class="hide" id="fwd_include_bcc" name="include_bcc" <%=bcc_drop_box_email.blank? ? "" : "checked" %> />

      </li>
      <li class="inline-field field hide cc_fields" id="fwd_cc-form-container-<%=cntid%>">
        <label for="cc_emails_<%=cntid%>"><%= t(".cc") %>:</label>
        <a href="#" class="clear_emails" rel='toggle_email_container' 
            data-container="fwd_cc-form-container-<%=cntid%>" 
            data-toggle-button="fwd_add_cc_btn_<%=cntid%>" 
            data-clear="true">Clear</a>
            <div class="email_container">
              <input type="text" id="fwd_cc_emails_<%=cntid%>" name="helpdesk_note[cc_emails]" />
              <% javascript_tag do %>
                new Autocompleter.MultiValue("cc_emails_<%=cntid%>", cachedLookup, $A(), {frequency: 0.1, acceptNewValues: true,separatorRegEx:/;|,/});
              <% end %>
            </div>
      </li>
      <li class="inline-field field <%=bcc_drop_box_email.blank? ? "hide" : '' %>  cc_fields" id="fwd_bcc-form-container-<%=cntid%>">
        <label for="cc_emails_<%=cntid%>"><%= t(".bcc") %>:</label>
        <a href="#" class="clear_emails" rel='toggle_email_container' 
            data-container="bcc-form-container-<%=cntid%>" 
            data-toggle-button="fwd_add_bcc_btn_<%=cntid%>" 
            data-clear="true">Clear</a>
            <div class="email_container">
              <input type="text" id="bcc_emails_<%=cntid%>" name="helpdesk_note[bcc_emails]" />
              <% javascript_tag do %>
                new Autocompleter.MultiValue("bcc_emails_<%=cntid%>", cachedLookup, $A(<%= bcc_drop_box_email.to_json unless bcc_drop_box_email.blank? %>), {frequency: 0.1, acceptNewValues: true,separatorRegEx:/;|,/});
              <% end %>
            </div>
      </li>
      <li class="inline-field field continous clearField">
        <% conv_item = conv_id.nil? ? @ticket : @note %>
        <%= f.text_area :body_html, :class => "required", :id => "#{cntid}-body", :value => bind_last_conv(conv_item, @signature, true) %>
      </li>
      <li class="inline-field field attachment-options continous" id="attachment-options-reply">
          <% unless local_assigns[:no_attachments] %>
          <%= render :partial => "/helpdesk/tickets/show/attachment_form", :locals => { :attach_id => id , :nsc_param => "helpdesk_note" } %>
          <% end %>    
      </li> 
        <!-- forward will be always private -->
        <%= f.hidden_field :private , :value => true %>
        <%= f.hidden_field :source , :value => Helpdesk::Note::SOURCE_KEYS_BY_TOKEN["forward_email"] %>
        <%= f.hidden_field :from_email , :id => "fwd_from_email_#{cntid}", :value => @selected_reply_email %>
        <%= hidden_field_tag(:page , params[:page], :id=>:page  ) unless params[:page].nil? %>
        
    </ul>
    <div class="f-right">
      <span><%= submit_tag(t('cancel'), :class => "uiButton" ) %></span>
      <span><%= submit_tag(t('forward'), :onclick => "jQuery('##{cntid}').hide();jQuery('##{cntid}-body').destroyEditor();", :class => "uiButton special") %></span>
    </div>

    <% end %>
  </div>

<% unless conv_id.nil? %>
  <% javascript_tag do %>
    invokeRedactor('<%= "#{cntid}-body" %>');
  <% end %>
<% end %>

<% javascript_tag do %>
    jQuery("#HelpdeskFwd_<%=cntid%>").bind("submit", function(ev){ 
          if(!jQuery('#fwd_include_cc_<%=cntid%>').is(':checked'))
            jQuery('[name="helpdesk_note[cc_emails][]"]').val('');
          if(!jQuery('#fwd_include_bcc_<%=cntid%>').is(':checked'))
            jQuery('[name="helpdesk_note[bcc_emails][]"]').val('');  
          }).validate()
<% end %>
<% content_for :pagefixed do %>
  <% javascript_tag do %>
    jQuery('#HelpdeskFwd_<%=cntid%> select#reply_email_id').live('change',function(e){
    var selectObj = jQuery(e.target),
        form = e.target.form,
        fromEmail = selectObj.val();
        form['helpdesk_note[from_email]'].value = fromEmail;
  })
  <% end %>
<% end %>
