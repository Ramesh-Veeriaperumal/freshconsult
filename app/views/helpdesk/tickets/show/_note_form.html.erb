<div class="request_panel" id="<%=cntid%>" style="display:none;" rel="emitter" data-node-name="agent_replying">
  <% form_for note, :html => {
                      :multipart => true,  
                      :id => "HelpdeskNotes",
                      :rel => 'note_form', 
                      "data-panel" => cntid,
                      "data-show-pseudo-reply" => 'true',
                      "data-destroy-editor" => 'true',
                      "data-fetch-latest" => 'true',
                      "data-cnt-id" => cntid

                    } do |f| %>

    <div id="toggle-note-visibility">
      <div class="note-visible">
        <i></i><label>Visible to the customer</label>
      </div>
      <div class="note-hidden">
        <i></i><label>Hidden to the customer</label>
      </div>
      <%= f.check_box(:private, :checked => true) %>
    </div>
    <div class="list_agents_replying" class="hide"></div>
    <%= content_tag( :h4, t("ticket.note_form.form_title"), :class => "title" ) %>

    <%= f.error_messages %>
    <ul class="ui-form dont-validate">

      <li class="inline-field field notify_agent">
        <label class="notify" for="helpdesk_note_to_emails">
          <%= t("ticket.note_form.notify_agents") %>:
        </label>
        <div class="email_container">
          <%= select_tag "helpdesk_note[to_emails]", 
                          options_for_select(current_account.agents.map { |agent| "#{agent.user.name} <#{agent.user.email}>" }, 
                              [( @ticket.responder.present? && @ticket.responder.id != current_user.id ? 
                                      "#{@ticket.responder.name} <#{@ticket.responder.email}>" : nil ) ]), 
                          :multiple => true, :class => 'select2', "data-placeholder" => 'Select agents to notify' %>
        </div>
      </li>

      <li class="inline-field field continous">
        <%= f.text_area :body_html, :class => "required", :id => "#{cntid}-body", 
                        :value => "<span id='caret_pos_holder' style='display:none;'>&nbsp;</span>" %>
      </li>

      <li class="inline-field field attachment-options continous" id="attachment-options-note">
          <% unless local_assigns[:no_attachments] %>
          <%= render :partial => "/helpdesk/tickets/show/attachment_form", :locals => { :attach_id => id , :nsc_param => "helpdesk_note" } %>
          <% end %>
      </li>
    </ul> 
    <%= f.hidden_field :source , :value => Helpdesk::Note::SOURCE_KEYS_BY_TOKEN["note"]%>
    <%= hidden_field_tag(:page , params[:page], :id=>:page  ) unless params[:page].nil? %>
    <%= hidden_field_tag(:ticket_status , params[:ticket_status], :id=>:note_ticket_status  )%>
    <div class="f-right">
      <%= submit_tag(t('cancel'), :class => "uiButton cancel_btn", 
                                  "data-show-pseudo-reply" => 'true',
                                  "data-cnt-id" => cntid ) %>   
    	<%= submit_tag(t('ticket.note_form.add_and_resolve'), :onclick => "jQuery('#note_ticket_status').val('resolved');" , :class => "uiButton") %> 
      <%= submit_tag(local_assigns[:submit] || ActiveSupport::Inflector.titleize(id), :class => "uiButton special") %>
    </div>
  <% end %>
</div> 
<% content_for :pagefixed do %>
  <%= javascript_include_tag "helpdesk/page_switcher" %>
  <% javascript_tag do %>
    document.observe("dom:loaded", function(){
      new Helpdesk.PageSwitcher({
        toggleMode: true,
        pages: ['attachment-options-note']
      });
			jQuery("#HelpdeskNotes").validate();	  
			jQuery("#cnt-note-body").val("");
    });
  <% end %>
<% end %>