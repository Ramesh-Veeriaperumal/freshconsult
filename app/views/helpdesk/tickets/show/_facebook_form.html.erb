<div class="request_panel" id="<%=cntid%>" style="display:none;" data-type="textarea" rel="emitter" data-is-facebook-realtime-dm=<%= @ticket.facebook_realtime_message? %> data-node-name="agent_replying">
  <div class="form_title">
     <%= t(".reply_to") %> <span id ="fb_form_title" class = "fb-title"> <%= @ticket.requester.name %> </span>
  </div>
  <div class="list_agents_replying" class="hide"></div>
  <input type="hidden" value="<%= @ticket.requester.twitter_id %>" id="requester_twitter_handle" />
  <%= form_for note, :url => facebook_helpdesk_ticket_conversations_path(@ticket), :html => {
                        :multipart => true,  
                        :id => "HelpdeskFbComment",
                        "data-panel" => cntid,
                        "data-show-pseudo-reply" => 'true',
                        "data-fetch-latest" => 'true',
                        "data-cnt-id" => cntid  } do |f| %>
    <%= f.error_messages %>
    <%= hidden_field_tag(:page , params[:page], :id=>:page  ) unless params[:page].nil? %>
    <%= hidden_field_tag(:ticket_requester_name, @ticket.requester.name, :id => "ticket_requester_name")%>
    <%= hidden_field_tag(:parent_post, "", :id => "parent_post_id")%>
    <%= hidden_field_tag :fb_post, "true", :id => "fb_comment" %>
    <%= f.hidden_field :source , :value => current_account.helpdesk_sources.note_source_keys_by_token["facebook"]%>          
    <%= f.hidden_field :private , :value => "false" %>
    <%= hidden_field_tag :last_note_id,'', :value => @last_note_id, :class => "last_note_id" %>

    <ul class="ui-form dont-validate">
      <li class="inline-field field">
        <%= render(:partial => 'helpdesk/tickets/show/editor_insert_buttons', :locals => { :id => id, :cntid => cntid }) %> 
        <%= f.label(:reply_email, t('.from'), :class => "mailaddr-label from" ) %>
        &nbsp;<%= @ticket.fb_post.facebook_page.page_name if @ticket.fb_post && @ticket.fb_post.facebook_page %>
      </li>       
      <li class="inline-field field clearField continous message">
        <%= f.fields_for :note_body, Helpdesk::NoteBody.new do |ff| %>
        <%= ff.text_area :body, { :class => "required facebook auto-height #{@ticket.facebook_realtime_message? ? 'facebook-realtime' : '' }", :id => "#{id}-#{cntid}-body", :rows => "6", "data-domhelper-name" => "content-body", "data-reply-count" => Facebook::Constants::REALTIME_MESSSAGING_CHARACTER_LIMIT } %>
        <% end %>
      </li>
    </ul>
    <span class="dm-reply-counter" id="SendReplyCounter"></span>
    <div class="btn-toolbar">
      <span>
        <%= link_to(t('cancel'), '#', :id => "facebook-cancel-reply", :class => "btn cancel_btn", "data-show-pseudo-reply" => 'true',"data-cnt-id" => cntid , "data-clear-draft" => 'true', "data-editor-id" => "#{id}-#{cntid}-body") %>
      </span>

      <span class="btn-group  <% if privilege?(:edit_ticket_properties) %>dropup<%end%>">
        <a class="btn btn-primary submit_btn">
          <%= t('ticket.reply_form.send') %>
          <% if privilege?(:edit_ticket_properties) %>
            <a class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="#">
              <span class="caret"></span>
            </a>
          <% end %>
        </a>
        <% if privilege?(:edit_ticket_properties) %>
          <ul class="dropdown-menu custom_statuses pull-right">
            <%
            ticket_statuses = current_account.ticket_status_values.reject{|status| status.status_id == 2 }
            %>
            <% ticket_statuses.each do |status| %>
            <li>
              <a href="#" rel="custom-reply-status" data-status-name='<%= status.name %>' data-cnt-id='<%=cntid%>' data-status-val='<%= status.status_id %>' >
                <%= t('ticket.reply_form.send_and_set_as', {:status => status.name}).html_safe %>
              </a>
            </li>
            <% end %>
          </ul>
        <% end %>
      </span>
    </div>
  <% end %>
</div>  

<% content_for :onload_script do %>
  jQuery("#HelpdeskFbComment").validate();  
<% end %>
