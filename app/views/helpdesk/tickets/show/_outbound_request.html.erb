<% outbound_initiator = @ticket.outbound_initiator %>
<!-- sentiment hard coded as 0 for outbound for time being -->

<% if (Account.current.customer_sentiment_ui_enabled? && current_user.language=="en") %>
  <% survey_association = Account.current.new_survey_enabled? ? "custom_survey_results" : "survey_results" %>
  <% unless @ticket.send(survey_association).nil? || @ticket.send(survey_association).last.nil? %>
    <%= link_to user_avatar(@ticket.requester, :thumb, 'preview_pic circle'), @ticket.requester, :class => 'avatar-wrap' %>
  <% else %>
    <%= link_to senti_user_avatar(@ticket.requester, @ticket.sentiment, :thumb, 'preview_pic circle'), @ticket.requester, :class => 'avatar-wrap' %>
  <% end %>
<% else %>
  <%= link_to user_avatar(@ticket.requester, :thumb, 'preview_pic circle'), @ticket.requester, :class => 'avatar-wrap' %>
<% end %>

<div class="commentbox commentbox-gray">
  <div>
  <h2 class="subject break-word <%= 'show_full' if @ticket.deleted or @ticket.spam %>">
    <% if @ticket.spam %>
      <span class='label spam'>
        <%= link_to("×", unspam_helpdesk_ticket_path(@ticket), :method => :put,
                  :class => "tooltip", "data-placement" => "below", 
                  :title => t('ticket.ham_btn_title')) unless params[:format]=='widget' %>
        <%= t("ticket.spam") %>

      </span>
    <% end %>
    <% if @ticket.deleted %>
      <span class='label deleted'>
        <%= link_to("×", restore_helpdesk_ticket_path(@ticket), :method => :put, 
              :class => "tooltip", "data-placement" => "below", 
              :title => t('ticket.restore_btn_title') ) unless params[:format]=='widget' 
              %>
        <%= t("ticket.deleted") %>
      </span>
      
    <% end %>

    <%
      customer_opinion = "" 
      survey_association = Account.current.new_survey_enabled? ? "custom_survey_results" : "survey_results"
      unless @ticket.send(survey_association).nil? || @ticket.send(survey_association).last.nil?
        if Account.current.new_survey_enabled? 
          rating_class_value = " color-" + CustomSurvey::Survey::CUSTOMER_RATINGS_STYLE[@ticket.send(survey_association).last.ticket_info[:value]] + "' title='" + @ticket.send(survey_association).last.ticket_info[:text]
          tooltip_class = "tooltip "
        else
          rating_class_value = ""
          tooltip_class = ""
        end 
        customer_opinion = ["<div class='customer-opinion ",tooltip_class, @ticket.send(survey_association).last.get_small_img_class, rating_class_value, "'></div>"].join.html_safe
      end     
    %>        
    <%=customer_opinion%>                 

    <%= h(@ticket.subject) %>
  </h2>
  <div class="author-mail-detail">
    <div>
      <%= link_to_user(outbound_initiator).html_safe %> <%= t('ticket.outbound') %> 
      <abbr data-livestamp="<%= @ticket.created_at.to_i %>"></abbr> 
      (<%= formated_date(@ticket.created_at) %>)
      <%= t('ticket.via')%>
      <%= @ticket.source_name %>

      <%= metainfo(@ticket) unless @ticket.mobihelp? %>
    </div>
    
    <div class="info"> 
      <span><%= multiple_emails_container(@to_emails, "From: ") unless @ticket.cc_email_hash.blank? or @to_emails.blank?%></span>
      <span>,<%= multiple_emails_container([@ticket.from_email], "To: ")%></span>

      <%= content_tag :div, multiple_emails_container(@ticket.cc_email_hash[:cc_emails], "Cc: ") unless @ticket.cc_email_hash.blank? %>
        </div> 
  </div>
  <div rel="image-enlarge" id="ticket_original_request" class="request_mail">
      <%= @ticket.description_html.html_safe %>
  </div>

  <div id="ticket_attachments_container_<%= @ticket.id%>">
  <% unless @ticket.all_attachments.empty? and @ticket.cloud_files.empty? %>
    <span class="seperator"></span>
    <div class="attachments-wrap clearfix">
      <h5 id="ticket_attachments_title_<%= @ticket.id %>"><strong><%= pluralize(@ticket.all_attachments.size + @ticket.cloud_files.size, t('attachment'), t('attachments'))%></strong></h5>
      <ul class="attachment_list">
          <% @ticket.all_attachments.each do |attached| %> 
            <%= attachment_list(attached, privilege?(:edit_ticket_properties), "ticket",@ticket.id) %>
          <% end %>

          <% @ticket.cloud_files.each do |cloud_file| %> 
            <%= attachment_list(cloud_file, privilege?(:edit_ticket_properties), "cloud_file", nil) %>
          <% end %>
      </ul>
    </div>
  <% end %>
  </div>
</div>
</div>