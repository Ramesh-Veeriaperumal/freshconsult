<% javascript_tag do %> 
	changeAggentList = function(group_id)
	{
		jQuery('#assigned_to')
			.addClass('loading-right')
			.children("select")
			.replaceWith("...");
		
		jQuery.ajax({type: 'POST',
					 url: '/helpdesk/tickets/get_agents/'+group_id,
					 contentType: 'application/text',
					 success: function(data){
								jQuery('#assigned_to')
									.html(data)
									.hide()
									.removeClass('loading-right')
									.show("highlight", {}, 500);
							  }
					});
	}
	
	function dueDateSelected(date){
		new Date(date);
	}
	
<% end %>

<div class="widget" id='TicketProperties'>
	<h3 class="title"><%=t('ticket.properties')%></h3>	
	<% form_for @ticket, :html => { :id => 'custom_ticket_form', :class => 'ui-form'} do |f| %>
	   <ul class="cnt">
		   <!--form values starts here-->
		   <% current_portal.ticket_fields.each do |field| %>
		     <% if field.visible_in_view_form? %>
		      <% 
		          field_value = (field.is_default_field?) ? @ticket.send(field.field_name) : @ticket.get_ff_value(field.name)
		          dom_type    = (field.field_type == "default_source") ? "dropdown" : field.dom_type

		          if(field.field_type == "nested_field")
		          	field_value = {}
		          	field.nested_levels.each do |ff|
		          		field_value[(ff[:level] == 2) ? :subcategory_val : :item_val] = @ticket.get_ff_value(ff[:name])
		          	end
		          	field_value.merge!({:category_val => @ticket.get_ff_value(field.name)})
		          end
		      %>
         	  <%= construct_ticket_element :helpdesk_ticket, field, field.label, dom_type, field.required, field_value %>
         <% end %>
       <% end %>
       <% javascript_tag do %>  
         jQuery('#helpdesk_ticket_group_id')
           .bind("change", function(e){
             jQuery('#helpdesk_ticket_responder_id')
                     .html("<option value=''>...</option>");
             jQuery.ajax({
               type:        'POST',
               url: 		     '/helpdesk/tickets/get_agents/'+this.value,
               contentType: 'application/text',
               success:     function(data){
                               jQuery('#helpdesk_ticket_responder_id')
                                 .html(data);
                            }
             });
           });
         <% if @ticket.ticket_status.deleted? %>
         	jQuery("#helpdesk_ticket_status")
         		.append('<option disabled="disabled" value = "<%= @ticket.status %>"> <%= @ticket.status_name %> </option>')
         		.val("<%=@ticket.status%>")
         <% end %>
       <% end %>
			<!--form values ends here-->
			<!-- Custom fields ends here-->
			<li class="button-container">
				<%= f.submit t('update'), :class => "uiButton grey small" %>
			</li>		
	   </ul>
	<% end %> 
</div> 

<% content_for :dialogs do -%>
	<%= render :partial => "helpdesk/tickets/components/due_date", :locals => { :ticket => @ticket }  %>
<%- end %>