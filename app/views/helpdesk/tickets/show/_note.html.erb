<% 
note_view_id = dom_id(note)
notedetails  = "note_details_#{note.id.to_s()}"
forward_note_id = "cnt-fwd-#{note.id.to_s()}" 
edit_id = "edit-#{note.id.to_s()}"
notable_object = @ticket || @parent
minimizable ||= false

%>

<div id="<%= note_view_id %>" 
			data-timestamp="<%= note.created_at.to_i%>" 
			class="conversation <%= 'minimized minimizable' if minimizable %> <%= 'source_email' if note.email? %>">
	<% if note.user %>
	<div class="avatar-wrap" name="note<%= note.id %>" id="note<%= note.id %>"><%= user_avatar(note.user) %></div>
	<% end %>
	<div class="commentbox 
					<%= (note.user.blank? or note.user.agent?) ? 'commentbox-gray' : 'commentbox-requester' %> 
					<%= 'private-note' if note.private_note? || is_twitter_dm?(note) || is_facebook_message?(note) %>">
		<% if note.private_note? %>
			<%= content_tag(:span, "", :class => "comment-lock") %>
		<% elsif is_twitter_dm?(note) %>
			<%= content_tag(:span, "", :class => "ficon-twitter-lock fsize-21 muted") %>
		<% elsif is_facebook_message?(note) %>
			<%= content_tag(:span, "", :class => "ficon-facebook-lock fsize-21 muted") %>
		<% end %>
		
		
		<% if note.fb_post and note.fb_post.post_type_present? %>
			<% if note.fb_post.comment? %>
	      <span class="tooltip" data-original-title="Comment"> 
	      	<%= content_tag(:span, "", :class => "ficon-chat-bubble fsize-21")%> 
	      </span>
	    <% elsif note.fb_post.reply_to_comment? %>
	      <span class="tooltip" data-original-title="Reply to comment"> 
	      	<%= content_tag(:span, "", :class => "ficon-reply fsize-21")%>
	      </span>
	    <% end %>
      <% clazz = "fb-reply"%> 
    <% else %>
    	<% clazz = "helpdesk_note"%> 
    <% end %>
		
		<div class="<%= clazz %>">
			<% if note.deleted? %>
			<div class="tag">
				<%= t("helpdesk.tickets.note.deleted_note").html_safe %>
			</div>
			<% else %>
			<div class="actions">
				<% if privilege?(:edit_conversation) %>
					<%= link_to_remote(t('delete'), :url => helpdesk_ticket_helpdesk_note_path(notable_object, note), 
								:method => :delete, :confirm => t("helpdesk.tickets.note.delete_note"), 
								:html => {:class => "red_links conv-action-icon conv-actions-delete tooltip", :title => t('delete')}) if note.user && note.user.agent?    %>   
        <% end %>
        <% if privilege?(:merge_or_split_ticket) %>
					<%= link_to(t('ticket.split_ticket'), 
								{ :action => :split_the_ticket, :controller => 'helpdesk/tickets', :id => notable_object.display_id, :note_id => note.id }, 
								:method => :post, :confirm => t("helpdesk.tickets.note.split_ticket_confirm"),
								:class => "tooltip conv-action-icon conv-actions-split tooltip",
								:title => t("helpdesk.tickets.note.split_this_as_new_ticket")) if note.can_split? %> 
        <% end %>
        <% if privilege?(:reply_ticket) and note.fb_reply_allowed? %>
						 <a href="#" class="conv-action-icon conv-actions-reply tooltip replyToComment" data-original-title="Reply" data-note-id = "<%= note.id %>"><span class="ficon-reply"></span>
           </a>
        <% end %>  
        <% if privilege?(:forward_ticket) %>
					<%= link_to_function(t("fwd_to"), 
								"jQuery('##{forward_note_id}').show().trigger('afterShow'); invokeRedactor('#{forward_note_id}-body') " ,
								:class => "conv-action-icon conv-actions-forward tooltip", :title => t('fwd_to')) unless note.private %>
        <% end %>
        <% if privilege?(:edit_note, note) %>
					<%= link_to_function(t("edit"), 
								"jQuery('##{notedetails}').addClass('hide'); jQuery('##{edit_id}').show().trigger('afterShow')",
								:class => "conv-action-icon conv-actions-edit tooltip", :title => t('edit')) if(note.note? && note.user && note.user.agent?) %>
        <% end %>
		    </div>
		    <% end %>
			<div class="author-mail-detail cc_bcc_info">
				<% kind = note.survey_remark.nil? ? note.kind : 'survey' %>
				<%= t("helpdesk.tickets.note.created_on_live.#{kind}", 
						:user_name => link_to_user(note.user), 
						:note_date => formated_date(note.created_at), 
						:timestamp => note.created_at.to_i 
					).html_safe %>
			</div>
			<%  if privilege?(:manage_tickets)
				conv_info = conversation_info(note) %>
				<div class="author-mail-detail">
				<%= content_tag :span, truncate(conv_info, :length => 100).html_safe, 
						:rel => "hover-popover",
						"data-placement" => "below",
						"data-content" => conversation_popover_details(note) %>
				</div>
			<% end %>


			<%= content_tag :div, "", :id => "#{edit_id}", :class => "request_panel email-edit-form hide", :rel => "remote", 
									"data-remote-url" => edit_helpdesk_ticket_helpdesk_note_path(notable_object, note) %>
		    <%= content_tag :div, "", :id => forward_note_id, :class => "request_panel note-forward-form hide", :rel => "remote", 
							"data-remote-url" => forward_conv_helpdesk_ticket_path({ 
														:id => notable_object.display_id, 
														:note_id => note.id }) %>
			<div class="details" id='<%= notedetails %>' data-note-id="<%= note.id %>">
				<%= content_tag(:div, "", :class => "#{note.survey_remark.survey_result.get_small_img_class} smiley") unless note.survey_remark.nil? || note.survey_remark.survey_result.nil? %>
				<div class="request_mail <%= 'survey-note' unless note.survey_remark.nil? %>">
					<%= "<div class='survey-text'>#{note.survey_remark.survey_result.text}</div>".html_safe unless note.survey_remark.nil? || note.survey_remark.survey_result.nil? %>			
					<%= note.body_html.html_safe %>
				</div>
			</div>
			<%= freshfone_audio_dom(note) %>
			<div id="note_attachments_container_<%= note.id%>">
				<% unless note.all_attachments.empty? and note.cloud_files.empty? %>				
						<%= render :partial => "/helpdesk/tickets/show/note_attachments", :locals => { :note => note }%>
				<% end %>
			</div>
		</div>
	</div>

    
	<script type="text/javascript">
		if (typeof(TICKET_DETAILS_DATA['last_note_id']) == 'undefined' ||	TICKET_DETAILS_DATA['last_note_id']  == null || TICKET_DETAILS_DATA['last_note_id'] < <%= note.id %>)
			TICKET_DETAILS_DATA['last_note_id'] = <%= note.id %>;
		if (typeof(TICKET_DETAILS_DATA['first_note_id']) == 'undefined' || TICKET_DETAILS_DATA['first_note_id']  == null || TICKET_DETAILS_DATA['first_note_id'] > <%= note.id %>)
			TICKET_DETAILS_DATA['first_note_id'] = <%= note.id %>;
		
		
	  jQuery(".replyToComment").live('click', function(event){
	    jQuery("#TicketPseudoReply [data-note-type='reply']").click();
	    note_id = jQuery(this).data('noteId')
	    jQuery("#parent_post_id").val(note_id);
	  });
	  
	  
	</script>
	
</div>
