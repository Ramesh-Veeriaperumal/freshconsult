<%
note = activity[:is_note] ? @prefetched_notes[activity[:stack].first.note_id] : nil
%>
<% if note.present? %>
	<%= render :partial => '/helpdesk/tickets/show/note', :object => note, :locals => { :minimizable => true} %>
<% else %>
<div class="conversation activity <%= 'hide' if activity[:important][:type] == 'new_ticket' || activity[:important][:type] == 'new_outbound' %>" data-timestamp="<%= activity[:time].to_i%>"> 
	<% if activity[:user] %>
	<div class="avatar-wrap">
		<%= user_avatar(activity[:user], :thumb, 'preview_pic circle') %>
	</div>
	<% end %>
	<div class="commentbox <%= (activity[:user].blank? or note.notable.agent_performed?(activity[:user])) ? 'commentbox-gray' : 'commentbox-requester' %>">
		<div class="tag">
			<%= t('activities.tag.' + activity[:important][:type], :value => activity[:important][:value] ).html_safe %>
		</div>
		<div class="author-mail-detail">

			<%= t("ticket.activity_timestamp", :user_name => link_to_user(activity[:user], :class => "user_name" ),:timestamp => activity[:time].to_i, :note_date => formated_date(activity[:time]) ).html_safe %>
			
		</div>
		<div class="details">
			<% 	stack = activity[:stack].map{ |act| 
												Liquid::Template.parse(
														t(act.short_descr.chomp('.short') + '.without_user')
														).render(eval_activity_data(act.activity_data).merge(
															'user_path' => link_to(act[:user] ,act[:user]),
															'notable_path' => link_to(h(@item), @item) )
														).html_safe 
											}
			%>
			<%=  stack.size > 1 ? (t('activities.action_verb').capitalize + ' ' + stack.map{|act| act.gsub(t('activities.action_verb'), '')}.to_sentence).html_safe : stack.first %>
		</div>
	</div>
</div>
<% end %>

<script type="text/javascript">
	if (typeof(TICKET_DETAILS_DATA['last_activity']) == 'undefined' || TICKET_DETAILS_DATA['last_activity'] == null || TICKET_DETAILS_DATA['last_activity'] < <%= activity[:stack].first.id %>)
		TICKET_DETAILS_DATA['last_activity'] = <%= activity[:stack].last.id %>;
	if (typeof(TICKET_DETAILS_DATA['first_activity']) == 'undefined' || TICKET_DETAILS_DATA['first_activity'] == null || TICKET_DETAILS_DATA['first_activity'] > <%= activity[:stack].last.id %>)
		TICKET_DETAILS_DATA['first_activity'] = <%= activity[:stack].first.id %>;
	<%= "TICKET_DETAILS_DATA['loaded_activities'] += #{activity[:stack].size}; ".html_safe %>
</script>