<% javascript_tag do %> 
	changeAggentList = function(group_id)
	{
		jQuery('#assigned_to')
			.addClass('loading-right')
			.children("select")
			.replaceWith("...");
		
		jQuery.ajax({type: 'POST',
					 url: '/helpdesk/commons/group_agents/'+group_id,
					 contentType: 'application/text',
					 success: function(data){
								jQuery('#assigned_to')
									.html(data)
									.hide()
									.removeClass('loading-right')
									.show("highlight", {}, 500);
							  }
					});
	}
	
	function dueDateSelected(date){
		new Date(date);
	}
	
<% end %>

<div id="TicketProperties">
	<div class="status_container" id="due-by-time-parent">
	<% unless (@ticket.onhold_and_closed? or @ticket.ticket_status.deleted?)%>
		<h3 class="title"><%= h(@ticket.status_name) %></h3>
		<p>
			<%=t('ticket_due_by_time')%>
			<a id="edit-due-by-time" data-placement="topRight" href="#" data-widget-container="due-date-dialog-container">
				<%= formated_date(ticket.due_by) %>
			</a>
		</p>
	<% else %>
		<% if @ticket.ticket_status.deleted? %>
			<h3 class="title deleted tooltip" data-placement="left" title="<%=t('status_deleted')%>"><%= h(status_changed_time_value_hash(@ticket)[:title]) %></h3>
		<% else %>
			<h3 class="title"><%= h(status_changed_time_value_hash(@ticket)[:title]) %></h3>
		<% end %>
		<p>
			<%= t('since') %>
			<%= formated_date(@ticket.ticket_states.send(status_changed_time_value_hash(@ticket)[:method])) %>
		</p>
	<% end %>
	</div>
	<h3 class="title"><%=t('ticket.properties')%></h3>	
	<% form_for ticket, :html => { :id => 'custom_ticket_form' } do |f| %>
	   <ul class="cnt">
		   <!--form values starts here-->
		   <% current_portal.ticket_fields.each do |field| %>
		     <% if field.visible_in_view_form? %>
		      <% 
		          field_value = (field.is_default_field?) ? ticket.send(field.field_name) : @ticket.get_ff_value(field.name)
		          dom_type    = (field.field_type == "default_source") ? "dropdown" : field.dom_type

		          if(field.field_type == "nested_field")
		          	field_value = {}
		          	field.nested_levels.each do |ff|
		          		field_value[(ff[:level] == 2) ? :subcategory_val : :item_val] = @ticket.get_ff_value(ff[:name])
		          	end
		          	field_value.merge!({:category_val => @ticket.get_ff_value(field.name)})
		          end
		      %>
         	  <%= construct_ticket_element :helpdesk_ticket, field, field.label, dom_type, field.required, field_value %>
         	  <%# render(:partial => "/shared/nested_fields", :locals => { :ticket => @item, :category => field, :category_field_value =>  field_value, :type => "edit"}) if field.field_type == "nested_field"%>
         <% end %>
       <% end %>
       <% javascript_tag do %>  
         jQuery('#helpdesk_ticket_group_id')
           .bind("change", function(e){
             jQuery('#helpdesk_ticket_responder_id')
                     .html("<option value=''>...</option>");
             jQuery.ajax({
               type:        'POST',
               url: 		     '/helpdesk/commons/group_agents/'+this.value,
               contentType: 'application/text',
               success:     function(data){
                               jQuery('#helpdesk_ticket_responder_id')
                                 .html(data);
                            }
             });
           });
          jQuery('#helpdesk_ticket_status')
           .bind("change", function(e){
           		var required_closure_elements = jQuery(".required_closure");
           		if(jQuery('#helpdesk_ticket_status option:selected').val() === "5"){ 
           			jQuery.each(required_closure_elements,function(){ 
           				jQuery(this).addClass('required');
           				jQuery("label[for='"+jQuery(this).attr('id')+"']").append("*");
           			});
           		}
           		else{	
           			jQuery.each(required_closure_elements,function(){
           				if(required_closure_elements.hasClass('required')){
           				 	jQuery(this).removeClass('required');
           					var label = jQuery("label[for='"+jQuery(this).attr('id')+"']").html();
           					label = label.substring(0, label.length - 1);
           					jQuery("label[for='"+jQuery(this).attr('id')+"']").empty();
           					jQuery("label[for='"+jQuery(this).attr('id')+"']").append(label);
           				}
           			});
       			}
       		});
       		
         <% if @ticket.ticket_status.deleted? %>
         	jQuery("#helpdesk_ticket_status")
         		.append('<option disabled="disabled" value = "<%= @ticket.status %>"> <%= @ticket.status_name %> </option>')
         		.val("<%=@ticket.status%>")
         <% end %>
       <% end %>
			<!--form values ends here-->
			<!-- Custom fields ends here-->
			<li class="button-container">
				<%= f.submit t('update'), :class => "uiButton grey small" %>
			</li>		
	   </ul>
	<% end %> 
</div> 

<%= render :partial => "helpdesk/tickets/components/due_date", :locals => { :ticket => ticket }  %>

