<div id="due-date-dialog-container" style="display:none; position:absolute; left:0px; top:0px; width: 100%; height: 100%; ">
	<div class="transparent-overlay" id="due-date-overlay"></div>	
	<div class="due-date-dialog" id="due-date-dialog" style="display:none;"> 
		<span class="right_pointer"></span>
		<% form_for ticket, :url => change_due_by_helpdesk_ticket_path(:id => ticket.display_id), :html => { :id => "DueDateForm", :method => "put" } do |f| %>
			<%= content_tag :label, t(".when_is_it_due"), :class => "title" %>
			<select name="due_date_options" id="due-date-options">
				<option value="today"><%= t(".today") %></option>
				<option value="tomorrow"><%= t(".tomorrow") %></option>		
				<option value="thisweek"><%= t(".this_week") %></option>
				<option value="nextweek"><%= t(".next_week") %></option>			
				<option value="specific"><%= t(".specific_date") %></option>
		  </select> 
		  <span id="due-date-button">
				<%= t("or") %> <a href="javascript:void(0)" id="set-date-time"><%= t(".set_date_time") %></a> 
			</span>
		  <div class="due-date-calender" id="due-date-calender" style="display:none;">
			<div id="due-date-picker"></div>
			<div class="due-date-info">
				<p>
					<%= t(".due") %>
					<span id="due-date-value">
						<%= ticket.due_by.strftime("%a %B %e %Y") %>
					</span>
				</p>
				<p>
					at	
					<%= select_tag "due_by_hour",   options_for_select(%w{ 1 2 3 4 5 6 7 8 9 10 11 12 }, ticket.due_by.strftime("%l").strip) %> :
					<%= select_tag "due_by_minute", options_for_select(%w{ 00 15 30 45 }, ticket.due_by.strftime("%M").strip) %>
					<%= select_tag "due_by_am_pm",  options_for_select(%w{ AM PM }, ticket.due_by.strftime("%p").strip) %>
				</p>
			</div>
		  </div>
		  <%= hidden_field_tag "due_by_date_time" %>
		  <div class="calender-buttons" id="calender-buttons">
			<%= link_to_function( "Cancel", "showHideDialog(false)", :class => "uiButton small" ) %>
			<%= f.submit "Save", :class => "uiButton small" %>
			<span class="loading-item"></span>
		  </div>
		  <div id="calender-info" class="info-highlight" style="display:none;">
				<%= t(".earlier_date_and_time") %>
		  </div>
		<% end %>
   </div>
</div>
<% if privilege?(:due_by_time) %>
  <% javascript_tag do %>	
  	var ticket_created_on = new Date("<%= ticket.created_at.strftime("%B %e, %Y %H:%M") %>");
  	
  	function showHideDialog(showHide){
  		if(showHide){
  			jQuery("#due-date-dialog-container").show();
  			jQuery("#due-date-dialog").fadeIn();
  			jQuery("#edit-due-by-time" ).addClass("highlight-text");					
  		}else{
  			jQuery("#due-date-dialog")
  				.fadeOut(300, function(){
  					jQuery("#due-date-dialog-container").hide();
  				});
  			jQuery( "#edit-due-by-time" ).removeClass("highlight-text");					
  		}
  	}
  	
  	(function($){ 
  		
  		$( "#due-date-picker" )
  			.datepicker({
  				showOtherMonths: true,
  				selectOtherMonths: true,
  				changeMonth: true,
  				changeYear: true,
  				onSelect: function(dateText, inst) {
  					selectedDate = new Date(inst.selectedYear, inst.selectedMonth, inst.selectedDay);
  					$("#due-date-value").html( selectedDate.toDateString() );
  					CalcSelectedDateTime();
  				}
  			});
  			
  		$("#due-date-options")
  			.change(function(){
  				if(this.value == 'specific')
  					toggleDateCalender(true);
  				else
  					toggleDateCalender(false);
  			});
  		
  		$("#due_by_hour, #due_by_minute, #due_by_am_pm")
  			.change(CalcSelectedDateTime);
  			
  		$("#set-date-time")
  			.click(function(){
  				toggleDateCalender(true);
  				$("#due-date-options").val("specific");
  			});
  			
  		function toggleDateCalender(showOrHide){
  			if(showOrHide){
  				$("#due-date-button").hide();
  				$("#due-date-calender").slideDown(300);
  			}	
  			else{
  				$("#due-date-button").show();
  				$("#due-date-calender").slideUp(300);
  			}
  		}
  		
  		/*$("#due-date-dialog")
  			.position({
  				of: $( "#due-by-time-parent" ),
  				my: "right top",
  				at: "left top"
  			});*/
  		
  		$("#edit-due-by-time").click(function(){
  				showHideDialog(true);
  			});
  		
  		$("#due-date-overlay").click(function(){
  				showHideDialog(false);
  			});
  		
  		function CalcSelectedDateTime(){
  			_date_time = $("#due-date-picker").datepicker("getDate"); 
  			am_pm_val = $("#due_by_am_pm").val();
  			hrs_val = parseInt($("#due_by_hour").val())
  			
  			if(hrs_val == 12 && am_pm_val == "AM") hrs_val = 0
  			else if(am_pm_val == "PM" && hrs_val != 12) hrs_val += 12
  			
  			_date_time.setHours( hrs_val );
  			_date_time.setMinutes( $("#due_by_minute").val() );
  			
  			if (ticket_created_on > _date_time){
  				$("#calender-buttons").hide();
  				$("#calender-info").show();
  			}else{
  				$("#calender-buttons").show();
  				$("#calender-info").hide();
  			}				
  			return _date_time;
  		}
  		
  		$("#DueDateForm").submit(function(){  
  			$("#calender-buttons").addClass("saving-items");
  			_date_time = new Date();
  			
  			if($( "#due-date-options" ).val() == "specific"){
  				_date_time = CalcSelectedDateTime();
  			} 
  			 
  			$("#due_by_date_time").val(_date_time);
  								
  			$.post(this.action, $(this).serialize(), 
  						function(data) {
  			     			$("#edit-due-by-time").html(data);
  							showHideDialog(false);
  							$("#calender-buttons").removeClass("saving-items");
  			   			});
  			return false;
  		});

  		
  	})(jQuery);
  <% end %>
<% end %>