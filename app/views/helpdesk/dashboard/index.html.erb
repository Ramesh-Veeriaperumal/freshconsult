<% @page_title = "Dashboard" %>

<% content_for :sidebar do %>
  <div id="reminders" class="reminders sidepanel">    
  	<h3 class="title"><%= t(".todo_title") %></h3>
    <%= render :partial => '/helpdesk/reminders/reminders', 
               :locals  => { :reminders => current_user.reminders, :form_controller => Helpdesk::Reminder.new(), :show_info => true } %> 
  </div>
  
  <% if feature?(:scoreboard) %>
  	<%= content_tag :div, "", :rel => "remote", :class => "side-panel", :id => "mini-leaderboard",
  						 "data-remote-url" => mini_list_helpdesk_leaderboard_path() %>


  	<div id="quests-section-container" rel="remote" class="side-panel" data-remote-url="/helpdesk/quests/active">
  	</div>
  <% end %> 

  <%= render :partial => '/helpdesk/shared/history' %>
<% end %>

<%= render :partial => "summary" %>
<div id="Activity">
	<h3 class="title"><%=t('recent_activity')%></h3>
	<div id="recent_activities_count" class='more-tweets'></div>
	<div id="recent_activities" class='hide'></div>
	<ul id="Pages" class="activityfeed">		
		<% @items.each_with_index do |item, i| %>
			<%= render(:partial => "ticket_note", :object => item) %> 
		<% end %>
	</ul>
</div>
<%= will_paginate @items %>
<% content_for :pagefixed do %> 
  <%= pageless(@items.total_pages, helpdesk_dashboard_path, t("loading.activities"), { :activity_id => @items.first.id}) unless @items.empty?%>
  <%= pageless(@items.total_pages, helpdesk_dashboard_path, t("loading.activities")) if @items.empty? %>
<% end %>
<% content_for :onload_script do %>
	activity_count = 0;
	previous_id = jQuery('#Pages li').first().prop('id');
    if(previous_id == undefined) previous_id = 0;
  jQuery("#Pages div.activity_time").humaneDates(); 
  new PeriodicalExecuter(function(pe) {
    jQuery.get(
      "/helpdesk/dashboard/latest_activities",
      "previous_id="+previous_id,
      function(data) {
          jQuery('#recent_activities').prepend(data);
      		if(jQuery('#recent_activities li.activity').length > 0)
      		{   
      			activity_count = jQuery('#recent_activities li.activity').length;
      			jQuery('#recent_activities_count')
      			  .html(plural(activity_count, "<%= t('recent_activity') %>", "<%= t('recent_activities') %>"));
      			previous_id = jQuery('#recent_activities li.activity').first().attr('id');
			    if(previous_id == undefined) previous_id = 0;
      			jQuery('#recent_activities_count').slideDown();
      		}                                                      
					jQuery("div.activity_time").humaneDates();
    });
  }, 30);
  
	jQuery('#recent_activities_count').click(function() {
		var new_activites = jQuery("<div />").addClass("borderbottom").hide().prepend(jQuery("#recent_activities").html());		
		jQuery('#Pages').prepend(new_activites);
		new_activites.slideDown();
		jQuery("#recent_activities").empty();			
		jQuery(this).hide();	
	});

	/*new PeriodicalExecuter(function(pe) {
		jQuery.get(
		  "/helpdesk/dashboard/latest_summary",
		  function(data) {
		      jQuery('#TicketSummary').replaceWith(data);
		  });
		}, 60);*/
	jQuery('#quests-section-container, #mini-leaderboard').trigger('afterShow');
<%end%>