 <% if @tkt_template.parent_template?
    children_count = @children.count
    sidebar = :sidebar
    partial = "clone_parent_child_status"
  else
    sidebar = :helpcard
    partial = "helpnote_without_tour"
end %>
<% content_for sidebar do %>
  <% if @tkt_template.parent_template? %>
    <%= render :partial => partial, :locals => { :children_count => children_count } %>
  <% else %>
    <%= render :partial => partial %>
  <% end %>
<% end %>
<% if  current_account.launched?(:multifile_attachments)  %>
  <%= render "helpdesk/tickets/ticket_widget/multifile_template_generator" %>
 <% else %>
  <%= render "helpdesk/shared/single_attachment_template" %>
<% end %>
<%= form_for @tkt_template, :url => { :controller => "ticket_templates", :action => "create" }, :html => { :multipart => true, :"data-parent-template" => @tkt_template.parent_template? , :rel => "validate", :class => "template_form #{'clone_parent_form' if @tkt_template.parent_template?}", :id => "ticket_template"}  do |f| %>
	<div class='page-header-sticky' rel='sticky'>
		<div class='sticky-header-wrapper'>
			<h3 class='lead pull-left'>
				<%= t('ticket_templates.title') %>
			</h3>
			<div class="pull-right">
				<%= link_to t('cancel'), helpdesk_ticket_templates_path(), :class => "btn form_btn" %>
				<%= f.submit t('save'), :class => "btn btn-primary form_btn #{'save_template' if @tkt_template.parent_template?}" %>
			</div>
		</div>
	</div>
	<br/>
	<%= render :partial => "form", :locals => { :f => f, :is_edit => true} %>
<% end %>
<div class="modal hide fade" id="toggle-confirm" style="width:600px;margin-left: -300px" aria-hidden="true" role="dialog">
  <div class="modal-header">
    <button class="close" data-dismiss="modal"></button>
    <h3><%= t('ticket_templates.save_and_continue.title') %></h3>
  </div>
  <div class="modal-body">
    <p><%= t('ticket_templates.save_and_continue.info1') %></p>
  </div>
  <div class="modal-footer">
    <%= link_to(t('ticket_templates.save_and_continue.proceed'), '' ,:class => "btn proceed_anyway" )%>
    <%= link_to(t('ticket_templates.save_and_continue.cancel'),'' ,:class => "btn btn-primary take_back" )%>
   </div>
</div>

<!-- Canned response dialog -->
<%= render :partial => "/helpdesk/ticket_templates/canned"  %>
<%
attachment_dom = ""
  if current_account.launched?(:multifile_attachments)
    attachment_dom = ""
  else
    if @all_attachments.present?
      @all_attachments.each do |att|
        if att.attachable_type != "Account"
          attachment_dom << safe_send(:description_attachment, {:filename=>"#{escape_javascript(att.content_file_name)}",:value => "#{att.id}", :name => "template_data[attachments][][resource]"})
        else
          attachment_dom << safe_send(:description_attachment, {:filename=>"#{escape_javascript(att.content_file_name)}", :value => "#{att.id}", :name => "shared_attachments[]"})
        end
      end
    end

    if @cloud_files.present?
      @cloud_files.each do |att|
        attachment_dom << safe_send(:description_attachment, {:filename=>"#{escape_javascript(att.filename)}", :value => "#{att.serialize}", :name => "[cloud_file_attachments][]"})
      end
    end
  end
%>

<% content_for :onload_script do  %>
function unescapeHtml(text) {
    var temp = document.createElement("div");
    temp.innerHTML = text;
    var result = temp.childNodes[0].nodeValue;
    temp.removeChild(temp.firstChild);
    return result;
}
<% if @all_attachments.present? or @cloud_files.present? %>
  <% if !current_account.launched?(:multifile_attachments) %>
    var x = '<%= escape_javascript(attachment_dom) %>';
    jQuery('#ticket-attachments').html(unescapeHtml(x));
    jQuery("#prev-attachments").html("");
  <% end %>
<% end %>

<% end %>

<%= javascript_tag do %>
  var customMessages  = {
    <% if @tkt_template.parent_template? && @children.length>0 %>
      clone_child_ids: ('<%= @children.map(&:id).inspect %>').replace(/[\[\]/\s/']+/g,'').split(','),
      clone_child_max_Count: ('<%= Helpdesk::TicketTemplate::TOTAL_CHILD_TEMPLATES %>'),
      clone_child_title:('<%= t('ticket_templates.child') %>')
    <% end %>
  };
<% end %>
