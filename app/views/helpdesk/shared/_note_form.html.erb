<div class="request_panel" id="<%=cntid%>" style="display:none;" rel="emitter" data-node-name="agent_replying">
  <div class="reply_box">
  <% form_for note, :html => {:multipart => true,  :id => "HelpdeskNotes" } do |f| %>
    <%= f.error_messages %>
    <ul class="ui-form dont-validate">
      <li class="inline-field field">
        <div class="request_form_options">
          <a href="#" id="note_response" class="slim-button"> <%= t('canned_folders.responses') %> &raquo;</a>
        </div>
        <%= content_tag( :h4, t("ticket.note_form.form_title"), :class => "title" ) %>
        <label class="caption"><%= t("message")%>:</label>
        <div class="fields">
          <%= f.text_area :body_html, :class => "required", :id => "#{cntid}-body", :value => "" %>
          <%= f.label(:private, f.check_box(:private, :checked => true) + t("ticket.note_form.private_note"), :class => "checkbox") %>
          <%= f.hidden_field :source , :value => Helpdesk::Note::SOURCE_KEYS_BY_TOKEN["note"]%>
          <%= hidden_field_tag(:page , params[:page], :id=>:page  ) unless params[:page].nil? %>
		      <%= hidden_field_tag(:ticket_status , params[:ticket_status], :id=>:note_ticket_status  )%>
        </div>
        <li class="inline-field field">
        <div class="attachment-options fields" id="attachment-options-note">
          <% unless local_assigns[:no_attachments] %>
            <%= render :partial => "/helpdesk/shared/attachment_form", :locals => { :attach_id => id , :nsc_param => "helpdesk_note" } %>
          <% end %>
        </div>
      </li>
		<li class="inline-field field agents-field" id="notify-email-form-container" style="display:block">
            	 <label class="notify">
               		 <%= t("ticket.note_form.notify_agents") %>:
           		 </label>
            <div class="fields">
                <%= select_tag "helpdesk_note[to_emails]", 
                          options_for_select(current_account.agents.map { |agent| "#{agent.user.name} <#{agent.user.email}>" }), 
                          :multiple => true, :class => 'select2 helpdesk_note_notify_agents', "data-placeholder" => 'Select agents to notify' %>
            </div>
		</li>
	    </li>	
			
    </ul> 
    <div class="button-container">
    	<%= submit_tag(local_assigns[:submit] || ActiveSupport::Inflector.titleize(id), :class => "uiButton special") %>
    	<%= submit_tag(t('ticket.note_form.add_and_resolve'), :onclick => "jQuery('#note_ticket_status').val('4');" , :class => "uiButton") %> 
			<%= button_to_function(t('cancel'), "jQuery('#cnt-note').hide().trigger('visibility');", :class => "uiButton" ) %>   
    </div>
  <% end %>
</div>
</div> 
<% content_for :pagefixed do %>
  <%= javascript_include_tag "helpdesk/page_switcher" %>
  <% javascript_tag do %>
    document.observe("dom:loaded", function(){
      new Helpdesk.PageSwitcher({
        toggleMode: true,
        pages: ['attachment-options-note']
      });
			jQuery("#HelpdeskNotes").validate();	  
			jQuery("#cnt-note-body").val("");
    });
    jQuery("#note_response").click(function(ev){
    ev.preventDefault();
    jQuery("#canned_response_show").attr('data-tiny-mce-id', "#{cntid}-body");
    jQuery("#canned_response_show").trigger('click');
  });
  <% end %>
<% end %>