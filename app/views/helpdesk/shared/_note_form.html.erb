<div class="request_panel" id="<%=cntid%>" style="display:none;">
  <% form_for note, :html => {:multipart => true,  :id => "HelpdeskNotes" } do |f| %>
    <%= f.error_messages %>
    <ul class="ui-form dont-validate">
      <li class="inline-field field">
        <div class="request_form_options">
          <%= link_to_function( t(:'ticket.canned_responses.insert_ca_response') + " &raquo;", "show_canned_response(#{@ticket.id})", :class => "slim-button insert-canned-response") %>
        </div>
        <%= content_tag( :h4, t("ticket.note_form.form_title"), :class => "title" ) %>
        <label class="caption"><%= t("message")%>:</label>
        <div class="fields">
          <%= f.text_area :body_html, :class => "required mceEditor", :id => "#{id}-#{cntid}-body", :value => "<span id='caret_pos_holder' style='display:none;'>&nbsp;</span>" %>
          <%= f.label(:private, t("ticket.note_form.private_note"), :class => "checkbox") %>
          <%= f.hidden_field :source , :value => Helpdesk::Note::SOURCE_KEYS_BY_TOKEN["note"]%>
          <%= hidden_field_tag(:page , params[:page], :id=>:page  ) unless params[:page].nil? %>
		      <%= hidden_field_tag(:ticket_status , params[:ticket_status], :id=>:note_ticket_status  )%>
        </div>
		<li class="inline-field field" id="notify-email-form-container" style="display:block">
			
            <div class="fields">
            	<span class="seperator"></span>
            	 <label>
               		 <%= t("ticket.note_form.notify_agents") %>:
           		 </label>

                <% content_for :onload_script do -%>
				        function agent_lookup(searchString, callback) { 
                    new Ajax.Request('<%= agent_autocomplete_helpdesk_authorizations_path %>?v='+searchString, 
                                                              { parameters: {name: searchString, rand: (new Date()).getTime()},
                                                              onSuccess: function(response) {
                                                                var choices = $A();
                                                                response.responseJSON.results.each(function(item){
                                                                  choices.push([item.value +" <"+item.id+">", item.value +" <"+item.id+">" ]);
                                                                });                                                
                                                                callback(choices);
                                                              } });
                                                            }
                  var agent_cachedBackend = new Autocompleter.Cache(agent_lookup, {choices: 10});
                  var agent_cachedLookup = agent_cachedBackend.lookup.bind(agent_cachedBackend);
				
				          new Autocompleter.MultiValue("notify_emails", agent_cachedLookup, $A(), {frequency: 0.1, acceptNewValues: true});

                <%- end %>
                <input type="text" id="notify_emails" name="notify_emails" />
            </div>
		</li>
	    </li>	
			<li class="inline-field field">
				<div class="attachment-options fields" id="attachment-options-note">
					<% unless local_assigns[:no_attachments] %>
						<%= render :partial => "/helpdesk/shared/attachment_form", :locals => { :attach_id => id , :nsc_param => "helpdesk_note" } %>
			  	<% end %>
				</div>
			</li>
    </ul> 
    <div class="button-container">
    	<%= submit_tag(local_assigns[:submit] || ActiveSupport::Inflector.titleize(id), :class => "uiButton special") %>
    	<%= submit_tag(t('ticket.note_form.add_and_resolve'), :onclick => "jQuery('#note_ticket_status').val('resolved');" , :class => "uiButton") %> 
			<%= button_to_function(t('cancel'), "jQuery('#cnt-note').slideUp()", :class => "uiButton" ) %>   
    </div>
  <% end %>
</div> 
<% content_for :pagefixed do %>
  <%= javascript_include_tag "helpdesk/page_switcher" %>
  <% javascript_tag do %>
    document.observe("dom:loaded", function(){
      new Helpdesk.PageSwitcher({
        toggleMode: true,
        pages: ['attachment-options-note']
      });
			jQuery("#HelpdeskNotes").validate();	  
			jQuery("#add-note-cnt-note-body").val("");
    });
  <% end %>
<% end %>