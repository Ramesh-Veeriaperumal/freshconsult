<%
max_limit ||= 3
container ||= 'customers'
name = container
dom_id ||= container
bulk_action = defined?(bulk_actions) && bulk_actions
if bulk_action
  dom_id = "bulk_customers"
  name = "helpdesk_ticket[company_id]"
end
include_none ||= false
none = I18n.t("filter_options.none")
none_value = -1

hash_val = []

if selected_values
  if include_none and selected_values.include?(none_value)
    selected_values.delete(none_value)
    hash_val << "{id: '-1',
                  value: '#{I18n.t("filter_options.none")}',
                  text: '#{I18n.t("filter_options.none")}'}"
  end

  selected_values.each do |item|
    item_id = (container == "tags" ? item.name : item.id)
    hash_val << "{ id: '#{item_id}',
                   value: '#{escape_javascript(item.name)}',
                   text: '#{escape_javascript(item.name)}'}"
  end
end
%>

<div class = "autocomplete_filter">
  <input type="hidden" id="<%= dom_id %>_filter" name="<%= name %>" />
</div>
<script>
jQuery(document).ready(function() {
  var select2_format = function(result, container, query) {
    return result.value;
  }

  var select2_results = function(result, container, query) {
    var name = result.value, detail,
        display_result = "<b>"+ name + "</b>";
    if(result.info != undefined){
      var split_info = result.info.split(/<|\(/);
      if(split_info[1])
        detail = split_info[1].slice(0,-1);
      else
        detail = result.info
      if(detail.length > 25)
        detail = detail.substring(0,26)+ "...";
      display_result += "<br><span class='select2_list_detail'>" + detail + "</span>";
    }
    return display_result;
  }
  
  jQuery("#<%= dom_id %>_filter").select2({
    placeholder: '<%= t("tickets_filter.#{container}_placeholder") %>',
    minimumInputLength: <%= (container == "tags") ? 1: 2 %>,
    multiple: true,
    allowClear: true,
    maximumSelectionSize: <%= max_limit %>,
    data: [<%=hash_val.join(",").html_safe%>],
    ajax: { 
        url: '<%= url %>',
        dataType: 'json',
        data: function (term) {
            searchText = term;
            toRet = { q: term };
            var company_id = jQuery("#company-list-dropdown .dropdown-toggle").data("company-id") || jQuery("#helpdesk_ticket_company_id").find(":selected").val();
            if(company_id !== undefined)
              toRet = { q: term, customer_id: company_id };
            return toRet;
        },
        results: function (data) {
          var results = [];
          var include_none = <%= include_none %>
          var noneVal = "<%= none %>"
          var cc_company = jQuery("#cc_emails_filter").length,
              container = "<%= container %>",
              id_or_val;

          jQuery.each(data.results, function(i, item){
            if(cc_company){
              id_or_val = item.email
            }else if (container == "tags"){
              id_or_val = item.value
            }else{
              id_or_val = item.id
            }
            results.push({id: id_or_val, value: escapeHtml(item.value), info: item.details});
          });
          if(include_none && noneVal.toLowerCase().indexOf(searchText.toLowerCase()) > -1){
            results.push({id: -1, value: noneVal})
          }
          return { results: results }

        }
    },
    initSelection : function (element, callback) {
      callback( [<%=hash_val.join(",").html_safe%>] );
    },
    specialFormatting: true,
    formatResult: select2_results,
    formatSelection: select2_format,
    formatNoMatches: function () { return I18n.t('validation.select2_no_match', { container : I18n.t('common_js_translations.' + '<%=container%>' + '.singular')}); },
    formatInputTooShort: function (input, min) { 
      return I18n.t('validation.select2_minimum_limit', {char_count : min - input.length}); },
    formatSelectionTooBig: function (limit) { 
      return I18n.t('validation.select2_maximum_limit', {limit: limit, container : I18n.t('common_js_translations.' + '<%=container%>' + '.' + ((limit == 1) ? 'singular' : 'plural'))}); },
  });

  if("<%= bulk_action %>" !== "true") {
    jQuery("#<%= dom_id %>_filter").select2("val",[]);

    jQuery(".ticket_list #<%= dom_id %>_filter").on("change", function(){
      toggle_save_and_refresh();
    });  
    jQuery("#<%= dom_id %>_filter").data('initialValue', [<%=hash_val.join(",").html_safe %>]);
  }

});

</script>
