  <%= will_filter_scripts_tag %>
    <h3 class="title"><%= t("tickets_filter.title") %></h3>
    <form id="FilterOptions" action="#">
      <input type="hidden" name="data_hash" value="" />
      <input type="hidden" name="filter_name" value="<%= @current_view %>" />
      <input type="hidden" name="wf_order" value="<%= current_wf_order %>" />
      <input type="hidden" name="wf_order_type" value="<%= current_wf_order_type %>" />    
  		<input type="hidden" name="page" value="1" />
    </form>
      <% @show_options.each_with_index do |c_hash, i| %> 
        <%
          if ((!c_hash[:field_type].nil?) && (c_hash[:field_type] == "nested_field"))
            container = "nested_field"
          elsif     
            container = (c_hash[:options].size < 5)? "dropdown" : "multi_select" 
          end
        %> 
    	  <% 
        unless c_hash[:options].blank?
          content_tag :div,{ :id          => "div_ff_#{c_hash[:condition]}", 
                                :class       => "ff_item", 
                                :condition   => c_hash[:condition],
                                :operator    => c_hash[:operator],
                                :container   => container } do %>
            <h4 class="title"><%= c_hash[:name] %></h4>
            <%= render :partial => "/helpdesk/tickets/containers/#{container}", :locals => { :options => c_hash[:options], :name => c_hash[:name], :selected_val => @current_options[c_hash[:condition].to_s].to_s.split(","), :field_id => c_hash[:field_id], :nested_fields => c_hash[:nested_fields], :current_options => @current_options, :c_hash => c_hash} %>
          <% end
          end 
        end %>
   

<% javascript_tag do %> 
	var query_hash  = $A();
  
  function getFilterData(){
    query_hash = $A(); 
    jQuery("div.ff_item").map(function () {
      condition = this.getAttribute("condition");
      container = this.getAttribute("container");
      operator  = this.getAttribute("operator");
      _selector = 'input:checkbox:checked'; 
      var value;
          
      if(container == "multi_select") _selector = 'option:selected';
       
      if(container == "nested_field") {         
        value = jQuery(this).children('select').val();
      } else {
        value = jQuery(this).find(_selector).map(function(){ return this.value; }).get();
      }
                        
      if(value && value.length && ((container != "nested_field") || ((container == "nested_field") && (value != -1)))){
        query_hash.push({ 
          condition : this.getAttribute("condition"), 
          operator  : this.getAttribute("operator"),
          value     : value.toString()
        });
      }
    });
		jQuery("#FilterOptions input[name=page]").val(1);
  }

  function refresh_tickets(){
    jQuery("#save_filter").show();
    jQuery("#delete_filter").hide();
    if (!jQuery("#active_filter").hasClass('unsaved')) {
      jQuery("#active_filter").text("<%= t("tickets_filter.unsaved_view") %>").addClass('unsaved').animateHighlight(jQuery('body').css('backgroundColor'));
    }
    jQuery("#leftViewMenu a.active").removeClass('active').children('span').remove();
    jQuery("#FilterOptions input[name=filter_name]").val("");
    jQuery(".view_filters .active").removeClass("active");
    getFilterData();
    jQuery("#FilterOptions input[name=data_hash]").val(query_hash.toJSON()).trigger("change"); 
  }
  
	jQuery(document).ready(function(){
		jQuery("#FilterOptions input[name=data_hash]").val($A(<%= @ticket_filter.query_hash.to_json %>).toJSON());
    jQuery(".filter_item").bind("change", function(){
      refresh_tickets();
    });	 

    if (jQuery("#active_filter").hasClass('unsaved')) {
      jQuery("#save_filter").show();
      jQuery("#delete_filter").hide();
    }
    jQuery(".wf_order_type, .wf_order").live("click", function(ev){
      ev.preventDefault();
      jQuery("#FilterOptions input[name="+this.className+"]").val(this.getAttribute(this.className)).trigger("change");
    });	
		jQuery(".toolbar_pagination a, .toolbar_pagination_full a").live("click", function(ev){
			ev.preventDefault();
			jQuery(document).scrollTop(0);
			jQuery("#FilterOptions input[name=page]").val(getParameterByName("page", this.href)).trigger("change");
		});		
  });
  
  jQuery("#FilterOptions").change(function(){
    jQuery("#ticket-list").html("<div class='loading-box'></div>"); 
     jQuery.ajax({
        url: "/helpdesk/tickets/custom_search",
        type: "POST",
        dataType: "script",
        data: jQuery(this).serializeArray(),
        success: function(msg){ 
          //jQuery("#ticket-list").hide().html(msg).fadeIn(300);
        }
      }); 
  });
<% end %>