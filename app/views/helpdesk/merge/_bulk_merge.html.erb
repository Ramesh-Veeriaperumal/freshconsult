<div id="ticket-merge" class="ticket-merge">
  <div id="merge_info" class="ml10">
    <div class="merge-sub-title" 
      data-default-text="<%= t('ticket.ticket_selected') %>"
      data-pluralized-text="<%= t('ticket.tickets_selected') %>" >
      <%= pluralize(@source_tickets.length, t('ticket.ticket_selected'), t('ticket.tickets_selected')) %>
    </div>
    <div id="merge-warning" class="hide pt10">
      <%= font_icon('unverified', :size => 15) %>
      <%= t('ticket.merge_warning') %>
    </div>
  </div>
  <div id="merge_confirm_info" class="ml10 hide">
  </div><br />
  <div id="mergeboxconfirm"></div>
  <div id="mergebox" class="row-fluid">
    <div id="merge-content" class="span6">
      <div class="content-show merge_entity">
        <% @source_tickets.each do |ticket| %>
          <div class="merge-cont">
            <div class="primary-marker tooltip" title='<%= t(".mark_primary")%>'>
              <span id="marker"></span>
            </div>
              <div id="contact-area">
    		        <span id="resp-icon" title="<%= t('.remove') %>"></span>
    		       		<div id="merge-ticket" class="merge_element" data-id=<%= h(ticket.display_id) %> data-req-id=<%= h(ticket.requester_id) %> data-created=<%= (ticket.created_at.to_i) %>>
                    <%= link_to("##{ticket.display_id} #{ticket.subject}", ticket, :title => h(ticket.subject), 
                    :class =>"item_info", :target=>"_blank", :"data-pjax" => '#body-container' ) %>
    			          <div class="info-data hideForList">
    			          	<span class="merge-ticket-info">
    			          		<%= t("ticket.merge_ticket_list_status_"+ticket.ticket_states.current_state(ticket.outbound_email?), 
              					:username => "<span class='muted requester_name'>#{h(ticket.requester.display_name)}</span>",
                        :time_ago => time_ago_in_words(ticket.ticket_states.send(ticket.ticket_states.current_state(ticket.outbound_email?)))).html_safe %>
          						</span>
    			          </div>
    			        </div>
    			    </div>
    		  </div>
        <% end %>
      </div>
    </div>
    <div class="search-content">
      <%= select_tag "search-type", ("<option value='display_id'>"+t('ticket.id')+"</option>
                                    <option value='subject'>"+t('ticket.subject')+"</option>
          <option selected='selected' value='requester'>"+t('ticket.requester')+"</option>").html_safe %>
      <% search_text = [
        ['display_id', 'select-id', t("ticket.id_placeholder"), 'hide' ],
        ['requester', 'select-requester', t("ticket.requester_placeholder")],
        ['subject', 'select-subject', t("ticket.subject_placeholder"), 'hide']] %>
      <% search_text.map{ |t|  %>
        <div class="searchticket <%= t[0] %> <%= t[3] %>">
          <input type="text" id='<%= t[1] %>'  name='<%= t[1] %>' class="search_merge"  
                                                placeholder='<%=t[2]%>' /><span class="searchicon"></span>
        </div>
      <% } %>
      <div id="display_id_results" class="merge_results hide"></div>
      <div id="requester_results" class="merge_results hide"></div>
      <div id="subject_results" class="merge_results hide"></div>
      <input type="hidden" value='<%= redirect_back %>' id="redirect"/>
    </div>

      <%= form_tag url_for(:controller => "merge_tickets", :action=>"merge"), :id=> "bulk_merge_tickets", 
       :remote => true  do -%>  
      <div class="divide"></div>
      <input type="hidden" name="target[ticket_id]" id="target_ticket" />
        <div class="button-container" id="bulk-merge-button-container">
          <span class="add_recipients">
            <%= check_box_tag 'add_recipients', 1, @source_tickets.length > 1 && @source_tickets.map(&:requester_id).uniq.length == 1 %>
            <span class="m8">
              <%= t('ticket.add_recipients') %>
            </span>
          </span>
          <a class="btn" id="cancel_new_merge"><%= t('cancel') %></a>
          <%= submit_tag t('.continue'),:class => "btn btn-primary",:id => "bulk_merge", :disabled => "disabled", "data-loading-text" => t('please_wait') %>
          <%- end %>
        </div>
      <div id="invaliduser" class="info-highlight" style="display:none;"></div>
  </div>   
</div>
<script type="text/javascript">
  var primary_ticket = App.Tickets.Merge_tickets.findOldestTicket();
  primary_ticket.parent().prepend(primary_ticket);
  primary_ticket.addClass('cont-primary');
  primary_ticket.find('.primary-marker').attr('title','Primary ticket');
  
  App.Tickets.Merge_tickets.enableContinue();
  App.Tickets.Merge_tickets.bindAutocompleter();
  App.Tickets.Merge_tickets.checkRequester();
</script>
