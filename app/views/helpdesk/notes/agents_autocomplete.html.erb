<% if (JSON.parse(get_store_data)["agents_count"] > Agent::AGENTS_THRESHOLD_FOR_AUTOCOMPLETE_ES) %>
  <input type="text" id="selectAgentsOptions" name="helpdesk_note[to_emails]" data-container-css-class="ticketSelect2ContainerNote" data-dropdown-css-class="ticketSelect2", data-placeholder = "<%= t('email_notifications_agent_selection_msg') %>" />
<% else %>
  <%= select_tag "helpdesk_note[to_emails]", options_for_select(current_account.agents.includes(:user).map { |agent| "#{agent.user.name} <#{agent.user.email}>" }, [ load_agent_text(@ticket.responder) ]), :multiple => true, :class => 'select2 add-note-select', "data-placeholder" => t('email_notifications_agent_selection_msg'), "data-container-css-class" => "ticketSelect2ContainerNote", "data-dropdown-css-class" =>"ticketSelect2" %>
<% end %>
<%= javascript_tag do %>


  var agentId = "<%= (@ticket.responder_id && (@ticket.responder_id != current_user.id)) ? @ticket.responder.email : -1 %>";
  var ticketAgent = "<%= load_agent_text(@ticket.responder).to_s.html_safe %>";

  jQuery(document).ready(function () {

      jQuery('#selectAgentsOptions').select2({
        minimumInputLength: 2,
        multiple: true,
        placeholder: "<%= t('email_notifications_agent_selection_msg') %>",
        allowClear: true,
        ajax: {
          url: '/search/autocomplete/agents',
          dataType: 'json',
          delay: 250,
          data: function(term, page) {
            var searchText = term;
            return {
              q: term, // search term
            };
          },
          results: function(data, params) {
           var results = data.results.map(function(item){ 
                           return {
                             id: item.email,
                             text: (item.value + " <" + item.email + ">")
                           };
                        });
            return {
             results : results
            }  
          } 
        },
        cache: true,
        initSelection: function (element,callback){
         if(agentId != "-1"){
         callback({ id: agentId, 
           text: ticketAgent });
         }
        }
     }).select2('val', []);

  } );
<% end %>
