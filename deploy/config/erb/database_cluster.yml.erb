<%
  job_type = nil
  feature_type = nil
  if @is_bg_layer
    job_type = "bg"
  elsif @is_app_layer
    job_type = "app"
  end 
  if @is_migration_layer
    feature_type = "migration"
  elsif @is_fc_layer
    feature_type = "falcon"
  elsif @is_hk_layer
    feature_type = "helpkit"
  end
  db_user_group = !node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym].nil?
%>
<%= node[:opsworks][:environment]%>:
  adapter:  mysql2
  database: <%= node[:ymls][:database][:global][:database] %>
  <% if db_user_group && node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:global][:username] && node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:global][:password] %>
  username: <%= node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:global][:username] %>
  password: <%= node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:global][:password] %>
  <% else %>
  username: <%= node[:ymls][:database][:global][:username] %>
  password: <%= node[:ymls][:database][:global][:password] %>
  <% end %>
  host: <%= node[:ymls][:database][:global][:host] %>
  <% if @is_sidekiq_layer %>
  pool: <%= @pool_size + 1 %>
  <% else %>
  pool: <%= @pool_size %>
  <% end %>
  port: 3306
  encoding: utf8
  reconnect: true
  <% if @is_app_layer %>
  read_timeout: 20
  connect_timeout: 5
  semian:
    enable: true # Top level flag to turn on/off Semian.
    success_threshold: 3 # No of consecutive success after which circuit changes from half_open to closed state.
    error_threshold: 3 # No of consecutive errors after which circuit opens.
    error_timeout: 15 # Time taken to move from open to half_open state.
    bulkhead: false # Should be false always, we are not using this feature.
    dryrun: false # Dryrun is a watcher mode which just logs virtual circuit breaker state transitions and doesn't open or close circuit in reality.
  <% else %>
  read_timeout: 200
  connect_timeout: 20
  <% end %>
  shards:
    <% node[:ymls][:database][:shards].each do |shard_name, db_config| %>
    <%= shard_name %>:
      <%if ENV['PROXYSQL_MASTER_SHELL_ENABLE'] == "1" && node[:ymls][:database][:shards][shard_name][:proxy_master_enabled] == true%>
      username: <%= db_config[:master_proxy][:username] %>
      password: <%= db_config[:master_proxy][:password] %>
      database: <%= db_config[:database] %>
      host: <%= db_config[:master_proxy][:host] %>
      port: <%= db_config[:master_proxy][:port] %>
      <% else %>
      <% if db_user_group %>
        <% if node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:shards][shard_name] && node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:shards][shard_name][:username] && node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:shards][shard_name][:password] %>
      username: <%= node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:shards][shard_name][:username] %>
      password: <%= node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:shards][shard_name][:password] %>
        <% else %>
      username: <%= node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:default][:username] %>
      password: <%= node[:ymls][:database][:user_groups]["#{feature_type}_#{job_type}".to_sym][:default][:password] %>
        <% end %>
      <% else %>
      username: <%= node[:ymls][:database][:credentials][:username] %>
      password: <%= node[:ymls][:database][:credentials][:password] %>
      <% end %>
      database: <%= db_config[:database] %>
      host: <%= db_config[:host] %>
      port: 3306
      <% end %>
      not_a_shard: false
      encoding: utf8
      <% if @is_app_layer %>
      semian:
        enable: true
        success_threshold: 3
        error_threshold: 3
        error_timeout: 15
        bulkhead: false
        dryrun: false
      <% end %>
      slave:
      <% if @is_resque_layer || @is_sidekiq_layer || node[:opsworks][:instance][:hostname].include?("utility") || node[:opsworks][:instance][:hostname].include?("freshops") %>
        <% if node[:opsworks][:environment] == "production" %>
        host: <%= db_config[:slave2_host] %>
        <% else %>
        host: <%= db_config[:slave2][:host] %>
        username: <%= db_config[:slave2][:username] %>
        password: <%= db_config[:slave2][:password] %>
        port: <%= db_config[:slave2][:port] %>
        <% end %>
      <% else %>
        <% if node[:opsworks][:environment] == "production" %>
        <% if ENV['PROXYSQL_SHELL_ENABLE'] == "1" && node[:ymls][:database][:shards][shard_name][:proxy_enabled] == true %>
        host: <%= db_config[:slave_proxy][:host] %>
        username: <%= db_config[:slave_proxy][:username] %>
        password: <%= db_config[:slave_proxy][:password] %>
        port: <%= db_config[:slave_proxy][:port] %>
        <% else %>
        host: <%= db_config[:slave1_host] %>
        <% end %>
        <% else %>
        <% if ENV['PROXYSQL_SHELL_ENABLE'] == "1" && node[:ymls][:database][:shards][shard_name][:proxy_enabled] == true %>
        host: <%= db_config[:slave_proxy][:host] %>
        username: <%= db_config[:slave_proxy][:username] %>
        password: <%= db_config[:slave_proxy][:password] %>
        port: <%= db_config[:slave_proxy][:port] %>
        <% else %>
        host: <%= db_config[:slave1][:host] %>
        username: <%= db_config[:slave1][:username] %>
        password: <%= db_config[:slave1][:password] %>
        port: <%= db_config[:slave1][:port] %>
        <% end %>
        <% end %>
        semian:
          enable: true
          success_threshold: 3
          error_threshold: 3
          error_timeout: 15
          bulkhead: false
          dryrun: false
      <% end %>
    <% end %>
